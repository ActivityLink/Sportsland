<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>會員個人檔案管理</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Noto Sans TC", sans-serif; background:#F7F9FB; }
    label { font-size:12px; font-weight:700; color:#64748B; }
    input, select {
      width:100%; padding:14px; border-radius:12px;
      border:1.5px solid #E2E8F0; background:#F8F9FA;
      margin-bottom:18px;
    }
    .btn-main {
      background:#06C755; color:#fff;
      width:100%; padding:18px;
      border-radius:16px; font-weight:900;
    }
  </style>
</head>

<body class="flex justify-center">

<div class="w-full max-w-[640px] bg-white min-h-screen p-6">

  <h2 class="text-xl font-black mb-6">會員個人檔案管理</h2>

  <form id="reg-form">

    <!-- 基本資料 -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label>真實姓名</label>
        <input id="m-name" placeholder="王大同">
      </div>
      <div>
        <label>性別</label>
        <select id="m-gender">
          <option value="">未填</option>
          <option value="男">男</option>
          <option value="女">女</option>
        </select>
      </div>
    </div>

    <label>聯絡電話</label>
    <input id="m-phone" placeholder="0912345678">

    <label>出生日期</label>
    <input type="date" id="m-birth" onchange="showGrade()">

    <div class="text-xs text-blue-500 mb-4" id="gradeText"></div>

    <label>就讀學校</label>
    <input id="m-school" placeholder="中山國小 / 可不填">

    <!-- 機關資料 -->
    <hr class="my-6">
    <label>機關名稱</label>
    <input id="o-name" placeholder="公司 / 單位">

    <label>統一編號</label>
    <input id="o-tax" placeholder="8 碼統編">

    <!-- 家人資料 -->
    <hr class="my-6">
    <div class="flex justify-between items-center mb-4">
      <span class="font-bold">學員 / 家人名單</span>
      <button type="button" onclick="addFamily()" class="text-sm bg-blue-500 text-white px-4 py-2 rounded-full">＋新增</button>
    </div>

    <div id="family-list"></div>

    <button class="btn-main mt-8">儲存並同步資料</button>

  </form>
</div>

<script>
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = '2008786875-F7ifLsbN';
let lineUser = {};

const v0 = v => v && v.trim() !== '' ? v.trim() : '0';

function getTaiwanGrade(b) {
  if (!b) return '0';
  const y = new Date(b).getFullYear() + 6;
  const ay = new Date().getFullYear();
  const g = ay - y + 1;
  if (g <= 0) return '學齡前';
  if (g <= 6) return `國小${g}`;
  if (g <= 9) return `國中${g-6}`;
  if (g <= 12) return `高中${g-9}`;
  return '社會人士';
}

function showGrade() {
  document.getElementById('gradeText').innerText =
    '系統判定年級：' + getTaiwanGrade(mBirth.value);
}

function addFamily() {
  const d = document.createElement('div');
  d.className = "border rounded-xl p-4 mb-4";
  d.innerHTML = `
    <label>姓名</label><input class="f-name">
    <label>性別</label>
    <select class="f-gender">
      <option value="">未填</option><option>男</option><option>女</option>
    </select>
    <label>生日</label><input type="date" class="f-birth">
    <label>學校</label><input class="f-school">
    <button type="button" onclick="this.parentElement.remove()" class="text-xs text-red-400 mt-2">刪除</button>
  `;
  document.getElementById('family-list').appendChild(d);
}

document.getElementById('reg-form').onsubmit = async e => {
  e.preventDefault();

  const families = [...document.querySelectorAll('#family-list > div')].map(c => ({
    姓名: v0(c.querySelector('.f-name').value),
    性別: v0(c.querySelector('.f-gender').value),
    出生日期: v0(c.querySelector('.f-birth').value),
    就讀學校: v0(c.querySelector('.f-school').value),
    目前年級: getTaiwanGrade(c.querySelector('.f-birth').value)
  }));

  const payload = {
    type: 'member_register',
    lineUserId: lineUser.userId,
    姓名: v0(mName.value),
    聯絡電話: v0(mPhone.value),
    性別: v0(mGender.value),
    出生日期: v0(mBirth.value),
    就讀學校: v0(mSchool.value),
    目前年級: getTaiwanGrade(mBirth.value),
    機關名稱: v0(oName.value),
    統一編號: v0(oTax.value),
    familyData: families
  };

  await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  alert('✅ 資料已同步');
};

(async()=>{
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  lineUser = await liff.getProfile();
})();
</script>

</body>
</html>
