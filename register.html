<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員中心</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Noto Sans TC", sans-serif; background:#F7F9FB; }
    label { font-size:12px; font-weight:700; color:#64748B; }
    input, select {
      width:100%; padding:14px; border-radius:12px;
      border:1.5px solid #E2E8F0; background:#F8F9FA;
      margin-bottom:18px;
    }
    .btn-main {
      background:#06C755; color:#fff;
      width:100%; padding:18px;
      border-radius:16px; font-weight:900;
    }
    .btn-edit {
      background:#EBF5FF; color:#0066CC;
      padding:10px 24px; border-radius:12px; font-weight:700; font-size:14px;
    }
    /* 載入中遮罩 */
    #loading {
      position: fixed; inset: 0; background: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
    }
    .line-profile-badge {
      display: flex; align-items: center; gap: 10px; background: #FFFFFF;
      padding: 10px 16px; border-radius: 50px; border: 1px solid #E2E8F0;
      margin-bottom: 24px;
    }
  </style>
</head>

<body class="flex justify-center">

<!-- 載入中遮罩 -->
<div id="loading">
  <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
  <p class="font-bold text-gray-400 text-sm">正在核對會員身分...</p>
</div>

<div class="w-full max-w-[640px] bg-white min-h-screen p-6">

  <!-- 1. LINE 登入狀態顯示 -->
  <div id="line-status" class="hidden">
    <div class="line-profile-badge shadow-sm">
      <img id="line-avatar" src="" class="w-8 h-8 rounded-full border border-green-200">
      <div class="flex flex-col">
        <span class="text-[10px] text-gray-400 font-bold leading-none">已透過 LINE 登入</span>
        <span id="line-name" class="text-xs font-black text-gray-700">載入中...</span>
      </div>
      <div class="ml-auto flex items-center gap-1 text-[10px] text-green-500 font-bold">
        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
        連線中
      </div>
    </div>
  </div>

  <!-- 狀態 A：已註冊過 -->
  <div id="view-exists" class="hidden">
    <h2 class="text-xl font-black mb-2">您好，歡迎回來</h2>
    <p class="text-gray-400 text-sm mb-10 font-bold">您已完成中心會員註冊，可點擊編輯更新資料</p>

    <div class="flex items-center justify-between p-6 bg-gray-50 rounded-2xl border border-gray-100 mb-8">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center shadow-md shadow-green-100">
          <i class="fas fa-id-card text-xl"></i>
        </div>
        <div>
          <div class="text-xs text-gray-400 font-bold">中心註冊姓名</div>
          <div id="summary-name" class="font-black text-gray-800 text-lg">---</div>
        </div>
      </div>
      <button onclick="showEditForm()" class="btn-edit active:scale-95 transition-transform">編輯資料</button>
    </div>
  </div>

  <!-- 狀態 B：未註冊或編輯中 -->
  <div id="view-form" class="hidden">
    <div class="flex items-center gap-3 mb-6">
      <h2 id="form-title" class="text-xl font-black">會員個人檔案管理</h2>
    </div>

    <form id="reg-form">
      <label>姓名</label>
      <input id="m-name" placeholder="請輸入真實姓名" required>

      <label>聯絡電話</label>
      <input id="m-phone" placeholder="0912345678" required>

      <label>性別</label>
      <select id="m-gender">
        <option value="">請選擇</option>
        <option value="男">男</option>
        <option value="女">女</option>
      </select>

      <label>出生日期</label>
      <input type="date" id="m-birth">

      <label>就讀學校 (非學生請填 0)</label>
      <input id="m-school" placeholder="範例：中山國小">

      <hr class="my-6">

      <label>機關名稱 (無則填 0)</label>
      <input id="o-name">

      <label>統一編號 (無則填 0)</label>
      <input id="o-tax">

      <button type="submit" class="btn-main mt-8" id="submit-btn">確認儲存</button>
      <button type="button" id="cancel-btn" onclick="checkStatus()" class="w-full text-gray-400 text-sm font-bold mt-4 hidden">取消返回</button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
/* ========= 基本設定 ========= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = '2008786875-F7ifLsbN';
let lineUser = {};

/* ========= 工具 ========= */
function v0(v) {
  return v && v.toString().trim() !== '' ? v.toString().trim() : '0';
}
function f0(v) {
  return (v === '0' || !v) ? '' : v;
}

function getTaiwanGrade(birth) {
  if (!birth) return '0';
  const b = new Date(birth);
  const entry = b.getFullYear() + 6;
  const now = new Date();
  const ay = now.getFullYear();
  const g = ay - entry + 1;
  if (g <= 0) return '學齡前';
  if (g <= 6) return `國小${g}`;
  if (g <= 9) return `國中${g-6}`;
  if (g <= 12) return `高中${g-9}`;
  return '社會人士';
}

/* ========= 介面控制 ========= */
function showEditForm() {
  document.getElementById('view-exists').classList.add('hidden');
  document.getElementById('view-form').classList.remove('hidden');
  document.getElementById('form-title').innerText = "編輯您的會員資料";
  document.getElementById('cancel-btn').classList.remove('hidden');
}

/* ========= 會員狀態檢查 ========= */
async function checkStatus() {
  document.getElementById('loading').style.display = 'flex';
  try {
    const res = await fetch(`${API_URL}?type=member_check&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`);
    const raw = await res.json();

    // ✅ Worker 統一包裝：raw.status = ok；真結果在 raw.data
    const result = raw && raw.data ? raw.data : {};

    if (result.status === "exists") {
      const u = result.data || {};
      document.getElementById('summary-name').innerText = f0(u.name);

      // 預填表單
      document.getElementById('m-name').value = f0(u.name);
      document.getElementById('m-phone').value = f0(u.phone);
      document.getElementById('m-gender').value = f0(u.gender);
      document.getElementById('m-school').value = f0(u.school);
      document.getElementById('o-name').value = f0(u.orgName);
      document.getElementById('o-tax').value = f0(u.taxId);
      if (u.birthDate) document.getElementById('m-birth').value = String(u.birthDate).split('T')[0];

      document.getElementById('view-exists').classList.remove('hidden');
      document.getElementById('view-form').classList.add('hidden');
    } else {
      document.getElementById('view-exists').classList.add('hidden');
      document.getElementById('view-form').classList.remove('hidden');
      document.getElementById('form-title').innerText = "歡迎首次註冊中心會員";
      document.getElementById('cancel-btn').classList.add('hidden');
    }
  } catch (e) {
    console.error(e);
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

/* ========= 送出資料 ========= */
document.getElementById('reg-form').addEventListener('submit', async function (e) {
  e.preventDefault();
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerText = '正在處理同步...';

  const payload = {
    type: 'member_register',
    lineUserId: lineUser.userId || '0',
    姓名: v0(document.getElementById('m-name').value),
    聯絡電話: v0(document.getElementById('m-phone').value),
    性別: v0(document.getElementById('m-gender').value),
    出生日期: v0(document.getElementById('m-birth').value),
    就讀學校: v0(document.getElementById('m-school').value),
    目前年級: getTaiwanGrade(document.getElementById('m-birth').value),
    機關名稱: v0(document.getElementById('o-name').value),
    統一編號: v0(document.getElementById('o-tax').value)
  };

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    await res.json();
    alert('✅ 會員資料已同步成功');
    checkStatus();
  } catch (err) {
    alert('❌ 送出失敗');
  } finally {
    btn.disabled = false;
    btn.innerText = '確認儲存';
  }
});

/* ========= 初始化（登入後回本頁，不回首頁） ========= */
(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      const cleanUrl = location.origin + location.pathname + location.search;
      liff.login({ redirectUri: cleanUrl });
      return;
    }

    lineUser = await liff.getProfile();

    document.getElementById('line-avatar').src =
      lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
    document.getElementById('line-name').innerText = lineUser.displayName;
    document.getElementById('line-status').classList.remove('hidden');

    checkStatus();
  } catch (err) {
    console.error("LIFF Init Error:", err);
  }
})();
</script>

</body>
</html>
