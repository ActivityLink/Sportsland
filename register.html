<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœƒå“¡è¨»å†Š</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Noto Sans TC", sans-serif; background:#F7F9FB; }
    label { font-size:12px; font-weight:700; color:#64748B; }
    input, select {
      width:100%; padding:14px; border-radius:12px;
      border:1.5px solid #E2E8F0; background:#F8F9FA;
      margin-bottom:18px;
    }
    .btn-main {
      background:#06C755; color:#fff;
      width:100%; padding:18px;
      border-radius:16px; font-weight:900;
    }
  </style>
</head>

<body class="flex justify-center">

<div class="w-full max-w-[640px] bg-white min-h-screen p-6">

  <h2 class="text-xl font-black mb-6">æœƒå“¡å€‹äººæª”æ¡ˆç®¡ç†</h2>

  <form id="reg-form">

    <label>å§“å</label>
    <input id="m-name">

    <label>è¯çµ¡é›»è©±</label>
    <input id="m-phone">

    <label>æ€§åˆ¥</label>
    <select id="m-gender">
      <option value="">æœªå¡«</option>
      <option value="ç”·">ç”·</option>
      <option value="å¥³">å¥³</option>
    </select>

    <label>å‡ºç”Ÿæ—¥æœŸ</label>
    <input type="date" id="m-birth">

    <label>å°±è®€å­¸æ ¡</label>
    <input id="m-school">

    <hr class="my-6">

    <label>æ©Ÿé—œåç¨±</label>
    <input id="o-name">

    <label>çµ±ä¸€ç·¨è™Ÿ</label>
    <input id="o-tax">

    <button class="btn-main mt-8">å„²å­˜</button>

  </form>
</div>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = '2008786875-F7ifLsbN';
let lineUser = {};

/* ========= å·¥å…· ========= */
function v0(v) {
  return v && v.toString().trim() !== '' ? v.toString().trim() : '0';
}

function getTaiwanGrade(birth) {
  if (!birth) return '0';
  const b = new Date(birth);
  let entry = b.getFullYear() + 6;
  const now = new Date();
  const ay = now.getFullYear();
  const g = ay - entry + 1;
  if (g <= 0) return 'å­¸é½¡å‰';
  if (g <= 6) return `åœ‹å°${g}`;
  if (g <= 9) return `åœ‹ä¸­${g-6}`;
  if (g <= 12) return `é«˜ä¸­${g-9}`;
  return 'ç¤¾æœƒäººå£«';
}

/* ========= é€å‡º ========= */
document.getElementById('reg-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  /* ğŸ”‘ å…¨éƒ¨å…ˆæŠ“æˆå€åŸŸè®Šæ•¸ï¼ˆé€™ä¸€æ­¥æœ€é‡è¦ï¼‰ */
  const name   = document.getElementById('m-name').value;
  const phone  = document.getElementById('m-phone').value;
  const gender = document.getElementById('m-gender').value;
  const birth  = document.getElementById('m-birth').value;
  const school = document.getElementById('m-school').value;
  const org    = document.getElementById('o-name').value;
  const tax    = document.getElementById('o-tax').value;

  const payload = {
    type: 'member_register',
    lineUserId: lineUser.userId || '0',

    å§“å: v0(name),
    è¯çµ¡é›»è©±: v0(phone),
    æ€§åˆ¥: v0(gender),
    å‡ºç”Ÿæ—¥æœŸ: v0(birth),
    å°±è®€å­¸æ ¡: v0(school),
    ç›®å‰å¹´ç´š: getTaiwanGrade(birth),
    æ©Ÿé—œåç¨±: v0(org),
    çµ±ä¸€ç·¨è™Ÿ: v0(tax)
  };

  console.log('payload', payload);

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    console.log(result);
    alert('âœ… å·²é€å‡º');

  } catch (err) {
    console.error(err);
    alert('âŒ é€å‡ºå¤±æ•—');
  }
});

/* ========= LIFF ========= */
(async () => {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }
  lineUser = await liff.getProfile();
})();
</script>

</body>
</html>
