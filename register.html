document.getElementById('reg-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> 資料同步中...`;

    // 建立家人資料（學員名單）
    const familyData = Array.from(document.querySelectorAll('.family-card')).map(card => {
        const name = card.querySelector('.f-name').value;
        const gender = card.querySelector('.f-gender').value;
        const birth = card.querySelector('.f-birth').value;
        const school = card.querySelector('.f-school').value;
        
        // 根據生日計算年級
        const grade = getTaiwanGrade(birth);
        
        return {
            姓名: name,
            性別: gender,
            出生日期: birth,
            就讀學校: school,
            目前年級: grade
        };
    });

    // 主要會員資料
    const mainData = {
        會員ID: `M-${Date.now()}`, // 或根據您的規則生成
        LINE_UID: lineUser.userId,
        註冊身分: identityType,
        姓名: document.getElementById('m-name').value,
        聯絡電話: document.getElementById('m-phone').value,
        性別: document.getElementById('m-gender').value,
        出生日期: document.getElementById('m-birth').value,
        就讀學校: document.getElementById('m-school').value,
        目前年級: getTaiwanGrade(document.getElementById('m-birth').value)
    };

    // 如果是機關/團體，添加相關欄位
    if (identityType === 'Organization') {
        mainData.機關名稱 = document.getElementById('o-name').value;
        mainData.統一編號 = document.getElementById('o-tax').value;
    }

    // 如果是家長，添加家人資料
    if (identityType === 'Parent' && familyData.length > 0) {
        // 這裡可以將家人資料合併到主要資料中或單獨處理
        mainData.家人資料 = familyData;
    }

    // 建立完整的 payload
    const payload = {
        type: 'member_register',
        lineUserId: lineUser.userId,
        identityType: identityType,
        // 主要資料
        會員ID: mainData.會員ID,
        LINE_UID: mainData.LINE_UID,
        "註冊身分": mainData.註冊身分,
        姓名: mainData.姓名,
        聯絡電話: mainData.聯絡電話,
        性別: mainData.性別,
        出生日期: mainData.出生日期,
        就讀學校: mainData.就讀學校,
        目前年級: mainData.目前年級,
        // 機關相關
        機關名稱: mainData.機關名稱 || '',
        統一編號: mainData.統一編號 || '',
        // 家人/學員資料
        familyData: familyData,
        // 系統欄位
        建立時間: new Date().toISOString(),
        更新時間: new Date().toISOString()
    };

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await res.json();
        if(result.status === "success") {
            alert("✅ 會員資料同步成功！");
            navigateTo('index.html');
        } else {
            alert("❌ 儲存失敗：" + (result.message || JSON.stringify(result)));
            btn.disabled = false;
            btn.innerText = "重新儲存";
        }
    } catch(err) {
        console.error("API 錯誤:", err);
        alert("連線超時，請檢查網路後再試");
        btn.disabled = false;
        btn.innerText = "重新儲存";
    }
};
