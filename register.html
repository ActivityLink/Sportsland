<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports-Island - 會員中心</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        :root { --line-green: #06C755; --bg-gray: #F7F9FB; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-gray); margin: 0; display: flex; justify-content: center; -webkit-font-smoothing: antialiased; }
        .page-wrapper { width: 100%; max-width: 640px; background: #FFFFFF; min-height: 100vh; padding: 40px 24px; box-shadow: 0 0 20px rgba(0,0,0,0.03); }
        .id-option { border: 2px solid #EBEBEB; border-radius: 16px; padding: 20px; margin-bottom: 12px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 16px; }
        .id-option.active { border-color: var(--line-green); background: #F0FAF3; }
        .check-dot { width: 20px; height: 20px; border: 2px solid #DDD; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .active .check-dot { border-color: var(--line-green); background: var(--line-green); color: white; font-size: 10px; }
        label { display: block; font-size: 13px; font-weight: 800; color: #64748B; margin-bottom: 6px; text-transform: uppercase; }
        input, select { width: 100%; background: #F8F9FA; border: 1.5px solid #E2E8F0; border-radius: 12px; padding: 14px; font-size: 16px; margin-bottom: 18px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--line-green); background: white; }
        .btn-main { background-color: var(--line-green); color: white; width: 100%; padding: 18px; border-radius: 16px; font-weight: 900; font-size: 17px; box-shadow: 0 10px 15px -3px rgba(6, 199, 85, 0.2); transition: 0.2s; border:none; cursor: pointer; }
        .btn-main:active { transform: scale(0.98); }
        .family-card { background: #FCFDFF; padding: 20px; border-radius: 20px; border: 1.5px solid #E9EFF5; margin-bottom: 16px; position: relative; }
        .grade-badge { background: #EBF5FF; color: #0066CC; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; display: inline-block; margin-bottom: 15px; }
        .remove-btn { color: #CBD5E1; transition: 0.2s; background: none; border: none; cursor: pointer; }
        .remove-btn:hover { color: #EF4444; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .summary-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .summary-avatar { width: 36px; height: 36px; background: #F1F5F9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #94A3B8; }
        .gender-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
        .gender-male { background: #E0F2FE; color: #0284C7; }
        .gender-female { background: #FCE7F3; color: #DB2777; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#06C755] mb-4"></div>
        <p class="text-gray-400 text-sm font-bold">同步您的個人與家人資料...</p>
    </div>

    <div class="page-wrapper">
        <!-- 步驟 01：選擇身分 -->
        <div id="step-1" class="hidden">
            <h2 class="text-2xl font-black text-gray-800 mb-2">歡迎來到中心</h2>
            <p class="text-gray-400 text-sm mb-10 font-bold">請選擇您的帳戶類型開始註冊</p>
            
            <div onclick="selectId('個人')" id="id-個人" class="id-option">
                <div class="check-dot"><i class="fas fa-check"></i></div>
                <div class="flex-1"><div class="font-black text-gray-800">個人會員</div><div class="text-[11px] text-gray-400 font-bold">一般社會大眾、學生</div></div>
            </div>
            
            <div onclick="selectId('家長')" id="id-家長" class="id-option">
                <div class="check-dot"><i class="fas fa-check"></i></div>
                <div class="flex-1"><div class="font-black text-gray-800">家長會員</div><div class="text-[11px] text-gray-400 font-bold">管理孩子名單並代為報名</div></div>
            </div>

            <div onclick="selectId('機關')" id="id-機關" class="id-option">
                <div class="check-dot"><i class="fas fa-check"></i></div>
                <div class="flex-1"><div class="font-black text-gray-800">機關/團體</div><div class="text-[11px] text-gray-400 font-bold">單位報名、公文核銷需求者</div></div>
            </div>
            
            <button onclick="goStep(2)" id="next-btn" class="btn-main mt-10 opacity-50" disabled>繼續下一步</button>
        </div>

        <!-- 步驟 02：填寫資料 -->
        <div id="step-2" class="hidden">
            <div class="flex items-center gap-3 mb-8">
                <button onclick="goStep(1)" class="text-gray-300 hover:text-gray-600"><i class="fas fa-arrow-left text-lg"></i></button>
                <h2 class="text-xl font-black text-gray-800">會員個人檔案管理</h2>
            </div>
            
            <form id="reg-form">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label>真實姓名 *</label>
                        <input type="text" id="m-name" placeholder="王大同" required>
                    </div>
                    <div>
                        <label>性別 *</label>
                        <select id="m-gender" required>
                            <option value="">請選擇</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </div>
                
                <label>聯絡電話 *</label>
                <input type="tel" id="m-phone" placeholder="0912345678" required>
                
                <label>出生日期 *</label>
                <input type="date" id="m-birth" required onchange="updateMainGrade()">
                
                <div id="m-school-container">
                    <label>就讀學校</label>
                    <input type="text" id="m-school" placeholder="範例：中山國小">
                </div>
                <div id="main-grade-badge" class="hidden"><span class="grade-badge" id="m-grade-text"></span></div>

                <!-- 機關欄位 -->
                <div id="org-fields" class="hidden bg-gray-50 p-4 rounded-2xl mb-6">
                    <label>機關名稱 *</label>
                    <input type="text" id="o-name" placeholder="範例：光火體育有限公司">
                    <label>統一編號</label>
                    <input type="text" id="o-tax" placeholder="12345678">
                </div>
                
                <!-- 家長/學員管理 -->
                <div id="parent-extra" class="hidden border-t pt-10 mt-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <span class="font-black text-gray-800 block">學員/家人名單</span>
                            <span class="text-[10px] text-gray-400 font-bold">非學生身分將自動跳過學校填寫</span>
                        </div>
                        <button type="button" onclick="addFamilyRow()" class="text-xs bg-blue-500 text-white px-4 py-2 rounded-full font-black shadow-lg shadow-blue-100 active:scale-95 transition-transform">+ 新增學員</button>
                    </div>
                    <div id="family-list"></div>
                </div>
                
                <button type="submit" id="submit-btn" class="btn-main mt-12">儲存並同步資料</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
        const LIFF_ID = '2008786875-F7ifLsbN';
        let lineUser = {}, identityType = '';

        function navigateTo(page) {
            const base = window.location.href.split('?')[0].split('#')[0];
            const dir = base.substring(0, base.lastIndexOf('/') + 1);
            window.location.href = dir + page;
        }

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    lineUser = profile;
                    
                    const res = await fetch(`${API_URL}?type=member_check&lineUserId=${profile.userId}&_t=${Date.now()}`);
                    const result = await res.json();
                    
                    if (result.status === "exists") {
                        const u = result.data;
                        identityType = u["註冊身分"] || u.identityType || '個人';
                        
                        document.getElementById('m-name').value = u["姓名"] || u.name || '';
                        document.getElementById('m-phone').value = u["聯絡電話"] || u.phone || '';
                        document.getElementById('m-gender').value = u["性別"] || u.gender || '';
                        document.getElementById('m-school').value = u["就讀學校"] || u.school || '';
                        if(u["出生日期"] || u.birthDate) {
                            const birthDate = u["出生日期"] || u.birthDate;
                            document.getElementById('m-birth').value = birthDate.includes('T') ? birthDate.split('T')[0] : birthDate;
                        }
                        
                        if(identityType === '機關') {
                            document.getElementById('o-name').value = u["機關名稱"] || u.orgName || '';
                            document.getElementById('o-tax').value = u["統一編號"] || u.taxId || '';
                        }

                        if (identityType === '家長' && result.families) {
                            result.families.forEach(f => {
                                addFamilyRow({
                                    name: f["姓名"] || f.name,
                                    gender: f["性別"] || f.gender,
                                    birth: f["出生日期"] || f.birth,
                                    school: f["就讀學校"] || f.school
                                });
                            });
                        }
                        selectId(identityType);
                        goStep(2);
                    } else {
                        document.getElementById('step-1').classList.remove('hidden');
                    }
                }
            } catch (e) { console.error(e); } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function selectId(id) {
            identityType = id;
            document.querySelectorAll('.id-option').forEach(el => el.classList.remove('active'));
            document.getElementById('id-'+id).classList.add('active');
            const btn = document.getElementById('next-btn');
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        }

        function goStep(n) {
            document.getElementById('step-1').classList.toggle('hidden', n !== 1);
            document.getElementById('step-2').classList.toggle('hidden', n !== 2);
            if(n === 2) {
                document.getElementById('org-fields').classList.toggle('hidden', identityType !== '機關');
                document.getElementById('parent-extra').classList.toggle('hidden', identityType !== '家長');
                updateMainGrade();
            }
        }

        function getTaiwanGrade(birth) {
            if (!birth) return "社會人士";
            const b = new Date(birth);
            let entryYear = b.getFullYear() + 6;
            if (b.getMonth() + 1 > 9 || (b.getMonth() + 1 === 9 && b.getDate() >= 2)) entryYear++;
            const ay = (new Date().getMonth() + 1 >= 9) ? new Date().getFullYear() : new Date().getFullYear() - 1;
            const g = ay - entryYear + 1;
            if (g <= 0) return "學齡前";
            if (g <= 6) return `國小 ${g} 年級`;
            if (g <= 9) return `國中 ${g-6} 年級`;
            if (g <= 12) return `高中 ${g-9} 年級`;
            return "社會人士";
        }

        function updateMainGrade() {
            const b = document.getElementById('m-birth').value;
            if(!b) return;
            
            const grade = getTaiwanGrade(b);
            const schoolContainer = document.getElementById('m-school-container');
            const gradeBadge = document.getElementById('main-grade-badge');
            
            gradeBadge.classList.remove('hidden');
            document.getElementById('m-grade-text').innerText = "系統判定身分：" + grade;
            
            // 跳過邏輯：如果不是學生，或是身分為家長/機關，隱藏學校
            if(grade === "社會人士" || identityType === '家長' || identityType === '機關') {
                schoolContainer.classList.add('hidden');
                document.getElementById('m-school').value = "";
            } else {
                schoolContainer.classList.remove('hidden');
            }
        }

        function toggleFamilyEdit(btn) {
            const card = btn.closest('.family-card');
            const summary = card.querySelector('.family-summary');
            const detail = card.querySelector('.family-detail');
            const isHiding = !detail.classList.contains('hidden');
            detail.classList.toggle('hidden', isHiding);
            summary.classList.toggle('hidden', !isHiding);
            btn.innerText = isHiding ? "編輯" : "收合";
        }

        function updateSummaryInfo(card) {
            const name = card.querySelector('.f-name').value || '未填寫';
            const gender = card.querySelector('.f-gender').value;
            const birth = card.querySelector('.f-birth').value;
            const grade = getTaiwanGrade(birth);

            card.querySelector('.f-sum-name').innerText = name;
            card.querySelector('.f-sum-grade').innerText = grade;
            
            const genderContainer = card.querySelector('.f-sum-gender');
            genderContainer.innerHTML = gender ? `<span class="gender-tag ${gender==='男'?'gender-male':'gender-female'}">${gender}</span>` : '';
        }

        function addFamilyRow(data = null) {
            const container = document.getElementById('family-list');
            const div = document.createElement('div');
            div.className = 'family-card';
            const isExisting = !!data;
            const birthVal = data ? (data.birth.includes('T') ? data.birth.split('T')[0] : data.birth) : '';
            const initialGrade = data ? getTaiwanGrade(data.birth) : '社會人士';

            div.innerHTML = `
                <div class="family-summary ${isExisting ? 'summary-row' : 'hidden'}">
                    <div class="flex items-center gap-3">
                        <div class="summary-avatar"><i class="fas fa-user"></i></div>
                        <div>
                            <div class="flex items-center">
                                <span class="font-bold text-gray-800 f-sum-name">${data ? data.name : ''}</span>
                                <span class="f-sum-gender">
                                    ${data?.gender ? `<span class="gender-tag ${data.gender==='男'?'gender-male':'gender-female'}">${data.gender}</span>` : ''}
                                </span>
                            </div>
                            <div class="text-[10px] text-gray-400 font-bold f-sum-grade">${initialGrade}</div>
                        </div>
                    </div>
                    <button type="button" onclick="toggleFamilyEdit(this)" class="text-blue-500 text-sm font-black px-3 py-1 bg-blue-50 rounded-lg">編輯</button>
                </div>
                <div class="family-detail ${isExisting ? 'hidden mt-6 pt-4 border-t border-dashed' : ''}">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-black text-gray-400 uppercase">學員資訊</span>
                        <button type="button" onclick="this.closest('.family-card').remove()" class="remove-btn text-xs"><i class="fas fa-trash-alt mr-1"></i> 刪除</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label>學員姓名 *</label>
                            <input type="text" class="f-name" value="${data ? data.name : ''}" required oninput="updateSummaryInfo(this.closest('.family-card'))">
                        </div>
                        <div>
                            <label>性別 *</label>
                            <select class="f-gender" required onchange="updateSummaryInfo(this.closest('.family-card'))">
                                <option value="">請選擇</option>
                                <option value="男" ${data && data.gender === '男' ? 'selected' : ''}>男</option>
                                <option value="女" ${data && data.gender === '女' ? 'selected' : ''}>女</option>
                            </select>
                        </div>
                    </div>
                    <label>學員生日 *</label>
                    <input type="date" class="f-birth" value="${birthVal}" required onchange="handleFamilyBirthChange(this)">
                    
                    <div class="f-school-container ${initialGrade === '社會人士' ? 'hidden' : ''}">
                        <label>就讀學校</label>
                        <input type="text" class="f-school" value="${data ? data.school : ''}" placeholder="範例：中山國小">
                    </div>
                    
                    ${isExisting ? `<button type="button" onclick="toggleFamilyEdit(this)" class="w-full py-2 bg-gray-50 text-gray-400 text-xs font-bold rounded-xl mt-2">完成收合</button>` : ''}
                </div>
            `;
            container.appendChild(div);
        }

        function handleFamilyBirthChange(input) {
            const card = input.closest('.family-card');
            const grade = getTaiwanGrade(input.value);
            const schoolContainer = card.querySelector('.f-school-container');
            const schoolInput = card.querySelector('.f-school');
            
            if(grade === "社會人士") {
                schoolContainer.classList.add('hidden');
                schoolInput.value = "";
            } else {
                schoolContainer.classList.remove('hidden');
            }
            updateSummaryInfo(card);
        }

        document.getElementById('reg-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> 資料同步中...`;

            // 建立家人資料（學員名單）
            const familyData = Array.from(document.querySelectorAll('.family-card')).map(card => {
                const name = card.querySelector('.f-name').value;
                const gender = card.querySelector('.f-gender').value;
                const birth = card.querySelector('.f-birth').value;
                const school = card.querySelector('.f-school').value;
                
                // 根據生日計算年級
                const grade = getTaiwanGrade(birth);
                
                return {
                    姓名: name,
                    性別: gender,
                    出生日期: birth,
                    就讀學校: school,
                    目前年級: grade
                };
            });

            // 建立完整的 payload
            const payload = {
                type: 'member_register',
                lineUserId: lineUser.userId,
                identityType: identityType,
                // 會員基本資料 - 對應資料庫欄位
                會員ID: `M-${Date.now()}`,
                LINE_UID: lineUser.userId,
                "註冊身分": identityType,
                姓名: document.getElementById('m-name').value,
                聯絡電話: document.getElementById('m-phone').value,
                性別: document.getElementById('m-gender').value,
                出生日期: document.getElementById('m-birth').value,
                就讀學校: document.getElementById('m-school').value,
                目前年級: getTaiwanGrade(document.getElementById('m-birth').value),
                // 機關相關
                機關名稱: identityType === '機關' ? document.getElementById('o-name').value : '',
                統一編號: identityType === '機關' ? document.getElementById('o-tax').value : '',
                // 家人/學員資料
                familyData: familyData,
                // 系統欄位
                建立時間: new Date().toISOString(),
                更新時間: new Date().toISOString()
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(result.status === "success") {
                    alert("✅ 會員資料同步成功！");
                    navigateTo('index.html');
                } else {
                    alert("❌ 儲存失敗：" + (result.message || JSON.stringify(result)));
                    btn.disabled = false;
                    btn.innerText = "重新儲存";
                }
            } catch(err) {
                console.error("API 錯誤:", err);
                alert("連線超時，請檢查網路後再試");
                btn.disabled = false;
                btn.innerText = "重新儲存";
            }
        };

        window.onload = init;
    </script>
</body>
</html>
