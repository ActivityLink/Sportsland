<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœƒå“¡ä¸­å¿ƒ</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Noto Sans TC", sans-serif; background:#F7F9FB; }
    label { font-size:12px; font-weight:700; color:#64748B; }
    input, select {
      width:100%; padding:14px; border-radius:12px;
      border:1.5px solid #E2E8F0; background:#F8F9FA;
      margin-bottom:18px;
    }
    .btn-main {
      background:#06C755; color:#fff;
      width:100%; padding:18px;
      border-radius:16px; font-weight:900;
    }
    .btn-edit {
      background:#EBF5FF; color:#0066CC;
      padding:10px 24px; border-radius:12px; font-weight:700; font-size:14px;
    }
    /* è¼‰å…¥ä¸­é®ç½© */
    #loading {
      position: fixed; inset: 0; background: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
    }
    .line-profile-badge {
      display: flex; align-items: center; gap: 10px; background: #FFFFFF;
      padding: 10px 16px; border-radius: 50px; border: 1px solid #E2E8F0;
      margin-bottom: 24px;
    }
  </style>
</head>

<body class="flex justify-center">

<!-- è¼‰å…¥ä¸­é®ç½© -->
<div id="loading">
  <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
  <p class="font-bold text-gray-400 text-sm">æ­£åœ¨æ ¸å°æœƒå“¡èº«åˆ†...</p>
</div>

<div class="w-full max-w-[640px] bg-white min-h-screen p-6">

  <!-- 1. LINE ç™»å…¥ç‹€æ…‹é¡¯ç¤º (ä¸è«–è¨»å†Šèˆ‡å¦éƒ½æœƒé¡¯ç¤º) -->
  <div id="line-status" class="hidden">
    <div class="line-profile-badge shadow-sm">
      <img id="line-avatar" src="" class="w-8 h-8 rounded-full border border-green-200">
      <div class="flex flex-col">
        <span class="text-[10px] text-gray-400 font-bold leading-none">å·²é€é LINE ç™»å…¥</span>
        <span id="line-name" class="text-xs font-black text-gray-700">è¼‰å…¥ä¸­...</span>
      </div>
      <div class="ml-auto flex items-center gap-1 text-[10px] text-green-500 font-bold">
        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
        é€£ç·šä¸­
      </div>
    </div>
  </div>

  <!-- ç‹€æ…‹ Aï¼šå·²è¨»å†Šéï¼ˆç²¾ç°¡é¡¯ç¤ºï¼‰ -->
  <div id="view-exists" class="hidden">
    <h2 class="text-xl font-black mb-2">æ‚¨å¥½ï¼Œæ­¡è¿å›ä¾†</h2>
    <p class="text-gray-400 text-sm mb-10 font-bold">æ‚¨å·²å®Œæˆä¸­å¿ƒæœƒå“¡è¨»å†Šï¼Œå¯é»æ“Šç·¨è¼¯æ›´æ–°è³‡æ–™</p>
    
    <div class="flex items-center justify-between p-6 bg-gray-50 rounded-2xl border border-gray-100 mb-8">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center shadow-md shadow-green-100">
          <i class="fas fa-id-card text-xl"></i>
        </div>
        <div>
          <div class="text-xs text-gray-400 font-bold">ä¸­å¿ƒè¨»å†Šå§“å</div>
          <div id="summary-name" class="font-black text-gray-800 text-lg">---</div>
        </div>
      </div>
      <button onclick="showEditForm()" class="btn-edit active:scale-95 transition-transform">ç·¨è¼¯è³‡æ–™</button>
    </div>
  </div>

  <!-- ç‹€æ…‹ Bï¼šæœªè¨»å†Šæˆ–ç·¨è¼¯ä¸­ -->
  <div id="view-form" class="hidden">
    <div class="flex items-center gap-3 mb-6">
       <h2 id="form-title" class="text-xl font-black">æœƒå“¡å€‹äººæª”æ¡ˆç®¡ç†</h2>
    </div>

    <form id="reg-form">
      <label>å§“å</label>
      <input id="m-name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>

      <label>è¯çµ¡é›»è©±</label>
      <input id="m-phone" placeholder="0912345678" required>

      <label>æ€§åˆ¥</label>
      <select id="m-gender">
        <option value="">è«‹é¸æ“‡</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
      </select>

      <label>å‡ºç”Ÿæ—¥æœŸ</label>
      <input type="date" id="m-birth">

      <label>å°±è®€å­¸æ ¡ (éå­¸ç”Ÿè«‹å¡« 0)</label>
      <input id="m-school" placeholder="ç¯„ä¾‹ï¼šä¸­å±±åœ‹å°">

      <hr class="my-6">

      <label>æ©Ÿé—œåç¨± (ç„¡å‰‡å¡« 0)</label>
      <input id="o-name">

      <label>çµ±ä¸€ç·¨è™Ÿ (ç„¡å‰‡å¡« 0)</label>
      <input id="o-tax">

      <button type="submit" class="btn-main mt-8" id="submit-btn">ç¢ºèªå„²å­˜</button>
      <button type="button" id="cancel-btn" onclick="checkStatus()" class="w-full text-gray-400 text-sm font-bold mt-4 hidden">å–æ¶ˆè¿”å›</button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = '2008786875-F7ifLsbN';
let lineUser = {};

/* ========= å·¥å…· ========= */
function v0(v) {
  return v && v.toString().trim() !== '' ? v.toString().trim() : '0';
}
function f0(v) {
  return (v === '0' || !v) ? '' : v;
}

function getTaiwanGrade(birth) {
  if (!birth) return '0';
  const b = new Date(birth);
  let entry = b.getFullYear() + 6;
  const now = new Date();
  const ay = now.getFullYear();
  const g = ay - entry + 1;
  if (g <= 0) return 'å­¸é½¡å‰';
  if (g <= 6) return `åœ‹å°${g}`;
  if (g <= 9) return `åœ‹ä¸­${g-6}`;
  if (g <= 12) return `é«˜ä¸­${g-9}`;
  return 'ç¤¾æœƒäººå£«';
}

/* ========= ä»‹é¢æ§åˆ¶ ========= */
function showEditForm() {
  document.getElementById('view-exists').classList.add('hidden');
  document.getElementById('view-form').classList.remove('hidden');
  document.getElementById('form-title').innerText = "ç·¨è¼¯æ‚¨çš„æœƒå“¡è³‡æ–™";
  document.getElementById('cancel-btn').classList.remove('hidden');
}

async function checkStatus() {
  document.getElementById('loading').style.display = 'flex';
  try {
    // å‘¼å« API æª¢æŸ¥è¨»å†Šç‹€æ…‹
    const res = await fetch(`${API_URL}?type=member_check&lineUserId=${lineUser.userId}&_t=${Date.now()}`);
    const result = await res.json();

    if (result.status === "exists") {
      const u = result.data;
      document.getElementById('summary-name').innerText = f0(u.name);
      
      // é å¡«è¡¨å–®
      document.getElementById('m-name').value = f0(u.name);
      document.getElementById('m-phone').value = f0(u.phone);
      document.getElementById('m-gender').value = f0(u.gender);
      document.getElementById('m-school').value = f0(u.school);
      document.getElementById('o-name').value = f0(u.orgName);
      document.getElementById('o-tax').value = f0(u.taxId);
      if(u.birthDate) document.getElementById('m-birth').value = u.birthDate.split('T')[0];

      document.getElementById('view-exists').classList.remove('hidden');
      document.getElementById('view-form').classList.add('hidden');
    } else {
      // æœªè¨»å†Šå‰‡ç›´æ¥é¡¯ç¤ºè¡¨å–®
      document.getElementById('view-exists').classList.add('hidden');
      document.getElementById('view-form').classList.remove('hidden');
      document.getElementById('form-title').innerText = "æ­¡è¿é¦–æ¬¡è¨»å†Šä¸­å¿ƒæœƒå“¡";
      document.getElementById('cancel-btn').classList.add('hidden');
    }
  } catch (e) {
    console.error(e);
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

/* ========= é€å‡ºè³‡æ–™ ========= */
document.getElementById('reg-form').addEventListener('submit', async function (e) {
  e.preventDefault();
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerText = 'æ­£åœ¨è™•ç†åŒæ­¥...';

  const payload = {
    type: 'member_register',
    lineUserId: lineUser.userId || '0',
    å§“å: v0(document.getElementById('m-name').value),
    è¯çµ¡é›»è©±: v0(document.getElementById('m-phone').value),
    æ€§åˆ¥: v0(document.getElementById('m-gender').value),
    å‡ºç”Ÿæ—¥æœŸ: v0(document.getElementById('m-birth').value),
    å°±è®€å­¸æ ¡: v0(document.getElementById('m-school').value),
    ç›®å‰å¹´ç´š: getTaiwanGrade(document.getElementById('m-birth').value),
    æ©Ÿé—œåç¨±: v0(document.getElementById('o-name').value),
    çµ±ä¸€ç·¨è™Ÿ: v0(document.getElementById('o-tax').value)
  };

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    alert('âœ… æœƒå“¡è³‡æ–™å·²åŒæ­¥æˆåŠŸ');
    checkStatus(); 
  } catch (err) {
    alert('âŒ é€å‡ºå¤±æ•—');
  } finally {
    btn.disabled = false;
    btn.innerText = 'ç¢ºèªå„²å­˜';
  }
});

/* ========= åˆå§‹åŒ– ========= */
(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
  liff.login({
    redirectUri: location.href
  });
  return;
}

    lineUser = await liff.getProfile();

    // ğŸ”‘ é¡¯ç¤ºç™»å…¥è€…çš„ LINE è³‡è¨Š (LOGO èˆ‡åç¨±)
    document.getElementById('line-avatar').src = lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
    document.getElementById('line-name').innerText = lineUser.displayName;
    document.getElementById('line-status').classList.remove('hidden');

    checkStatus();
  } catch (err) {
    console.error("LIFF Init Error:", err);
  }
})();
</script>

</body>
</html>
