<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœƒå“¡è¨»å†Š</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: "Noto Sans TC", sans-serif; background:#F7F9FB; }
    label { font-size:12px; font-weight:700; color:#64748B; }
    input, select {
      width:100%; padding:14px; border-radius:12px;
      border:1.5px solid #E2E8F0; background:#F8F9FA;
      margin-bottom:18px;
    }
    .btn-main {
      background:#06C755; color:#fff;
      width:100%; padding:18px;
      border-radius:16px; font-weight:900;
    }
    /* è¼‰å…¥ä¸­é®ç½© */
    #loading {
      position: fixed; inset: 0; background: rgba(255,255,255,0.8);
      display: flex; align-items: center; justify-content: center; z-index: 50;
    }
  </style>
</head>

<body class="flex justify-center">

<div id="loading"><p class="font-bold text-gray-400">è®€å–æœƒå“¡è³‡æ–™ä¸­...</p></div>

<div class="w-full max-w-[640px] bg-white min-h-screen p-6">

  <h2 class="text-xl font-black mb-6">æœƒå“¡å€‹äººæª”æ¡ˆç®¡ç†</h2>

  <form id="reg-form">

    <label>å§“å</label>
    <input id="m-name">

    <label>è¯çµ¡é›»è©±</label>
    <input id="m-phone">

    <label>æ€§åˆ¥</label>
    <select id="m-gender">
      <option value="">æœªå¡«</option>
      <option value="ç”·">ç”·</option>
      <option value="å¥³">å¥³</option>
    </select>

    <label>å‡ºç”Ÿæ—¥æœŸ</label>
    <input type="date" id="m-birth">

    <label>å°±è®€å­¸æ ¡</label>
    <input id="m-school">

    <hr class="my-6">

    <label>æ©Ÿé—œåç¨±</label>
    <input id="o-name">

    <label>çµ±ä¸€ç·¨è™Ÿ</label>
    <input id="o-tax">

    <button class="btn-main mt-8" id="submit-btn">å„²å­˜è®Šæ›´</button>

  </form>
</div>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = '2008786875-F7ifLsbN';
let lineUser = {};

/* ========= å·¥å…·ï¼šè™•ç† 0 æˆ–ç©ºå€¼ ========= */
function v0(v) {
  return v && v.toString().trim() !== '' ? v.toString().trim() : '0';
}
// è®€å–æ™‚ï¼Œå¦‚æœæ˜¯ '0' å‰‡é¡¯ç¤ºç©ºå­—ä¸²
function f0(v) {
  return (v === '0' || !v) ? '' : v;
}

function getTaiwanGrade(birth) {
  if (!birth) return '0';
  const b = new Date(birth);
  let entry = b.getFullYear() + 6;
  const now = new Date();
  const ay = now.getFullYear();
  const g = ay - entry + 1;
  if (g <= 0) return 'å­¸é½¡å‰';
  if (g <= 6) return `åœ‹å°${g}`;
  if (g <= 9) return `åœ‹ä¸­${g-6}`;
  if (g <= 12) return `é«˜ä¸­${g-9}`;
  return 'ç¤¾æœƒäººå£«';
}

/* ========= é€å‡ºè³‡æ–™ ========= */
document.getElementById('reg-form').addEventListener('submit', async function (e) {
  e.preventDefault();
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerText = 'å„²å­˜ä¸­...';

  const payload = {
    type: 'member_register',
    lineUserId: lineUser.userId || '0',
    å§“å: v0(document.getElementById('m-name').value),
    è¯çµ¡é›»è©±: v0(document.getElementById('m-phone').value),
    æ€§åˆ¥: v0(document.getElementById('m-gender').value),
    å‡ºç”Ÿæ—¥æœŸ: v0(document.getElementById('m-birth').value),
    å°±è®€å­¸æ ¡: v0(document.getElementById('m-school').value),
    ç›®å‰å¹´ç´š: getTaiwanGrade(document.getElementById('m-birth').value),
    æ©Ÿé—œåç¨±: v0(document.getElementById('o-name').value),
    çµ±ä¸€ç·¨è™Ÿ: v0(document.getElementById('o-tax').value)
  };

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    alert('âœ… è³‡æ–™å·²æˆåŠŸåŒæ­¥');
  } catch (err) {
    console.error(err);
    alert('âŒ é€å‡ºå¤±æ•—');
  } finally {
    btn.disabled = false;
    btn.innerText = 'å„²å­˜è®Šæ›´';
  }
});

/* ========= LIFF åˆå§‹åŒ–èˆ‡è‡ªå‹•è®€å–è³‡æ–™ ========= */
(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    lineUser = await liff.getProfile();

    // ğŸ”‘ é—œéµï¼šå‘ API è«‹æ±‚ç¾æœ‰è³‡æ–™
    const res = await fetch(`${API_URL}?type=member_check&lineUserId=${lineUser.userId}&_t=${Date.now()}`);
    const result = await res.json();

    if (result.status === "exists") {
      const u = result.data;
      // å°‡å¾Œå°å‚³å›çš„è‹±æ–‡ Key å°æ‡‰åˆ°å‰ç«¯æ¬„ä½ (åƒè€ƒ code.gs mapHeaderToKey)
      document.getElementById('m-name').value = f0(u.name);
      document.getElementById('m-phone').value = f0(u.phone);
      document.getElementById('m-gender').value = f0(u.gender);
      document.getElementById('m-school').value = f0(u.school);
      document.getElementById('o-name').value = f0(u.orgName);
      document.getElementById('o-tax').value = f0(u.taxId);
      
      if(u.birthDate) {
        document.getElementById('m-birth').value = u.birthDate.split('T')[0];
      }
    }
  } catch (err) {
    console.error("LIFF/Data Fetch Error:", err);
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
})();
</script>

</body>
</html>
