<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員中心</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;800&display=swap');

    :root{
      --line:#06C755;
      --text-1:#111;
      --text-2:#222;
      --text-3:#333;
      --bg:#F7F9FB;
      --card:#fff;
      --border:#E2E8F0;
    }

    body{ font-family:"Noto Sans TC", sans-serif; background:var(--bg); color:var(--text-1); }

    /* ✅ 文字清楚但不會全加粗 */
    .t-title{ font-size:22px; font-weight:800; color:var(--text-1); }
    .t-sub{ font-size:15px; font-weight:500; color:var(--text-3); }
    .t-label{ font-size:14px; font-weight:700; color:var(--text-2); letter-spacing:.2px; }
    .t-meta{ font-size:14px; font-weight:500; color:var(--text-2); }

    input, select{
      width:100%;
      padding:16px;
      border-radius:14px;
      border:1.5px solid var(--border);
      background:#fff;
      margin-bottom:12px;
      font-size:16px;
      font-weight:500;
      color:var(--text-1);
      outline:none;
    }
    input::placeholder{ color:#666; font-weight:400; }
    input:focus, select:focus{ border-color:var(--line); box-shadow:0 0 0 3px rgba(6,199,85,.12); }

    .btn-main{
      background:var(--line);
      color:#fff;
      width:100%;
      padding:18px;
      border-radius:18px;
      font-weight:800;
      font-size:18px;
    }
    .btn-edit{
      background:#EAF2FF;
      color:#1246B7;
      padding:12px 16px;
      border-radius:14px;
      font-weight:700;
      font-size:15px;
      border:1px solid #CFE0FF;
    }
    .btn-mini{
      font-size:14px;
      font-weight:700;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid #CFE0FF;
      background:#EAF2FF;
      color:#1246B7;
    }
    .btn-danger{
      font-size:14px;
      font-weight:700;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid #FECACA;
      background:#FFF1F2;
      color:#BE123C;
    }

    /* Loading */
    #loading{
      position:fixed; inset:0; background:white;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:100;
    }

    /* Topbar Back */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid #EEF2F7;
      padding:12px 6px;
      margin:-8px -8px 14px -8px;
    }
    .back-btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text-1);
      font-weight:700;
      font-size:15px;
    }

    /* LINE badge */
    .line-profile-badge{
      display:flex; align-items:center; gap:12px; background:var(--card);
      padding:12px 16px; border-radius:999px; border:1px solid var(--border);
      margin-bottom:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
    }

    /* cards */
    .member-card{
      background:var(--card);
      border:1px solid #E5E7EB;
      border-radius:20px;
      padding:18px;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:12px;
      box-shadow:0 8px 22px rgba(0,0,0,.04);
    }

    /* ✅ 本人/成員標籤不同色 */
    .tag-self{
      font-size:12px; font-weight:700;
      padding:6px 12px; border-radius:999px;
      background:#EAFBF0; color:#0F7A34; border:1px solid #BBF7D0;
    }
    .tag-member{
      font-size:12px; font-weight:700;
      padding:6px 12px; border-radius:999px;
      background:#EEF2FF; color:#3730A3; border:1px solid #C7D2FE;
    }
  </style>
</head>

<body class="flex justify-center">
  <div id="loading">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
    <p class="t-sub">正在核對會員身分...</p>
  </div>

  <div class="w-full max-w-[640px] bg-white min-h-screen p-6">

    <div class="topbar">
      <button class="back-btn" onclick="goBack()">
        <i class="fas fa-chevron-left"></i> 返回
      </button>
    </div>

    <div id="line-status" class="hidden">
      <div class="line-profile-badge">
        <img id="line-avatar" src="" class="w-10 h-10 rounded-full border border-green-200">
        <div class="flex flex-col">
          <span class="t-meta" style="font-size:12px;">已透過 LINE 登入</span>
          <span id="line-name" class="t-sub" style="font-size:16px;">載入中...</span>
        </div>
        <div class="ml-auto flex items-center gap-2 t-meta" style="color:#0F7A34;">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> 連線中
        </div>
      </div>
    </div>

    <!-- 已註冊 -->
    <div id="view-exists" class="hidden">
      <h2 class="t-title mb-2">會員資料</h2>
      <p class="t-sub mb-6">已註冊者將顯示所有成員列表，可編輯更新</p>

      <div class="flex items-center justify-between p-6 bg-white rounded-2xl border border-gray-100 mb-4"
           style="box-shadow:0 10px 28px rgba(0,0,0,.05);">
        <div>
          <div class="t-label" style="font-size:13px;">中心註冊姓名</div>
          <div id="summary-name" class="t-title" style="font-size:24px;">---</div>
        </div>
        <button onclick="showEditForm()" class="btn-edit active:scale-95 transition-transform">編輯資料</button>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between mb-3">
          <div class="t-title" style="font-size:20px;">所有成員列表</div>
          <button class="btn-mini" onclick="showEditForm()">新增/編輯成員</button>
        </div>
        <div id="member-list"></div>
      </div>
    </div>

    <!-- 表單 -->
    <div id="view-form" class="hidden">
      <h2 id="form-title" class="t-title mb-2">會員個人檔案管理</h2>
      <p class="t-sub mb-6">請填寫正確資料以便報名/預約使用</p>

      <form id="reg-form">
        <div class="t-label mb-2">姓名</div>
        <input id="m-name" placeholder="請輸入真實姓名" required>

        <div class="t-label mb-2">聯絡電話</div>
        <input id="m-phone" placeholder="0912345678" required>

        <div class="t-label mb-2">性別</div>
        <select id="m-gender">
          <option value="">請選擇</option>
          <option value="男">男</option>
          <option value="女">女</option>
        </select>

        <div class="t-label mb-2">出生日期</div>
        <input type="date" id="m-birth">

        <div class="t-label mb-2">就讀學校（非學生請填 0）</div>
        <input id="m-school" placeholder="範例：中山國小 / 0">

        <hr class="my-6">

        <div class="t-label mb-2">機關名稱（無則填 0）</div>
        <input id="o-name">

        <div class="t-label mb-2">統一編號（無則填 0）</div>
        <input id="o-tax">

        <hr class="my-6">

        <div class="flex items-center justify-between mb-2">
          <div class="t-title" style="font-size:18px;">家人 / 成員資料</div>
          <button type="button" class="btn-mini" onclick="addFamilyRow()">新增成員</button>
        </div>
        <div id="family-rows"></div>

        <button type="submit" class="btn-main mt-8" id="submit-btn">確認儲存</button>

        <button type="button" id="cancel-btn" onclick="checkStatus()"
                class="w-full mt-4"
                style="font-weight:700; font-size:16px; color:#111; display:none;">
          取消返回
        </button>
      </form>
    </div>
  </div>

<script>
/* ========= 基本設定 ========= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID  = '2008786875-F7ifLsbN';

let lineUser = {};
let cachedFamilies = [];

/* ========= 返回路徑 ========= */
function goBack(){
  const u = new URL(location.href);
  const from = u.searchParams.get('from');
  if (from) { location.href = new URL(from, location.href).toString(); return; }
  if (history.length > 1) { history.back(); return; }
  location.href = new URL('index.html', location.href).toString();
}

/* ========= 工具 ========= */
function v0(v){ return v && v.toString().trim() !== '' ? v.toString().trim() : '0'; }
function f0(v){ return (v === '0' || !v) ? '' : v; }

/* ✅ 避免 Safari/時區解析 YYYY-MM-DD 出現偏移：用本地日期 */
function parseLocalYMD(ymd){
  const [y,m,d] = (ymd||'').split('-').map(n => parseInt(n,10));
  if(!y || !m || !d) return null;
  return new Date(y, m-1, d);
}

function getTaiwanGrade(birthYmd) {
  if (!birthYmd) return '0';
  const b = parseLocalYMD(birthYmd);
  if (!b) return '0';

  const entry = b.getFullYear() + 6;
  const now = new Date();
  const ay = now.getFullYear();
  const g = ay - entry + 1;

  if (g <= 0) return '學齡前';
  if (g <= 6) return `國小${g}`;
  if (g <= 9) return `國中${g-6}`;
  if (g <= 12) return `高中${g-9}`;
  return '社會人士';
}

/* ========= 介面控制 ========= */
function showEditForm() {
  document.getElementById('view-exists').classList.add('hidden');
  document.getElementById('view-form').classList.remove('hidden');
  document.getElementById('form-title').innerText = "編輯您的會員與成員資料";
  document.getElementById('cancel-btn').style.display = 'block';
  renderFamilyRows(cachedFamilies);
}

/* ===== 成員列表渲染（本人 + 家人） ===== */
function renderMemberList(user, families) {
  const list = document.getElementById('member-list');
  const items = [];

  items.push({
    role: '本人',
    name: f0(user.name) || '未填',
    gender: f0(user.gender) || '未填',
    birthDate: (user.birthDate || '').toString().split('T')[0], // GS 會回 yyyy-MM-dd，這行兼容舊資料
    grade: f0(user.grade) || '',
  });

  (families || []).forEach(f => {
    items.push({
      role: '成員',
      name: f0(f.name) || '未填',
      gender: f0(f.gender) || '未填',
      birthDate: (f.birthDate || '').toString().split('T')[0],
      grade: f0(f.grade) || '',
    });
  });

  list.innerHTML = items.map(m => `
    <div class="member-card">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <span class="${m.role==='本人' ? 'tag-self' : 'tag-member'}">${m.role}</span>
          <div class="t-title" style="font-size:20px;">${m.name}</div>
        </div>
        <div class="t-meta">
          ${m.gender ? `性別：${m.gender}` : ''}
          ${m.birthDate ? `　生日：${m.birthDate}` : ''}
          ${m.grade ? `　年級：${m.grade}` : ''}
        </div>
      </div>
      <button class="btn-mini" onclick="showEditForm()">編輯</button>
    </div>
  `).join('');
}

/* ===== 家人成員列 ===== */
function addFamilyRow(prefill = {}) {
  const wrap = document.getElementById('family-rows');

  const row = document.createElement('div');
  row.className = "p-4 rounded-2xl border border-gray-100 bg-white mb-3";
  row.style.boxShadow = "0 8px 20px rgba(0,0,0,.04)";

  const birth = (prefill.birthDate || prefill.birth || '').toString().split('T')[0];
  const grade = prefill.grade || (birth ? getTaiwanGrade(birth) : '');
  const school = (prefill.school && prefill.school !== '0') ? prefill.school : '0';

  row.innerHTML = `
    <div class="flex items-center justify-between mb-2">
      <div class="t-title" style="font-size:16px;">成員</div>
      <button type="button" class="btn-danger" onclick="this.closest('div').remove()">刪除</button>
    </div>

    <div class="t-label mb-2">姓名</div>
    <input class="f-name" value="${prefill.name || ''}" placeholder="成員姓名">

    <div class="t-label mb-2">性別</div>
    <select class="f-gender">
      <option value="">請選擇</option>
      <option value="男">男</option>
      <option value="女">女</option>
    </select>

    <div class="t-label mb-2">生日</div>
    <input type="date" class="f-birth" value="${birth}">

    <div class="t-label mb-2">就讀學校（非學生填 0）</div>
    <input class="f-school" value="${school}" placeholder="例：元智大學 / 0">

    <div class="t-label mb-2">目前年級</div>
    <input class="f-grade" value="${grade}" placeholder="例：國小3 / 社會人士">
  `;

  wrap.appendChild(row);
  row.querySelector('.f-gender').value = prefill.gender || '';

  row.querySelector('.f-birth').addEventListener('change', (ev) => {
    const b = ev.target.value;
    row.querySelector('.f-grade').value = getTaiwanGrade(b);
  });
}

function renderFamilyRows(families) {
  const wrap = document.getElementById('family-rows');
  wrap.innerHTML = '';
  (families || []).forEach(f => addFamilyRow({
    name: f.name || '',
    gender: f.gender || '',
    birthDate: f.birthDate || '',
    school: f.school || '0',
    grade: f.grade || ''
  }));
}

/* ===== 狀態檢查 ===== */
async function checkStatus() {
  document.getElementById('loading').style.display = 'flex';
  try {
    const res = await fetch(`${API_URL}?type=member_check&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`);
    const raw = await res.json();

    // 兼容兩種回傳：
    // 1) 直接 GAS：{status:"exists"...}
    // 2) Worker 包裝：{status:"ok", data:{...gas...}}
    const result = raw?.data ? raw.data : raw;

    if (result.status === "exists") {
      const u = result.data || {};
      const families = result.families || [];
      cachedFamilies = families;

      document.getElementById('summary-name').innerText = f0(u.name) || '---';

      // 預填表單（GS 已回 yyyy-MM-dd，不會少一天）
      document.getElementById('m-name').value = f0(u.name);
      document.getElementById('m-phone').value = f0(u.phone);
      document.getElementById('m-gender').value = f0(u.gender);
      document.getElementById('m-school').value = f0(u.school);
      document.getElementById('o-name').value = f0(u.orgName);
      document.getElementById('o-tax').value = f0(u.taxId);

      const bd = (u.birthDate || '').toString().split('T')[0];
      if (bd) document.getElementById('m-birth').value = bd;

      renderMemberList(u, families);

      document.getElementById('view-exists').classList.remove('hidden');
      document.getElementById('view-form').classList.add('hidden');
    } else {
      cachedFamilies = [];
      document.getElementById('view-exists').classList.add('hidden');
      document.getElementById('view-form').classList.remove('hidden');
      document.getElementById('form-title').innerText = "歡迎首次註冊中心會員";
      document.getElementById('cancel-btn').style.display = 'none';
      renderFamilyRows([]);
    }
  } catch (e) {
    console.error(e);
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

/* ===== 送出（本人 + 家人） ===== */
document.getElementById('reg-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerText = '正在處理同步...';

  const familyData = [...document.querySelectorAll('#family-rows > div')].map(block => {
    const name = v0(block.querySelector('.f-name').value);
    const gender = v0(block.querySelector('.f-gender').value);
    const birth = v0(block.querySelector('.f-birth').value);
    const school = v0(block.querySelector('.f-school').value);
    const grade = v0(block.querySelector('.f-grade').value || getTaiwanGrade(birth));

    // 全空就跳過
    if (name === '0' && gender === '0' && birth === '0' && school === '0' && grade === '0') return null;

    return {
      姓名: name,
      性別: gender,
      生日: birth,
      就讀學校: school,
      目前年級: grade
    };
  }).filter(Boolean);

  const birthSelf = v0(document.getElementById('m-birth').value);

  const payload = {
    type: 'member_register',
    lineUserId: lineUser.userId || '0',
    註冊身分: '個人會員',
    姓名: v0(document.getElementById('m-name').value),
    聯絡電話: v0(document.getElementById('m-phone').value),
    性別: v0(document.getElementById('m-gender').value),
    出生日期: birthSelf,
    就讀學校: v0(document.getElementById('m-school').value),
    目前年級: getTaiwanGrade(birthSelf),
    機關名稱: v0(document.getElementById('o-name').value),
    統一編號: v0(document.getElementById('o-tax').value),
    familyData
  };

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    await res.json();
    alert('✅ 會員資料已同步成功');
    checkStatus();
  } catch (err) {
    alert('❌ 送出失敗');
  } finally {
    btn.disabled = false;
    btn.innerText = '確認儲存';
  }
});

/* ===== LIFF init：登入後回本頁 ===== */
(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      const cleanUrl = location.origin + location.pathname + location.search;
      liff.login({ redirectUri: cleanUrl });
      return;
    }

    lineUser = await liff.getProfile();

    document.getElementById('line-avatar').src =
      lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
    document.getElementById('line-name').innerText = lineUser.displayName || 'LINE 使用者';
    document.getElementById('line-status').classList.remove('hidden');

    checkStatus();
  } catch (err) {
    console.error("LIFF Init Error:", err);
  }
})();
</script>
</body>
</html>
