<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>課程預約</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;800&display=swap');
    body{font-family:"Noto Sans TC",sans-serif;background:#f6f8fb;color:#111;}
    .card{background:#fff;border:1px solid #e7edf5;border-radius:18px;box-shadow:0 8px 22px rgba(0,0,0,.04);}
    .btn{border-radius:16px;font-weight:800;}
    .btn-line{background:#06C755;color:#fff;}
    .btn-soft{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;}
    .muted{color:#334155;}
    .tag-self{background:#EAFBF0;color:#0F7A34;border:1px solid #BBF7D0;}
    .tag-member{background:#EEF2FF;color:#3730A3;border:1px solid #C7D2FE;}
  </style>
</head>

<body class="max-w-[720px] mx-auto p-4 pb-28">

  <!-- Topbar -->
  <div class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-100 px-2 py-3 -mx-4 mb-4">
    <div class="flex items-center justify-between">
      <button class="btn btn-soft px-4 py-2 text-sm" onclick="goBack()">← 返回</button>
      <div class="font-black text-base">課程預約</div>
      <div class="w-[72px]"></div>
    </div>
  </div>

  <!-- Error -->
  <div id="error-box" class="hidden card p-4 border-red-200 bg-red-50 mb-4">
    <div class="font-black text-red-600 mb-1">載入失敗</div>
    <div id="error-msg" class="text-red-600 text-sm"></div>
    <button class="btn btn-soft px-4 py-2 mt-3 text-sm" onclick="init()">重新載入</button>
  </div>

  <!-- Loading -->
  <div id="loading" class="card p-6 mb-4">
    <div class="flex items-center gap-3">
      <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-500"></div>
      <div class="font-bold muted">正在載入課程與會員資料...</div>
    </div>
  </div>

  <!-- Course Summary -->
  <div id="course-card" class="hidden card p-5 mb-4">
    <div class="font-black text-xl" id="course-name">--</div>
    <div class="muted mt-1 text-sm" id="course-meta">--</div>
  </div>

  <!-- Price -->
  <div id="price-card" class="hidden card p-5 mb-4">
    <div class="font-black text-lg mb-3">費用</div>
    <div class="grid grid-cols-2 gap-3">
      <div class="card p-4">
        <div class="text-xs muted font-bold">會員價</div>
        <div class="text-xl font-black" id="price-member">$0</div>
      </div>
      <div class="card p-4">
        <div class="text-xs muted font-bold">早鳥價</div>
        <div class="text-xl font-black" id="price-early">$0</div>
        <div class="text-[11px] muted mt-1" id="early-deadline"></div>
      </div>
    </div>

    <div class="mt-4 flex items-center justify-between card p-4">
      <div>
        <div class="font-black">使用早鳥價</div>
        <div class="text-[12px] muted" id="early-hint">符合期限才可使用</div>
      </div>
      <input id="toggle-early" type="checkbox" class="w-6 h-6 accent-green-500">
    </div>
  </div>

  <!-- Attendee -->
  <div id="attendee-card" class="hidden card p-5 mb-4">
    <div class="flex items-center justify-between">
      <div class="font-black text-lg">預約對象</div>
      <button class="btn btn-soft px-4 py-2 text-sm" onclick="openAttendeeModal()">更換</button>
    </div>

    <div class="mt-4 card p-4">
      <div class="flex items-center gap-2 mb-2">
        <span id="attendee-tag" class="text-xs font-bold px-3 py-1 rounded-full tag-self">本人</span>
        <div class="font-black text-lg" id="attendee-name">--</div>
      </div>
      <div class="text-sm muted" id="attendee-meta">--</div>
    </div>
  </div>

  <!-- Dynamic Form -->
  <div id="form-card" class="hidden card p-5 mb-4">
    <div class="font-black text-lg mb-2">詳細報名資料</div>
    <div class="text-sm muted mb-4">依課程需求填寫（可留空欄位不會送出）</div>
    <div id="dynamic-form" class="space-y-3"></div>
  </div>

  <!-- Equipment -->
  <div id="equipment-card" class="hidden card p-5 mb-4">
    <div class="font-black text-lg">租用設備</div>
    <div class="text-sm muted mt-1">可選擇租用，系統會加總設備費用</div>
    <div id="equipment-list" class="mt-4 space-y-3"></div>
    <div id="equipment-empty" class="hidden mt-4 text-sm muted">目前沒有可租用設備（請到 SYS 設定 equipment_list）</div>
  </div>

  <!-- Total -->
  <div id="total-card" class="hidden card p-5 mb-6">
    <div class="flex items-center justify-between">
      <div class="font-black text-lg">結算</div>
      <div class="text-sm muted">送出前會再確認</div>
    </div>

    <div class="mt-4 space-y-2 text-sm">
      <div class="flex justify-between"><span class="muted">課程費用</span><span id="sum-base">$0</span></div>
      <div class="flex justify-between"><span class="muted">設備費用</span><span id="sum-eq">$0</span></div>
      <div class="border-t border-slate-100 my-2"></div>
      <div class="flex justify-between text-lg font-black"><span>應付金額</span><span id="sum-total">$0</span></div>
    </div>
  </div>

  <!-- CTA -->
  <div class="fixed left-0 right-0 bottom-0 bg-white/90 backdrop-blur border-t border-slate-100 p-4">
    <div class="max-w-[720px] mx-auto">
      <button id="btn-submit" class="btn btn-line w-full py-4 text-lg" onclick="submitBooking()" disabled>
        確認送出預約
      </button>
    </div>
  </div>

  <!-- Attendee Modal -->
  <div id="attendee-modal" class="hidden fixed inset-0 z-50 bg-black/40">
    <div class="absolute inset-x-0 bottom-0 bg-white rounded-t-3xl p-5 max-h-[85vh] overflow-auto">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-black text-lg">選擇報名對象</div>
          <div class="text-sm muted mt-1">勾選後才會進行結算</div>
        </div>
        <button class="btn btn-soft px-4 py-2 text-sm" onclick="closeAttendeeModal()">關閉</button>
      </div>

      <div id="attendee-list" class="mt-4 space-y-3"></div>

      <button class="btn btn-line w-full py-4 mt-6 text-lg" onclick="confirmAttendee()">
        確認選擇
      </button>
    </div>
  </div>

<script>
/* =========================
 * 基本設定
 * ========================= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = '2008786875-F7ifLsbN';

let _initOnce = false;

let lineUser = null;
let courseSheet = 'SingleCourses';   // 由 URL 的 type 取（避免跟 API 的 type 衝突）
let courseId = '';

let course = null;
let memberPack = null; // {status, data, families}
let configKV = {};     // config.kv

let attendeeList = [];
let selectedAttendee = null;

let equipmentCatalog = []; // [{name, price}]
let selectedEquip = new Set();
let useEarlyBird = false;

/* =========================
 * 工具
 * ========================= */
function showError(msg){
  const box = document.getElementById('error-box');
  const m = document.getElementById('error-msg');
  if (!box || !m) return;
  m.textContent = msg || '未知錯誤';
  box.classList.remove('hidden');
  document.getElementById('loading')?.classList.add('hidden');
}

function hideError(){
  document.getElementById('error-box')?.classList.add('hidden');
}

function money(n){
  const x = Number(n || 0) || 0;
  return '$' + x.toLocaleString('zh-TW');
}

function isYmd(s){
  return typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s);
}

function todayYmd(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

function goBack(){
  const u = new URL(location.href);
  const from = u.searchParams.get('from');
  if (from) { location.href = new URL(from, location.href).toString(); return; }
  if (history.length > 1) { history.back(); return; }
  location.href = new URL('index.html', location.href).toString();
}

/* =========================
 * Config / equipment_list 解析
 * ========================= */
function parseEquipmentFromKV(kv){
  // kv: { equipment_list: { Global: "[{...}]" } }
  const raw = kv?.equipment_list?.Global ?? kv?.equipment_list?.global ?? kv?.equipment_list;
  if (!raw) return [];
  try{
    const arr = typeof raw === 'string' ? JSON.parse(raw) : raw;
    if (!Array.isArray(arr)) return [];
    return arr.map(x => ({
      name: String(x?.name ?? '').trim(),
      price: Number(x?.price ?? 0) || 0
    })).filter(x => x.name);
  }catch(e){
    return [];
  }
}

/* =========================
 * 動態表單（可擴充）
 * 你之後要做梯次課/營隊/課後班：在這裡加 handler
 * ========================= */
const COURSE_TYPE_HANDLERS = {
  // 單堂課：示範先做最穩的
  SingleCourses: {
    buildDynamicFields(courseObj){
      // 若你未來要用某欄位（例如 courseObj.formFieldsJson）來定義欄位，可在這裡擴充
      // 目前：若課程表沒有欄位定義，就顯示「可填備註」即可
      return [
        { key:'note', label:'備註（選填）', type:'textarea', placeholder:'例如：是否有舊傷、需注意事項...' }
      ];
    }
  }
};

function renderDynamicForm(){
  const wrap = document.getElementById('dynamic-form');
  if (!wrap) return;
  wrap.innerHTML = '';

  const handler = COURSE_TYPE_HANDLERS[courseSheet] || COURSE_TYPE_HANDLERS.SingleCourses;
  const fields = handler.buildDynamicFields(course) || [];

  fields.forEach(f=>{
    const id = `f_${f.key}`;
    const box = document.createElement('div');
    box.className = "card p-4";

    if (f.type === 'textarea'){
      box.innerHTML = `
        <div class="font-bold mb-2">${f.label}</div>
        <textarea id="${id}" class="w-full border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-green-200"
          rows="3" placeholder="${f.placeholder||''}"></textarea>
      `;
    } else {
      box.innerHTML = `
        <div class="font-bold mb-2">${f.label}</div>
        <input id="${id}" class="w-full border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-green-200"
          placeholder="${f.placeholder||''}">
      `;
    }
    wrap.appendChild(box);
  });

  document.getElementById('form-card')?.classList.remove('hidden');
}

/* =========================
 * UI Render
 * ========================= */
function renderCourse(){
  if (!course){
    showError('找不到課程資料（course=null）');
    return;
  }

  const name = course.courseName || course["課程名稱"] || '--';
  const d = course.courseDate || course["課程日期"] || '';
  const st = course.startTime || course["開始時間"] || '';
  const et = course.endTime || course["結束時間"] || '';

  document.getElementById('course-name').textContent = name;

  const meta = [];
  if (d) meta.push(`日期：${String(d).split('T')[0]}`);
  if (st || et) meta.push(`時間：${formatTime_(st)}-${formatTime_(et)}`);
  document.getElementById('course-meta').textContent = meta.join('　');

  document.getElementById('course-card').classList.remove('hidden');

  // price
  const memberPrice = Number(course.memberPrice || course["會員價"] || 0) || 0;
  const earlyPrice = Number(course.priceEarly || course["早鳥價"] || 0) || 0;
  const deadline = String(course.earlyDeadline || course["早鳥截止"] || '').split('T')[0];

  document.getElementById('price-member').textContent = money(memberPrice);
  document.getElementById('price-early').textContent = money(earlyPrice);

  document.getElementById('early-deadline').textContent = deadline ? `早鳥截止：${deadline}` : '';

  const canEarly = earlyPrice > 0 && deadline && isYmd(deadline) && (todayYmd() <= deadline);
  document.getElementById('early-hint').textContent = canEarly ? '目前符合早鳥期限，可勾選使用' : '目前不符合早鳥期限或未設定早鳥價';

  const toggle = document.getElementById('toggle-early');
  toggle.checked = false;
  toggle.disabled = !canEarly;
  useEarlyBird = false;

  toggle.onchange = () => {
    useEarlyBird = !!toggle.checked;
    recalcTotal();
  };

  document.getElementById('price-card').classList.remove('hidden');

  // dynamic form
  renderDynamicForm();
}

function formatTime_(v){
  // 避免 1899-12-30T14:30:00
  if (!v) return '';
  const s = String(v);
  const m = s.match(/(\d{1,2}):(\d{2})/);
  if (m) return `${m[1].padStart(2,'0')}:${m[2]}`;
  return s;
}

function buildAttendeeList(){
  const u = memberPack?.data || {};
  const fam = Array.isArray(memberPack?.families) ? memberPack.families : [];

  attendeeList = [];

  attendeeList.push({
    role: '本人',
    name: (u.name && String(u.name).trim() && String(u.name).trim() !== '0') ? String(u.name).trim() : '本人',
    gender: u.gender || '未填',
    birthDate: (u.birthDate || '0'),
    memberId: u.memberId || '',
  });

  fam.forEach((f, idx)=>{
    const raw = (f?.name ?? '').toString().trim();
    const nm = (!raw || raw === '0') ? `成員#${idx+1}` : raw;
    attendeeList.push({
      role: '成員',
      name: nm,
      gender: f.gender || '未填',
      birthDate: f.birthDate || '0',
      memberId: u.memberId || '',
    });
  });

  selectedAttendee = attendeeList[0]; // 預設本人
  renderSelectedAttendee();
}

function renderSelectedAttendee(){
  if (!selectedAttendee) return;

  const tag = document.getElementById('attendee-tag');
  tag.textContent = selectedAttendee.role;
  tag.className = `text-xs font-bold px-3 py-1 rounded-full ${selectedAttendee.role==='本人'?'tag-self':'tag-member'}`;

  document.getElementById('attendee-name').textContent = selectedAttendee.name;

  const meta = [];
  if (selectedAttendee.gender) meta.push(`性別：${selectedAttendee.gender}`);
  const bd = String(selectedAttendee.birthDate||'').split('T')[0];
  if (bd && bd !== '0') meta.push(`生日：${bd}`);
  document.getElementById('attendee-meta').textContent = meta.join('　');

  document.getElementById('attendee-card').classList.remove('hidden');
}

function openAttendeeModal(){
  const modal = document.getElementById('attendee-modal');
  const list = document.getElementById('attendee-list');
  if (!modal || !list) return;

  list.innerHTML = attendeeList.map((a, idx)=>{
    const checked = (selectedAttendee && selectedAttendee.name === a.name && selectedAttendee.role === a.role) ? 'checked' : '';
    const bd = String(a.birthDate||'').split('T')[0];
    const tagCls = a.role==='本人'?'tag-self':'tag-member';
    return `
      <label class="card p-4 flex items-start gap-3 cursor-pointer">
        <input type="radio" name="att" value="${idx}" class="mt-1 w-5 h-5 accent-green-500" ${checked}>
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold px-3 py-1 rounded-full ${tagCls}">${a.role}</span>
            <div class="font-black text-lg">${a.name}</div>
          </div>
          <div class="text-sm muted mt-1">
            性別：${a.gender || '未填'}
            ${bd && bd!=='0' ? `　生日：${bd}` : ''}
          </div>
        </div>
      </label>
    `;
  }).join('');

  modal.classList.remove('hidden');
}

function closeAttendeeModal(){
  document.getElementById('attendee-modal')?.classList.add('hidden');
}

function confirmAttendee(){
  const pick = document.querySelector('input[name="att"]:checked');
  if (!pick) return;

  const idx = Number(pick.value);
  selectedAttendee = attendeeList[idx];
  renderSelectedAttendee();
  closeAttendeeModal();
  recalcTotal();

  // 有選擇才允許送出
  document.getElementById('btn-submit').disabled = false;
}

/* =========================
 * Equipment
 * ========================= */
function renderEquipment(){
  equipmentCatalog = parseEquipmentFromKV(configKV);
  const list = document.getElementById('equipment-list');
  const empty = document.getElementById('equipment-empty');

  if (!list || !empty) return;

  selectedEquip = new Set();

  if (!equipmentCatalog.length){
    list.innerHTML = '';
    empty.classList.remove('hidden');
    document.getElementById('equipment-card')?.classList.remove('hidden');
    recalcTotal();
    return;
  }

  empty.classList.add('hidden');
  list.innerHTML = equipmentCatalog.map((eq, i)=>`
    <label class="card p-4 flex items-center gap-3 cursor-pointer">
      <input type="checkbox" class="w-6 h-6 accent-green-500" data-eq="${i}">
      <div class="flex-1">
        <div class="font-black text-lg">${eq.name}</div>
        <div class="text-sm muted">加價：${money(eq.price)}</div>
      </div>
    </label>
  `).join('');

  list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const i = Number(cb.getAttribute('data-eq'));
      const name = equipmentCatalog[i]?.name;
      if (!name) return;
      if (cb.checked) selectedEquip.add(name);
      else selectedEquip.delete(name);
      recalcTotal();
    });
  });

  document.getElementById('equipment-card')?.classList.remove('hidden');
  recalcTotal();
}

/* =========================
 * Total
 * ========================= */
function recalcTotal(){
  const memberPrice = Number(course?.memberPrice || course?.["會員價"] || 0) || 0;
  const earlyPrice = Number(course?.priceEarly || course?.["早鳥價"] || 0) || 0;
  const base = (useEarlyBird && earlyPrice>0) ? earlyPrice : memberPrice;

  let eqFee = 0;
  const eqItems = [...selectedEquip];
  eqItems.forEach(n=>{
    const found = equipmentCatalog.find(x=>x.name===n);
    if (found) eqFee += Number(found.price||0);
  });

  const total = base + eqFee;

  document.getElementById('sum-base').textContent = money(base);
  document.getElementById('sum-eq').textContent = money(eqFee);
  document.getElementById('sum-total').textContent = money(total);

  document.getElementById('total-card')?.classList.remove('hidden');
}

/* =========================
 * Submit
 * ========================= */
function collectFormData(){
  const data = {};
  document.querySelectorAll('#dynamic-form [id^="f_"]').forEach(el=>{
    const key = el.id.replace(/^f_/, '');
    const val = (el.value || '').toString().trim();
    if (val) data[key] = val;
  });
  return data;
}

async function submitBooking(){
  try{
    if (!course) return showError('找不到課程資料（course=null）');
    if (!selectedAttendee) return showError('請先選擇報名對象');

    const btn = document.getElementById('btn-submit');
    btn.disabled = true;
    btn.textContent = '送出中...';

    const memberPrice = Number(course.memberPrice || course["會員價"] || 0) || 0;
    const earlyPrice = Number(course.priceEarly || course["早鳥價"] || 0) || 0;
    const basePrice = (useEarlyBird && earlyPrice>0) ? earlyPrice : memberPrice;

    let equipmentFee = 0;
    const equipmentItems = [...selectedEquip];
    equipmentItems.forEach(n=>{
      const found = equipmentCatalog.find(x=>x.name===n);
      if (found) equipmentFee += Number(found.price||0);
    });

    const totalAmount = basePrice + equipmentFee;

    const u = memberPack?.data || {};
    const formData = collectFormData();

    const payload = {
      type: 'course_booking',
      sheet: courseSheet,
      courseId: course.courseId || course.id || course.UUID || courseId,

      lineUserId: lineUser?.userId || '',
      memberId: u.memberId || '',

      attendeeRole: selectedAttendee.role,
      attendeeName: selectedAttendee.name,
      attendeeGender: selectedAttendee.gender,
      attendeeBirthDate: String(selectedAttendee.birthDate||'0').split('T')[0],

      useEarlyBird: !!useEarlyBird,
      basePrice,
      equipmentItems,
      equipmentFee,
      totalAmount,

      payStatus: 'unpaid',
      bookingStatus: 'pending',

      formData,
      note: formData.note || ''
    };

    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await resp.json();

    if (json.status !== 'success'){
      return showError(json.message || '預約失敗');
    }

    alert('✅ 預約成功\n預約ID：' + json.bookingId);
    goBack();

  }catch(err){
    showError(String(err));
  }finally{
    const btn = document.getElementById('btn-submit');
    if (btn){
      btn.disabled = false;
      btn.textContent = '確認送出預約';
    }
  }
}

/* =========================
 * Init
 * ========================= */
async function init(){
  if (_initOnce) return;
  _initOnce = true;

  hideError();

  const params = new URL(location.href).searchParams;

  // ✅ 你的頁面 URL 用 type=SingleCourses（我們把它當作 sheet）
  courseSheet = params.get('type') || params.get('sheet') || 'SingleCourses';
  courseId = params.get('id') || params.get('courseId') || '';

  if (!courseId){
    showError('缺少課程 id');
    return;
  }

  try{
    // LIFF
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

    if (!liff.isLoggedIn()){
      const cleanUrl = location.origin + location.pathname + location.search;
      liff.login({ redirectUri: cleanUrl });
      return;
    }

    lineUser = await liff.getProfile();

    // booking_init：一次取課程 + 會員 + config
    const qs = new URLSearchParams({
      type: 'booking_init',
      sheet: courseSheet,
      id: courseId,
      lineUserId: lineUser.userId,
      _t: Date.now()
    });

    const res = await fetch(`${API_URL}?${qs.toString()}`);
    const raw = await res.json();

    if (raw.status !== 'success'){
      showError(raw.message || '雲端連線失敗');
      return;
    }

    course = raw.data?.course || null;

    // member 會是 {status, data, families}
    const member = raw.data?.member || {status:'not_found'};
    memberPack = (member.status === 'exists')
      ? { data: member.data || {}, families: member.families || [] }
      : { data: {}, families: [] };

    configKV = raw.data?.config || {};

    if (!course){
      showError('找不到課程資料（course=null）');
      return;
    }

    // 若會員不存在，仍可讓他回會員中心註冊（這裡先直接提示）
    if (!memberPack.data || !memberPack.data.memberId){
      // 你要的做法是：若未註冊就導去 register.html
      // 這裡不強制跳，避免你流程被打斷；你可自行改成 location.href
      console.warn('member not found');
    }

    // render
    document.getElementById('loading')?.classList.add('hidden');

    renderCourse();
    buildAttendeeList();
    renderEquipment();
    confirmAttendee(); // 預設本人（會 enable submit）

  }catch(err){
    showError(String(err));
  }
}

init();
</script>
</body>
</html>
