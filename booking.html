<script>
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID  = '2008786875-F7ifLsbN';

let lineUser = null;
let memberData = null;
let course = null;
let config = null;

let selectedAttendee = null;
let attendeeCandidates = [];

let selectedPlan = null;
let basePrice = 0;
let equipTotal = 0;

let equipPriceMap = {};     // {籃球:100,...}
let globalEquipList = [];   // [{name,price},...]

function qs(k){ return new URL(location.href).searchParams.get(k) || ''; }

function safeText(v){
  if (v === undefined || v === null) return '';
  const s = String(v).trim();
  if (!s || s === '0' || s === 'null' || s === 'undefined') return '';
  return s;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function toNumber(v){
  if(v===undefined || v===null) return 0;
  const s = String(v).replace(/[^\d.]/g,'').trim();
  if(!s) return 0;
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmtMoney(n){
  const x = Number(n)||0;
  return '$' + x.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

function goBack(){
  const from = qs('from');
  if (from) { location.href = decodeURIComponent(from); return; }
  if (history.length > 1) { history.back(); return; }
  location.href = new URL('index.html', location.href).toString();
}

function showError(msg){
  const loading = document.getElementById('loading');
  loading.innerHTML = `
    <div class="title text-[18px] text-red-700">雲端連線失敗</div>
    <div class="sub mt-2 text-red-700">${escapeHtml(msg || '未知錯誤')}</div>
    <div class="mt-4"><button class="btn btn-ghost" onclick="location.reload()">重試</button></div>
  `;
}

function normalizeConfigEquip(){
  equipPriceMap = {};
  globalEquipList = [];

  // ✅ 期待格式：config.equipment_list.Global = "[{name,price}...]"
  let raw = config?.equipment_list;
  if (!raw) return;

  // raw 可能是 {Global:"..."} 或直接是字串/陣列
  let g = raw.Global || raw.global || raw.GLOBAL || raw;

  try {
    if (typeof g === 'string' && g.trim().startsWith('[')) {
      globalEquipList = JSON.parse(g);
    } else if (Array.isArray(g)) {
      globalEquipList = g;
    } else {
      globalEquipList = [];
    }
  } catch (e) {
    globalEquipList = [];
  }

  globalEquipList.forEach(it=>{
    const name = safeText(it?.name);
    const price = toNumber(it?.price);
    if(name) equipPriceMap[name.trim()] = price;
  });
}

function normalizeCourse(c0){
  return {
    courseId: c0.courseId || c0['課程ID'] || '',
    courseName: c0.courseName || c0['課程名稱'] || '',
    courseDate: c0.courseDate || c0['課程日期'] || '',
    startTime: c0.startTime || c0['開始時間'] || '',
    endTime: c0.endTime || c0['結束時間'] || '',
    venueName: c0.venueName || c0['場地名稱'] || '',
    genderLimit: c0.genderLimit || c0['性別限制'] || '',
    specialReq: c0.specialReq || c0['特殊要求'] || '',
    priceOriginal: c0.priceOriginal || c0['原價'] || '',
    priceEarly: c0.priceEarly || c0['早鳥價'] || '',
    earlyDeadline: c0.earlyDeadline || c0['早鳥截止'] || '',
    memberPrice: c0.memberPrice || c0['會員價'] || '',
    friendPrice: c0.friendPrice || c0['親友價'] || '',
    rentEquipment: c0.rentEquipment || c0['租用設備'] || ''
  };
}

function isEarlyBirdAvailable(c){
  const earlyPrice = toNumber(c.priceEarly);
  if(!earlyPrice) return false;
  const d = safeText(c.earlyDeadline).split(' ')[0];
  if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return false;
  const [y,m,dd] = d.split('-').map(n=>parseInt(n,10));
  const deadline = new Date(y,m-1,dd);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  return today.getTime() <= deadline.getTime();
}

function renderCourse(c0){
  course = normalizeCourse(c0);

  document.getElementById('course-name').innerText = safeText(course.courseName) || '課程';
  const meta = [
    safeText(course.courseDate) ? `日期：${safeText(course.courseDate)}` : '',
    safeText(course.startTime) ? `時間：${safeText(course.startTime)}${safeText(course.endTime)?' - '+safeText(course.endTime):''}` : '',
    safeText(course.venueName) ? `地點：${safeText(course.venueName)}` : '',
  ].filter(Boolean).join('　｜　');
  document.getElementById('course-meta').innerText = meta || '';

  renderPricePlans();
  renderEquipments(); // ✅ 價格來自 config.equipment_list.Global
  recalcTotal();
}

function renderPricePlans(){
  const c = course;
  const earlyOk = isEarlyBirdAvailable(c);

  const plans = [];
  const early  = toNumber(c.priceEarly);
  const member = toNumber(c.memberPrice);
  const friend = toNumber(c.friendPrice);
  const orig   = toNumber(c.priceOriginal);

  if(early && earlyOk) plans.push({ key:'EARLY', title:'早鳥價', price:early });
  if(member) plans.push({ key:'MEMBER', title:'會員價', price:member });
  if(friend) plans.push({ key:'FRIEND', title:'親友價', price:friend });
  if(orig) plans.push({ key:'ORIGINAL', title:'原價', price:orig });

  const wrap = document.getElementById('price-plans');
  if(!plans.length){
    wrap.innerHTML = `<div class="muted">此課程尚未設定價格</div>`;
    selectedPlan = null;
    basePrice = 0;
    return;
  }

  if(!selectedPlan) selectedPlan = plans[0].key;
  basePrice = plans.find(p=>p.key===selectedPlan)?.price ?? plans[0].price;

  wrap.innerHTML = plans.map(p=>`
    <label class="radio-card" onclick="setPlan('${p.key}', ${p.price})">
      <input type="radio" name="plan" ${p.key===selectedPlan?'checked':''}>
      <div class="flex-1">
        <div class="font-black text-[15px]">${escapeHtml(p.title)}　<span class="text-[16px] font-black">${escapeHtml(fmtMoney(p.price))}</span></div>
      </div>
    </label>
  `).join('');
}

function setPlan(key, price){
  selectedPlan = key;
  basePrice = Number(price)||0;
  renderPricePlans();
  recalcTotal();
}

/**
 * ✅ 設備解析規則
 * - 若課程 rentEquipment 有填：只列出填到的設備名稱（用 config 補 price）
 * - 若課程 rentEquipment 空：列出 config Global 全部設備
 */
function parseEquipByCourse(){
  const s = safeText(course?.rentEquipment);

  // 1) 課程沒指定：用 Global 全部
  if(!s){
    return (globalEquipList||[])
      .map(it=>({ name: safeText(it?.name), price: toNumber(it?.price) }))
      .filter(x=>x.name);
  }

  // 2) 課程有指定：可能是「籃球、排球」或「籃球|100」
  const normalized = s.replaceAll('，', ',').replaceAll('、', ',').replaceAll('\n', ',');
  const parts = normalized.split(',').map(x=>x.trim()).filter(Boolean);

  return parts.map(p=>{
    let name = p;
    let price = 0;

    if(p.includes('|')){
      const [a,b] = p.split('|');
      name = (a||'').trim();
      price = toNumber(b);
    } else {
      const m = p.match(/^(.*?)[(（]\s*(\d+)\s*[)）]$/);
      if(m){
        name = (m[1]||'').trim();
        price = toNumber(m[2]);
      }
    }

    // ✅ 用 config 補價（關鍵）
    if(name && (!price || price===0)){
      const cfgPrice = toNumber(equipPriceMap[name.trim()]);
      if(cfgPrice) price = cfgPrice;
    }

    return { name, price };
  }).filter(x=>x.name);
}

function renderEquipments(){
  const items = parseEquipByCourse();
  const section = document.getElementById('equip-section');
  const list = document.getElementById('equip-list');

  if(!items.length){
    section.style.display = 'none';
    equipTotal = 0;
    return;
  }

  section.style.display = 'block';
  list.innerHTML = items.map(it=>`
    <label class="radio-card" style="align-items:center;">
      <input type="checkbox" class="equip" data-name="${escapeHtml(it.name)}" data-price="${it.price}" onchange="recalcTotal()">
      <div class="flex-1">
        <div class="font-black text-[15px]">${escapeHtml(it.name)}</div>
        <div class="text-[13px] font-semibold opacity-90 mt-1">加價：${escapeHtml(fmtMoney(it.price||0))}</div>
      </div>
    </label>
  `).join('');
}

function planLabel(k){
  if(k==='EARLY') return '早鳥價';
  if(k==='MEMBER') return '會員價';
  if(k==='FRIEND') return '親友價';
  if(k==='ORIGINAL') return '原價';
  return '未選擇';
}

function recalcTotal(){
  const equips = [...document.querySelectorAll('.equip')];
  equipTotal = equips.filter(x=>x.checked).reduce((sum, el)=> sum + (Number(el.dataset.price)||0), 0);
  const total = (Number(basePrice)||0) + (Number(equipTotal)||0);

  document.getElementById('sum-plan').innerText = planLabel(selectedPlan);
  document.getElementById('sum-base').innerText = fmtMoney(basePrice||0);
  document.getElementById('sum-equip').innerText = fmtMoney(equipTotal||0);
  document.getElementById('sum-total').innerText = fmtMoney(total);
}

/* ========= 對象選擇（保留你原本流程） ========= */
function buildCandidates(){
  const u = memberData?.data || {};
  const families = memberData?.families || [];
  const memberId = safeText(u.memberId) || safeText(u['會員ID']) || '';

  const arr = [];
  arr.push({
    role:'本人',
    name: safeText(u.name) || '本人',
    gender: safeText(u.gender) || '',
    birthDate: (safeText(u.birthDate) || '').split('T')[0],
    grade: safeText(u.grade) || '',
    memberId
  });

  families.forEach(f => {
    arr.push({
      role:'成員',
      name: safeText(f.name) || '成員',
      gender: safeText(f.gender) || '',
      birthDate: (safeText(f.birthDate) || '').split('T')[0],
      grade: safeText(f.grade) || '',
      memberId
    });
  });

  attendeeCandidates = arr;
}

function openAttendeeModal(forceOpen){
  if(!memberData || memberData.status !== 'exists') return;
  buildCandidates();

  const wrap = document.getElementById('attendee-list');
  wrap.innerHTML = attendeeCandidates.map((p,idx)=>`
    <label class="radio-card">
      <input type="radio" name="attendee" value="${idx}" ${idx===0 ? 'checked' : ''}>
      <div class="flex-1">
        <div class="font-black text-[15px]">${escapeHtml(p.name)}　<span class="text-[12px] font-bold opacity-80">（${p.role}）</span></div>
      </div>
    </label>
  `).join('');

  document.getElementById('attendee-overlay').style.display = 'flex';
}

function closeAttendeeModal(){ document.getElementById('attendee-overlay').style.display = 'none'; }

function applyAttendee(){
  const chosen = [...document.querySelectorAll('input[name="attendee"]')].find(r=>r.checked);
  if(!chosen){ alert('請先選擇預約對象'); return; }

  const idx = parseInt(chosen.value, 10);
  selectedAttendee = attendeeCandidates[idx];

  document.getElementById('attendee-name').innerText = selectedAttendee.name || '已選擇';
  closeAttendeeModal();
}

/* ========= 送出 ========= */
async function confirmBooking(){
  if(!selectedAttendee){ openAttendeeModal(true); return; }
  if(!selectedPlan){ alert('請先選擇費用方案'); return; }

  const btn = document.getElementById('confirm-btn');
  btn.disabled = true;
  btn.innerText = '送出中...';

  try{
    const equips = [...document.querySelectorAll('.equip')]
      .filter(x=>x.checked)
      .map(el => ({ name: el.dataset.name || '', price: Number(el.dataset.price)||0 }));

    const total = (Number(basePrice)||0) + (Number(equipTotal)||0);

    const payload = {
      type:'course_booking',
      lineUserId: lineUser.userId,
      memberId: selectedAttendee.memberId || '',
      attendeeRole: selectedAttendee.role,
      attendeeName: selectedAttendee.name,
      attendeeGender: selectedAttendee.gender,
      attendeeBirthDate: selectedAttendee.birthDate,
      sheet: qs('type') || 'SingleCourses',
      courseId: qs('id'),
      pricePlan: selectedPlan,
      basePrice: Number(basePrice)||0,
      equipSelected: equips,
      equipTotal: Number(equipTotal)||0,
      grandTotal: Number(total)||0,
      note: (document.getElementById('note')?.value || '')
    };

    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if(json.status !== 'success'){
      alert('❌ 預約失敗：' + (json.message || '未知錯誤'));
      return;
    }

    alert('✅ 預約成功');
    goBack();
  }catch(e){
    alert('❌ 雲端連線失敗：' + (e.message || String(e)));
  }finally{
    btn.disabled = false;
    btn.innerText = '確認送出預約';
  }
}

/* ========= Init ========= */
async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      const clean = location.origin + location.pathname + location.search;
      liff.login({ redirectUri: clean });
      return;
    }

    lineUser = await liff.getProfile();
    document.getElementById('line-avatar').src = lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
    document.getElementById('line-name').innerText = lineUser.displayName || 'LINE';
    document.getElementById('line-pill').classList.remove('hidden');

    const courseId = qs('id');
    const sheet = qs('type') || 'SingleCourses';
    if(!courseId){ showError('缺少課程ID（URL 需帶 id=...）'); return; }

    // ✅ booking_init：課程 + 會員 + config
    const res = await fetch(`${API_URL}?type=booking_init&lineUserId=${encodeURIComponent(lineUser.userId)}&sheet=${encodeURIComponent(sheet)}&id=${encodeURIComponent(courseId)}&_t=${Date.now()}`);
    const json = await res.json();

    if(json.status !== 'success'){ showError(json.message || 'booking_init 失敗'); return; }

    const c0 = json.data?.course || null;
    memberData = json.data?.member || { status:'not_found' };
    config = json.data?.config || {};

    normalizeConfigEquip(); // ✅ 建 equipPriceMap

    if(!c0){ showError('找不到課程資料，請確認課程ID'); return; }

    renderCourse(c0);

    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');

    if(memberData.status === 'not_found'){
      const back = encodeURIComponent(location.href);
      location.href = `register.html?from=${back}`;
      return;
    }

    openAttendeeModal(false);

  }catch(e){
    showError(e.message || String(e));
  }
}
init();
</script>
