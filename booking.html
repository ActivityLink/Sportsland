<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>課程預約</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;800&display=swap');
    :root{ --line:#06C755; --bg:#F7F9FB; --text:#111; --border:#E2E8F0; }
    body{ font-family:"Noto Sans TC",sans-serif; background:var(--bg); color:var(--text); }
    .t-title{ font-size:20px; font-weight:800; }
    .t-sub{ font-size:15px; font-weight:500; color:#222; }
    .t-label{ font-size:14px; font-weight:700; color:#222; letter-spacing:.2px; }
    .btn-main{ background:var(--line); color:#fff; padding:16px; border-radius:16px; font-weight:800; font-size:17px; width:100%; }
    .btn-lite{ background:#EAF2FF; color:#1246B7; padding:12px 14px; border-radius:14px; font-weight:700; border:1px solid #CFE0FF; }
    input, select, textarea{
      width:100%; padding:14px; border-radius:14px; border:1.5px solid var(--border);
      background:#fff; font-size:16px; font-weight:500; color:#111; outline:none;
    }
    textarea{ min-height:100px; }
    input:focus, select:focus, textarea:focus{ border-color:var(--line); box-shadow:0 0 0 3px rgba(6,199,85,.12); }
    #loading{
      position:fixed; inset:0; background:white; z-index:100;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }

    /* Bottom sheet (對象選擇) */
    .sheet-mask{
      position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:200;
      display:none; align-items:flex-end; justify-content:center;
    }
    .sheet{
      width:100%; max-width:640px; background:#fff;
      border-top-left-radius:22px; border-top-right-radius:22px;
      padding:14px 14px 18px 14px;
      box-shadow:0 -10px 30px rgba(0,0,0,.15);
      max-height:78vh; overflow:auto;
      animation:up .18s ease-out;
    }
    @keyframes up{ from{ transform:translateY(18px); opacity:.7 } to{ transform:translateY(0); opacity:1 } }
    .pill{ font-size:12px; font-weight:700; padding:6px 12px; border-radius:999px; }
    .pill-self{ background:#EAFBF0; color:#0F7A34; border:1px solid #BBF7D0; }
    .pill-member{ background:#EEF2FF; color:#3730A3; border:1px solid #C7D2FE; }
  </style>
</head>

<body class="flex justify-center">
  <div id="loading">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
    <div class="t-sub">正在連線與載入課程...</div>
  </div>

  <div class="w-full max-w-[640px] min-h-screen px-4 pb-28 pt-3">

    <!-- Topbar -->
    <div class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-slate-100 rounded-2xl px-3 py-3 flex items-center gap-3">
      <button class="btn-lite" id="backBtn">
        <i class="fas fa-chevron-left mr-1"></i> 返回
      </button>
      <div class="flex-1">
        <div class="t-title" id="courseTitle">課程預約</div>
        <div class="t-sub" id="courseMeta"></div>
      </div>
    </div>

    <!-- 選擇對象 -->
    <div class="mt-4 bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="t-label mb-1">預約對象</div>
          <div class="t-title" style="font-size:18px" id="whoText">尚未選擇</div>
          <div class="t-sub" id="whoMeta"></div>
        </div>
        <button class="btn-lite" id="changeWhoBtn">更換</button>
      </div>
    </div>

    <!-- 詳細報名資料（A~AN） -->
    <div class="mt-4 bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
      <div class="t-title mb-2" style="font-size:18px;">詳細報名資料</div>
      <div class="t-sub mb-4">請依課程需求填寫（來自 SingleCourses A～AN）</div>
      <div id="formFields" class="space-y-4"></div>
    </div>

    <!-- Submit -->
    <div class="mt-4">
      <button class="btn-main" id="submitBtn">確認送出預約</button>
      <div class="t-sub mt-3" id="hintText"></div>
    </div>

  </div>

  <!-- 對象選擇 Bottom Sheet -->
  <div id="sheetMask" class="sheet-mask" onclick="if(event.target===this)closePicker()">
    <div class="sheet">
      <div class="flex items-center justify-between px-2 py-2">
        <div class="t-title" style="font-size:18px;">選擇預約對象</div>
        <button class="btn-lite" onclick="closePicker()"><i class="fas fa-xmark"></i></button>
      </div>
      <div id="pickerList" class="mt-2 space-y-2"></div>
    </div>
  </div>

<script>
/* ================== 基本設定 ================== */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID  = '2008786875-F7ifLsbN';

/* ✅ 防止初始化/彈窗重複跑 */
if (window.__BOOKING_INITED__) {
  console.warn('booking already inited');
} else {
  window.__BOOKING_INITED__ = true;
}

let lineUser = null;
let memberBundle = null; // {status:'exists', data:{...}, families:[...]}
let course = null;

let selected = { attendeeType: null, attendeeIndex: 0 }; // self/family
let pickerOpenedOnce = false;
let pickerLock = false;

/* ================== URL & 返回 ================== */
const u = new URL(location.href);
const courseId = u.searchParams.get('id') || '';
const courseSheet = u.searchParams.get('type') || 'SingleCourses';
const fromUrl = u.searchParams.get('from') || '';

document.getElementById('backBtn').onclick = () => {
  if (fromUrl) { location.href = fromUrl; return; }
  if (history.length > 1) { history.back(); return; }
  location.href = new URL('index.html', location.href).toString();
};

/* ================== 工具 ================== */
function safeText(v){ return (v===null||v===undefined) ? '' : String(v); }
function isEmpty(v){
  const s = safeText(v).trim();
  return (s==='' || s==='0' || s.toLowerCase()==='null' || s.toLowerCase()==='undefined');
}
function tryJson(s){
  try { return JSON.parse(s); } catch { return null; }
}

/* A~AN 欄位名列表 */
function makeColLabels_A_to_AN(){
  const labels = [];
  // A..Z
  for (let i=0;i<26;i++){
    labels.push(String.fromCharCode('A'.charCodeAt(0)+i));
  }
  // AA..AN
  const second = 'A'.charCodeAt(0);
  for (let i=0;i<14;i++){ // A..N
    labels.push('A' + String.fromCharCode(second+i));
  }
  return labels;
}

/**
 * 將欄位文字解析成題目
 * 支援幾種格式（越通用越好）：
 * 1) "題目|選項1,選項2,選項3" => select
 * 2) "題目\n選項1\n選項2" => radio
 * 3) "題目" => text
 */
function parseFieldDef(raw, key){
  const s = safeText(raw).trim();
  if (!s) return null;

  // JSON 支援： {"label":"...","type":"select|radio|text|textarea","options":[...],"required":true}
  const j = tryJson(s);
  if (j && j.label) {
    return {
      key,
      label: safeText(j.label),
      type: j.type || (Array.isArray(j.options) ? 'select' : 'text'),
      options: Array.isArray(j.options) ? j.options.map(x=>safeText(x)) : [],
      required: !!j.required,
      placeholder: safeText(j.placeholder || '')
    };
  }

  if (s.includes('|')) {
    const [label, optStr] = s.split('|');
    const options = (optStr || '').split(',').map(x=>x.trim()).filter(Boolean);
    return { key, label: label.trim() || key, type:'select', options, required:false, placeholder:'' };
  }

  if (s.includes('\n')) {
    const lines = s.split('\n').map(x=>x.trim()).filter(Boolean);
    if (lines.length >= 2) {
      const label = lines[0];
      const options = lines.slice(1);
      return { key, label, type:'radio', options, required:false, placeholder:'' };
    }
  }

  return { key, label: s, type:'text', options:[], required:false, placeholder:'' };
}

/* ================== API 讀取（避免 HTML -> json 爆炸） ================== */
async function fetchJsonSafe(url, init){
  const res = await fetch(url, init);
  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch {}
  if (!json) {
    throw new Error('API 回傳非 JSON：' + text.slice(0,120));
  }
  return json;
}

/* ================== 課程與會員載入 ================== */
async function loadCourse(){
  if (!courseId) throw new Error('缺少課程 id');
  const r = await fetchJsonSafe(`${API_URL}?sheet=${encodeURIComponent(courseSheet)}&id=${encodeURIComponent(courseId)}&_t=${Date.now()}`);
  if (r.status !== 'success') throw new Error(r.message || '課程讀取失敗');
  const list = r.data || [];
  if (!list.length) throw new Error('找不到課程資料');
  course = list[0];
}

async function loadMember(){
  const r = await fetchJsonSafe(`${API_URL}?type=member_check&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`);
  memberBundle = r;

  if (r.status !== 'exists') {
    // 未註冊：導去註冊（保留返回）
    const back = location.href;
    const regUrl = new URL('register.html', location.href);
    regUrl.searchParams.set('from', back);
    location.href = regUrl.toString();
    return;
  }
}

/* ================== UI Render ================== */
function renderCourse(){
  const name = course.courseName || course['課程名稱'] || course['活動名稱'] || '課程';
  const date = course.courseDate || course['課程日期'] || course['活動日期'] || '';
  document.getElementById('courseTitle').innerText = name;
  document.getElementById('courseMeta').innerText = date ? `日期：${safeText(date).split('T')[0]}` : '';
}

function openPicker(){
  if (pickerLock) return;
  if (pickerOpenedOnce) return; // ✅ 核心：只自動開一次（避免跑兩次）
  pickerLock = true;
  pickerOpenedOnce = true;

  renderPickerList();
  document.getElementById('sheetMask').style.display = 'flex';

  setTimeout(()=>{ pickerLock = false; }, 250);
}

function closePicker(){
  document.getElementById('sheetMask').style.display = 'none';
}

function renderPickerList(){
  const list = document.getElementById('pickerList');
  const u = memberBundle.data || {};
  const families = memberBundle.families || [];

  const items = [];
  items.push({
    labelType: '本人',
    pillClass: 'pill pill-self',
    name: u.name || '未填',
    meta: `${u.gender ? '性別：'+u.gender : ''}${u.birthDate ? '　生日：'+safeText(u.birthDate).split('T')[0] : ''}`,
    attendeeType: 'self',
    attendeeIndex: 0
  });

  families.forEach((f, i) => {
    items.push({
      labelType: '成員',
      pillClass: 'pill pill-member',
      name: f.name || '未填',
      meta: `${f.gender ? '性別：'+f.gender : ''}${f.birthDate ? '　生日：'+safeText(f.birthDate).split('T')[0] : ''}`,
      attendeeType: 'family',
      attendeeIndex: i
    });
  });

  list.innerHTML = items.map(it => `
    <button class="w-full text-left bg-white border border-slate-100 rounded-2xl px-4 py-4 shadow-sm hover:shadow transition"
      onclick="selectAttendee('${it.attendeeType}', ${it.attendeeIndex});">
      <div class="flex items-center gap-3 mb-2">
        <span class="${it.pillClass}">${it.labelType}</span>
        <div class="t-title" style="font-size:18px;">${it.name}</div>
      </div>
      <div class="t-sub">${it.meta || ''}</div>
    </button>
  `).join('');
}

window.selectAttendee = function(attendeeType, attendeeIndex){
  selected.attendeeType = attendeeType;
  selected.attendeeIndex = Number(attendeeIndex || 0);

  renderSelectedWho();
  closePicker();
};

function renderSelectedWho(){
  const u = memberBundle.data || {};
  const families = memberBundle.families || [];

  let who = null;
  if (selected.attendeeType === 'family') who = families[selected.attendeeIndex];
  else who = u;

  const name = who?.name || '未填';
  const gender = who?.gender ? `性別：${who.gender}` : '';
  const birth = who?.birthDate ? `生日：${safeText(who.birthDate).split('T')[0]}` : '';
  const grade = who?.grade ? `年級：${who.grade}` : '';

  document.getElementById('whoText').innerText = name;
  document.getElementById('whoMeta').innerText = [gender, birth, grade].filter(Boolean).join('　');
}

/* ================== A~AN 詳細報名欄位 ================== */
function renderFormFields(){
  const wrap = document.getElementById('formFields');
  wrap.innerHTML = '';

  const labels = makeColLabels_A_to_AN();
  const defs = [];

  labels.forEach(k => {
    if (course && Object.prototype.hasOwnProperty.call(course, k) && !isEmpty(course[k])) {
      const def = parseFieldDef(course[k], k);
      if (def) defs.push(def);
    }
  });

  if (!defs.length) {
    wrap.innerHTML = `<div class="t-sub">此課程未設定 A～AN 報名欄位（或欄位為空）。</div>`;
    return;
  }

  defs.forEach(def => {
    const id = `fld_${def.key}`;
    let html = '';

    if (def.type === 'select') {
      html = `
        <div>
          <div class="t-label mb-2">${def.label}</div>
          <select id="${id}">
            <option value="">請選擇</option>
            ${def.options.map(o=>`<option value="${o}">${o}</option>`).join('')}
          </select>
        </div>
      `;
    } else if (def.type === 'radio') {
      html = `
        <div>
          <div class="t-label mb-2">${def.label}</div>
          <div class="space-y-2">
            ${def.options.map((o, idx)=>`
              <label class="flex items-center gap-3 bg-white border border-slate-100 rounded-2xl px-4 py-3">
                <input type="radio" name="${id}" value="${o}" class="w-5 h-5 accent-green-500">
                <span class="t-sub" style="font-size:16px;">${o}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `;
    } else if (def.type === 'textarea') {
      html = `
        <div>
          <div class="t-label mb-2">${def.label}</div>
          <textarea id="${id}" placeholder="${def.placeholder || ''}"></textarea>
        </div>
      `;
    } else {
      html = `
        <div>
          <div class="t-label mb-2">${def.label}</div>
          <input id="${id}" placeholder="${def.placeholder || ''}">
        </div>
      `;
    }

    wrap.insertAdjacentHTML('beforeend', html);
  });
}

function collectAnswers(){
  const labels = makeColLabels_A_to_AN();
  const answers = {};
  labels.forEach(k => {
    const id = `fld_${k}`;
    const el = document.getElementById(id);
    if (el) {
      const v = safeText(el.value).trim();
      if (v) answers[k] = v;
      return;
    }
    // radio
    const radio = document.querySelector(`input[name="fld_${k}"]:checked`);
    if (radio) {
      answers[k] = safeText(radio.value).trim();
    }
  });
  return answers;
}

/* ================== 送出預約 ================== */
async function submitBooking(){
  if (!selected.attendeeType) {
    alert('請先選擇預約對象');
    pickerOpenedOnce = false; // 允許再開
    openPicker();
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerText = '送出中...';

  try {
    const answers = collectAnswers();

    const payload = {
      type: 'course_booking',
      lineUserId: lineUser.userId,
      sheet: courseSheet,
      courseId: courseId,
      attendeeType: selected.attendeeType,
      attendeeIndex: selected.attendeeIndex,
      answers
    };

    const r = await fetchJsonSafe(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    if (r.status !== 'success') {
      alert('❌ 預約失敗：' + (r.message || '請稍後再試'));
      return;
    }

    alert(`✅ 已完成預約\n預約ID：${r.bookingId || ''}`);
    // 成功後返回
    document.getElementById('backBtn').click();

  } catch (err) {
    alert('❌ 雲端連線失敗：' + String(err.message || err));
  } finally {
    btn.disabled = false;
    btn.innerText = '確認送出預約';
  }
}

/* ================== 初始化 ================== */
document.getElementById('changeWhoBtn').onclick = () => {
  // 手動更換：允許再開
  pickerOpenedOnce = false;
  openPicker();
};

document.getElementById('submitBtn').onclick = submitBooking;

(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      const clean = location.origin + location.pathname + location.search;
      liff.login({ redirectUri: clean });
      return;
    }

    lineUser = await liff.getProfile();

    // 先載課程 + 會員
    await loadCourse();
    renderCourse();

    await loadMember();
    // loadMember 可能會 redirect 註冊頁，所以這行之後才繼續
    if (!memberBundle || memberBundle.status !== 'exists') return;

    // ✅ 預設選本人
    selected.attendeeType = 'self';
    selected.attendeeIndex = 0;
    renderSelectedWho();

    // ✅ 渲染 A~AN
    renderFormFields();

    // ✅ 自動跳出對象選擇（只會一次，不會跑兩次）
    openPicker();

  } catch (err) {
    console.error(err);
    document.getElementById('hintText').innerText = '載入錯誤：' + String(err.message || err);
    alert('❌ 載入失敗：' + String(err.message || err));
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
})();
</script>
</body>
</html>
