<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>課程預約</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --line:#06C755;
      --bg:#F5F7FB;
      --card:#fff;
      --border:#E5E7EB;
      --text:#111827;
      --muted:#6B7280;
    }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Arial; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 10px 24px rgba(0,0,0,.05); }
    .btn{ border-radius:16px; padding:14px 16px; font-weight:800; }
    .btn-main{ background:var(--line); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--border); color:#111; }
    .radio-card{
      display:flex; gap:12px; align-items:flex-start;
      padding:14px; border:1px solid var(--border); border-radius:16px;
      background:#fff; cursor:pointer;
    }
    .radio-card input{ margin-top:4px; width:18px; height:18px; }
    .muted{ color:var(--muted); font-weight:600; font-size:14px; }
    #loading{
      position:fixed; inset:0; background:#fff;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:50;
    }
    #attendee-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:flex-end; justify-content:center;
      z-index:60;
    }
  </style>
</head>

<body>
  <!-- ✅ 必備：Loading（你的錯誤就是少了它） -->
  <div id="loading">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
    <div class="font-extrabold text-[16px]">載入中...</div>
    <div class="muted mt-2">正在取得課程與會員資料</div>
  </div>

  <div class="max-w-[720px] mx-auto px-4 py-4 hidden" id="content">
    <!-- Topbar -->
    <div class="flex items-center justify-between mb-3">
      <button class="btn btn-ghost" onclick="goBack()">← 返回</button>

      <!-- LINE pill -->
      <div id="line-pill" class="hidden">
        <div class="flex items-center gap-2 px-3 py-2 rounded-full border bg-white">
          <img id="line-avatar" class="w-7 h-7 rounded-full" src="" alt="avatar" />
          <div class="text-[13px] font-extrabold" id="line-name">LINE</div>
        </div>
      </div>
    </div>

    <!-- Course header -->
    <div class="card p-5 mb-4">
      <div class="text-[20px] font-black" id="course-name">課程</div>
      <div class="muted mt-2" id="course-meta"></div>
    </div>

    <!-- Attendee -->
    <div class="card p-5 mb-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-[16px] font-black">預約對象</div>
          <div class="muted mt-1">請先選擇要報名/預約的成員</div>
        </div>
        <button class="btn btn-ghost" onclick="openAttendeeModal(true)">更換</button>
      </div>
      <div class="mt-4">
        <div class="text-[18px] font-black" id="attendee-name">尚未選擇</div>
      </div>
    </div>

    <!-- Price plans -->
    <div class="card p-5 mb-4">
      <div class="text-[16px] font-black mb-3">費用方案</div>
      <div id="price-plans" class="space-y-2"></div>
      <div class="muted mt-3">會依是否符合早鳥期限自動提供早鳥選項</div>
    </div>

    <!-- Equipments -->
    <div class="card p-5 mb-4" id="equip-section" style="display:none;">
      <div class="text-[16px] font-black mb-1">租用設備</div>
      <div class="muted mb-3">可選擇租用，系統會加總設備費用</div>
      <div id="equip-list" class="space-y-2"></div>
    </div>

    <!-- Summary -->
    <div class="card p-5 mb-4">
      <div class="text-[16px] font-black mb-3">送出前結算</div>

      <div class="flex items-center justify-between py-2 border-b">
        <div class="muted">方案</div>
        <div class="font-extrabold" id="sum-plan">未選擇</div>
      </div>

      <div class="flex items-center justify-between py-2 border-b">
        <div class="muted">課程費用</div>
        <div class="font-extrabold" id="sum-base">$0</div>
      </div>

      <div class="flex items-center justify-between py-2 border-b">
        <div class="muted">設備費用</div>
        <div class="font-extrabold" id="sum-equip">$0</div>
      </div>

      <div class="flex items-center justify-between py-3">
        <div class="text-[16px] font-black">總金額</div>
        <div class="text-[20px] font-black" id="sum-total">$0</div>
      </div>

      <div class="mt-3">
        <div class="muted mb-2">備註（選填）</div>
        <textarea id="note" class="w-full p-3 rounded-2xl border bg-white" rows="3" placeholder="例如：身體狀況/需求"></textarea>
      </div>
    </div>

    <button id="confirm-btn" class="btn btn-main w-full text-[18px] py-4" onclick="confirmBooking()">
      確認送出預約
    </button>
  </div>

  <!-- Attendee overlay -->
  <div id="attendee-overlay">
    <div class="w-full max-w-[720px] bg-white rounded-t-3xl p-5">
      <div class="flex items-center justify-between">
        <div class="text-[16px] font-black">選擇預約對象</div>
        <button class="btn btn-ghost" onclick="closeAttendeeModal()">關閉</button>
      </div>

      <div class="muted mt-2 mb-3">勾選後按「確認」</div>
      <div id="attendee-list" class="space-y-2 max-h-[45vh] overflow-auto"></div>

      <div class="mt-4 flex gap-2">
        <button class="btn btn-ghost w-full" onclick="closeAttendeeModal()">取消</button>
        <button class="btn btn-main w-full" onclick="applyAttendee()">確認</button>
      </div>
    </div>
  </div>

<script>
/** =====================
 *  設定
 *  ===================== */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID  = '2008786875-F7ifLsbN';

/** =====================
 *  狀態
 *  ===================== */
let lineUser = null;
let memberData = null;
let course = null;
let config = null;

let selectedAttendee = null;
let attendeeCandidates = [];

let selectedPlan = null;
let basePrice = 0;
let equipTotal = 0;

let equipPriceMap = {};
let globalEquipList = [];

/** =====================
 *  小工具
 *  ===================== */
function el(id){ return document.getElementById(id); }
function qs(k){ return new URL(location.href).searchParams.get(k) || ''; }

function safeText(v){
  if (v === undefined || v === null) return '';
  const s = String(v).trim();
  if (!s || s === '0' || s === 'null' || s === 'undefined') return '';
  return s;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function toNumber(v){
  if(v===undefined || v===null) return 0;
  const s = String(v).replace(/[^\d.]/g,'').trim();
  if(!s) return 0;
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmtMoney(n){
  const x = Number(n)||0;
  return '$' + x.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

/** ✅ 即使 DOM 沒有 loading，也會自動補一個，永不爆炸 */
function ensureLoading_(){
  let node = el('loading');
  if(node) return node;
  node = document.createElement('div');
  node.id = 'loading';
  node.style.cssText = 'position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;';
  document.body.appendChild(node);
  return node;
}

function showError(msg){
  const loading = ensureLoading_();
  loading.style.display = 'flex';
  loading.innerHTML = `
    <div style="font-weight:900;font-size:18px;color:#b91c1c;">雲端連線失敗</div>
    <div style="margin-top:8px;font-weight:700;color:#b91c1c;font-size:14px;max-width:80vw;text-align:center;">
      ${escapeHtml(msg || '未知錯誤')}
    </div>
    <div style="margin-top:16px;">
      <button class="btn btn-ghost" onclick="location.reload()">重試</button>
    </div>
  `;
}

function goBack(){
  const from = qs('from');
  if (from) { location.href = decodeURIComponent(from); return; }
  if (history.length > 1) { history.back(); return; }
  location.href = new URL('index.html', location.href).toString();
}

/** =====================
 *  Config/設備價格
 *  ===================== */
function normalizeConfigEquip(){
  equipPriceMap = {};
  globalEquipList = [];

  const raw = config?.equipment_list;
  if (!raw) return;

  let g = raw.Global || raw.global || raw.GLOBAL || raw;

  try{
    if (typeof g === 'string' && g.trim().startsWith('[')) globalEquipList = JSON.parse(g);
    else if (Array.isArray(g)) globalEquipList = g;
  }catch(e){
    globalEquipList = [];
  }

  globalEquipList.forEach(it=>{
    const name = safeText(it?.name);
    const price = toNumber(it?.price);
    if(name) equipPriceMap[name.trim()] = price;
  });
}

/** =====================
 *  課程
 *  ===================== */
function normalizeCourse(c0){
  return {
    courseId: c0.courseId || c0['課程ID'] || '',
    courseName: c0.courseName || c0['課程名稱'] || '',
    courseDate: c0.courseDate || c0['課程日期'] || '',
    startTime: c0.startTime || c0['開始時間'] || '',
    endTime: c0.endTime || c0['結束時間'] || '',
    venueName: c0.venueName || c0['場地名稱'] || '',
    priceOriginal: c0.priceOriginal || c0['原價'] || '',
    priceEarly: c0.priceEarly || c0['早鳥價'] || '',
    earlyDeadline: c0.earlyDeadline || c0['早鳥截止'] || '',
    memberPrice: c0.memberPrice || c0['會員價'] || '',
    friendPrice: c0.friendPrice || c0['親友價'] || '',
    rentEquipment: c0.rentEquipment || c0['租用設備'] || ''
  };
}

function isEarlyBirdAvailable(c){
  const earlyPrice = toNumber(c.priceEarly);
  if(!earlyPrice) return false;
  const d = safeText(c.earlyDeadline).split(' ')[0];
  if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return false;

  const [y,m,dd] = d.split('-').map(n=>parseInt(n,10));
  const deadline = new Date(y,m-1,dd);
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  return today.getTime() <= deadline.getTime();
}

function renderCourse(c0){
  course = normalizeCourse(c0);

  el('course-name').innerText = safeText(course.courseName) || '課程';
  const meta = [
    safeText(course.courseDate) ? `日期：${safeText(course.courseDate)}` : '',
    safeText(course.startTime) ? `時間：${safeText(course.startTime)}${safeText(course.endTime)?' - '+safeText(course.endTime):''}` : '',
    safeText(course.venueName) ? `地點：${safeText(course.venueName)}` : '',
  ].filter(Boolean).join('　｜　');
  el('course-meta').innerText = meta || '';

  renderPricePlans();
  renderEquipments();
  recalcTotal();
}

function renderPricePlans(){
  const c = course;
  const earlyOk = isEarlyBirdAvailable(c);

  const plans = [];
  const early  = toNumber(c.priceEarly);
  const member = toNumber(c.memberPrice);
  const friend = toNumber(c.friendPrice);
  const orig   = toNumber(c.priceOriginal);

  if(early && earlyOk) plans.push({ key:'EARLY', title:'早鳥價', price:early });
  if(member) plans.push({ key:'MEMBER', title:'會員價', price:member });
  if(friend) plans.push({ key:'FRIEND', title:'親友價', price:friend });
  if(orig) plans.push({ key:'ORIGINAL', title:'原價', price:orig });

  const wrap = el('price-plans');
  if(!plans.length){
    wrap.innerHTML = `<div class="muted">此課程尚未設定價格</div>`;
    selectedPlan = null;
    basePrice = 0;
    return;
  }

  if(!selectedPlan) selectedPlan = plans[0].key;
  basePrice = plans.find(p=>p.key===selectedPlan)?.price ?? plans[0].price;

  wrap.innerHTML = plans.map(p=>`
    <label class="radio-card" onclick="setPlan('${p.key}', ${p.price})">
      <input type="radio" name="plan" ${p.key===selectedPlan?'checked':''}>
      <div class="flex-1">
        <div class="font-black text-[15px]">${escapeHtml(p.title)}　<span class="text-[16px] font-black">${escapeHtml(fmtMoney(p.price))}</span></div>
      </div>
    </label>
  `).join('');
}

function setPlan(key, price){
  selectedPlan = key;
  basePrice = Number(price)||0;
  renderPricePlans();
  recalcTotal();
}

function parseEquipByCourse(){
  const s = safeText(course?.rentEquipment);

  // 課程沒指定設備：列出 Global 全部
  if(!s){
    return (globalEquipList||[])
      .map(it=>({ name: safeText(it?.name), price: toNumber(it?.price) }))
      .filter(x=>x.name);
  }

  // 課程有指定：可支援 "籃球,排球" 或 "籃球|100"
  const normalized = s.replaceAll('，', ',').replaceAll('、', ',').replaceAll('\n', ',');
  const parts = normalized.split(',').map(x=>x.trim()).filter(Boolean);

  return parts.map(p=>{
    let name = p;
    let price = 0;

    if(p.includes('|')){
      const [a,b] = p.split('|');
      name = (a||'').trim();
      price = toNumber(b);
    }

    if(name && (!price || price===0)){
      const cfgPrice = toNumber(equipPriceMap[name.trim()]);
      if(cfgPrice) price = cfgPrice;
    }

    return { name, price };
  }).filter(x=>x.name);
}

function renderEquipments(){
  const items = parseEquipByCourse();
  const section = el('equip-section');
  const list = el('equip-list');

  if(!items.length){
    section.style.display = 'none';
    equipTotal = 0;
    return;
  }

  section.style.display = 'block';
  list.innerHTML = items.map(it=>`
    <label class="radio-card" style="align-items:center;">
      <input type="checkbox" class="equip" data-name="${escapeHtml(it.name)}" data-price="${it.price}" onchange="recalcTotal()">
      <div class="flex-1">
        <div class="font-black text-[15px]">${escapeHtml(it.name)}</div>
        <div class="muted mt-1">加價：${escapeHtml(fmtMoney(it.price||0))}</div>
      </div>
    </label>
  `).join('');
}

function planLabel(k){
  if(k==='EARLY') return '早鳥價';
  if(k==='MEMBER') return '會員價';
  if(k==='FRIEND') return '親友價';
  if(k==='ORIGINAL') return '原價';
  return '未選擇';
}

function recalcTotal(){
  const equips = [...document.querySelectorAll('.equip')];
  equipTotal = equips.filter(x=>x.checked).reduce((sum, el)=> sum + (Number(el.dataset.price)||0), 0);
  const total = (Number(basePrice)||0) + (Number(equipTotal)||0);

  el('sum-plan').innerText = planLabel(selectedPlan);
  el('sum-base').innerText = fmtMoney(basePrice||0);
  el('sum-equip').innerText = fmtMoney(equipTotal||0);
  el('sum-total').innerText = fmtMoney(total);
}

/** =====================
 *  對象選擇
 *  ===================== */
function buildCandidates(){
  const u = memberData?.data || {};
  const families = memberData?.families || [];
  const memberId = safeText(u.memberId) || safeText(u['會員ID']) || '';

  const arr = [];
  arr.push({
    role:'本人',
    name: safeText(u.name) || '本人',
    gender: safeText(u.gender) || '',
    birthDate: (safeText(u.birthDate) || '').split('T')[0],
    grade: safeText(u.grade) || '',
    memberId
  });

  families.forEach(f => {
    arr.push({
      role:'成員',
      name: safeText(f.name) || '成員',
      gender: safeText(f.gender) || '',
      birthDate: (safeText(f.birthDate) || '').split('T')[0],
      grade: safeText(f.grade) || '',
      memberId
    });
  });

  attendeeCandidates = arr;
}

function openAttendeeModal(){
  if(!memberData || memberData.status !== 'exists') return;
  buildCandidates();

  const wrap = el('attendee-list');
  wrap.innerHTML = attendeeCandidates.map((p,idx)=>`
    <label class="radio-card">
      <input type="radio" name="attendee" value="${idx}" ${idx===0 ? 'checked' : ''}>
      <div class="flex-1">
        <div class="font-black text-[15px]">${escapeHtml(p.name)}　<span class="muted">（${p.role}）</span></div>
      </div>
    </label>
  `).join('');

  el('attendee-overlay').style.display = 'flex';
}
function closeAttendeeModal(){ el('attendee-overlay').style.display = 'none'; }

function applyAttendee(){
  const chosen = [...document.querySelectorAll('input[name="attendee"]')].find(r=>r.checked);
  if(!chosen){ alert('請先選擇預約對象'); return; }

  const idx = parseInt(chosen.value, 10);
  selectedAttendee = attendeeCandidates[idx];
  el('attendee-name').innerText = selectedAttendee.name || '已選擇';
  closeAttendeeModal();
}

/** =====================
 *  送出
 *  ===================== */
async function confirmBooking(){
  if(!selectedAttendee){ openAttendeeModal(); return; }
  if(!selectedPlan){ alert('請先選擇費用方案'); return; }

  const btn = el('confirm-btn');
  btn.disabled = true;
  btn.innerText = '送出中...';

  try{
    const equips = [...document.querySelectorAll('.equip')]
      .filter(x=>x.checked)
      .map(elm => ({ name: elm.dataset.name || '', price: Number(elm.dataset.price)||0 }));

    const total = (Number(basePrice)||0) + (Number(equipTotal)||0);

    const payload = {
      type:'course_booking',
      lineUserId: lineUser.userId,
      memberId: selectedAttendee.memberId || '',
      attendeeRole: selectedAttendee.role,
      attendeeName: selectedAttendee.name,
      attendeeGender: selectedAttendee.gender,
      attendeeBirthDate: selectedAttendee.birthDate,
      sheet: qs('type') || 'SingleCourses',
      courseId: qs('id'),
      pricePlan: selectedPlan,
      basePrice: Number(basePrice)||0,
      equipSelected: equips,
      equipTotal: Number(equipTotal)||0,
      grandTotal: Number(total)||0,
      note: (el('note')?.value || '')
    };

    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if(json.status !== 'success'){
      alert('❌ 預約失敗：' + (json.message || '未知錯誤'));
      return;
    }

    alert('✅ 預約成功');
    goBack();
  }catch(e){
    showError(e.message || String(e));
  }finally{
    btn.disabled = false;
    btn.innerText = '確認送出預約';
  }
}

/** =====================
 *  Init（✅等 DOM 好了才跑）
 *  ===================== */
async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      const clean = location.origin + location.pathname + location.search;
      liff.login({ redirectUri: clean });
      return;
    }

    lineUser = await liff.getProfile();
    el('line-avatar').src = lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
    el('line-name').innerText = lineUser.displayName || 'LINE';
    el('line-pill').classList.remove('hidden');

    const courseId = qs('id');
    const sheet = qs('type') || 'SingleCourses';
    if(!courseId){ showError('缺少課程ID（URL 需帶 id=...）'); return; }

    const res = await fetch(`${API_URL}?type=booking_init&lineUserId=${encodeURIComponent(lineUser.userId)}&sheet=${encodeURIComponent(sheet)}&id=${encodeURIComponent(courseId)}&_t=${Date.now()}`);
    const json = await res.json();

    if(json.status !== 'success'){ showError(json.message || 'booking_init 失敗'); return; }

    const c0 = json.data?.course || null;
    memberData = json.data?.member || { status:'not_found' };
    config = json.data?.config || {};

    normalizeConfigEquip();

    if(!c0){ showError('找不到課程資料，請確認課程ID'); return; }

    renderCourse(c0);

    // 顯示內容、關閉 loading
    ensureLoading_().style.display = 'none';
    el('loading')?.classList.add('hidden');
    el('content').classList.remove('hidden');

    if(memberData.status === 'not_found'){
      const back = encodeURIComponent(location.href);
      location.href = `register.html?from=${back}`;
      return;
    }

    // 首次進來直接彈選擇
    openAttendeeModal();

  }catch(e){
    showError(e.message || String(e));
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
