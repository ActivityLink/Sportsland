<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>課程預約</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --line:#06C755; --bg:#F7F9FB; --card:#fff; --border:#E5E7EB; --text:#111; --muted:#475569;}
    body{ background:var(--bg); color:var(--text); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; }
    .btn{ border-radius:14px; padding:14px 16px; font-weight:800; }
    .btn-main{ background:var(--line); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--border); color:#111; }
    .pill{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; }
    .pill-self{ background:#EAFBF0; border-color:#BBF7D0; color:#0F7A34; }
    .pill-member{ background:#EEF2FF; border-color:#C7D2FE; color:#3730A3; }
    .muted{ color:var(--muted); }
    .h1{ font-size:18px; font-weight:900; }
    .h2{ font-size:15px; font-weight:900; }
    .meta{ font-size:14px; color:#111; }
    .small{ font-size:13px; color:var(--muted); }
    .divider{ height:1px; background:var(--border); margin:12px 0; }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:60; }
    .modal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,680px); background:#fff; border-radius:18px; border:1px solid var(--border); display:none; z-index:70; }
    .modal-h{ display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); }
    .modal-b{ padding:14px 16px; max-height:70vh; overflow:auto; }
    .radioRow{ display:flex; gap:12px; align-items:flex-start; padding:12px; border:1px solid var(--border); border-radius:16px; }
    .err{ background:#FEF2F2; border:1px solid #FECACA; color:#B91C1C; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-[720px] mx-auto px-4 py-4 pb-28">
    <!-- top -->
    <div class="flex items-center justify-between gap-3 mb-3">
      <button class="btn btn-ghost" onclick="goBack()">← 返回</button>
      <div class="h1">課程預約</div>
      <div class="w-[72px]"></div>
    </div>

    <!-- error -->
    <div id="errBox" class="card err hidden mb-3">
      <div class="font-black mb-1">載入失敗</div>
      <div id="errMsg" class="small"></div>
      <button class="btn btn-ghost mt-3 w-full" onclick="init()">重新載入</button>
    </div>

    <!-- course header -->
    <div id="courseCard" class="card mb-3 hidden">
      <div class="flex gap-3">
        <img id="coverImg" class="w-20 h-20 rounded-xl object-cover border" alt="" />
        <div class="flex-1">
          <div id="courseName" class="h1">--</div>
          <div id="courseMeta" class="small mt-1">--</div>
          <div class="flex gap-2 mt-2 flex-wrap">
            <span id="typePill" class="pill">--</span>
            <span id="tagPill" class="pill">--</span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- type specific blocks -->
      <div id="typeBlockSingle" class="hidden">
        <div class="h2 mb-1">單堂資訊</div>
        <div id="singleInfo" class="small">--</div>
      </div>

      <div id="typeBlockCohort" class="hidden">
        <div class="h2 mb-1">梯次資訊</div>
        <div id="cohortInfo" class="small">--</div>
        <div id="cohortSessions" class="small mt-2"></div>
      </div>

      <div id="typeBlockCamp" class="hidden">
        <div class="h2 mb-1">營隊資訊</div>
        <div id="campInfo" class="small">--</div>
        <div id="campDays" class="small mt-2"></div>
      </div>

      <div id="typeBlockAfterSchool" class="hidden">
        <div class="h2 mb-1">課後班資訊</div>
        <div id="afterInfo" class="small">--</div>
        <div id="afterSchedule" class="small mt-2"></div>
      </div>
    </div>

    <!-- attendee -->
    <div id="attendeeCard" class="card mb-3 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div class="h2">預約對象</div>
          <div id="attendeeName" class="h1 mt-1">--</div>
          <div id="attendeeMeta" class="small mt-1">--</div>
        </div>
        <button class="btn btn-ghost" onclick="openAttendeePicker()">更換</button>
      </div>
    </div>

    <!-- pricing -->
    <div id="priceCard" class="card mb-3 hidden">
      <div class="h2 mb-3">費用計算</div>

      <label class="flex items-center gap-3 p-3 rounded-2xl border" id="earlyWrap">
        <input id="earlyCheck" type="checkbox" class="w-5 h-5" />
        <div class="flex-1">
          <div class="font-black">使用早鳥價</div>
          <div id="earlyHint" class="small">--</div>
        </div>
        <div id="earlyPrice" class="font-black">$0</div>
      </label>

      <div class="divider"></div>

      <div class="grid grid-cols-2 gap-3">
        <div class="card" style="padding:12px;">
          <div class="small">課程單價</div>
          <div id="courseUnit" class="text-xl font-black">$0</div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="small">設備加總</div>
          <div id="eqTotal" class="text-xl font-black">$0</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="flex items-center justify-between">
        <div class="h2">小計金額</div>
        <div id="grandTotal" class="text-2xl font-black">$0</div>
      </div>
    </div>

    <!-- equipment -->
    <div id="eqCard" class="card mb-3 hidden">
      <div class="h2">租用設備</div>
      <div class="small mt-1">可選擇租用，系統會加總設備費用</div>
      <div id="eqList" class="mt-3 space-y-3"></div>
      <div id="eqEmpty" class="small mt-3 hidden">目前沒有可租用設備（請到 SYS 設定 equipment_list）</div>
    </div>

    <!-- note -->
    <div id="noteCard" class="card mb-3 hidden">
      <div class="h2 mb-2">備註</div>
      <textarea id="note" class="w-full border rounded-2xl p-3" rows="3" placeholder="如有特殊需求可填寫"></textarea>
    </div>

    <!-- fixed bottom -->
    <div class="fixed left-0 right-0 bottom-0 bg-white border-t" style="z-index:50;">
      <div class="max-w-[720px] mx-auto px-4 py-3">
        <button id="submitBtn" class="btn btn-main w-full text-lg" onclick="submitBooking()">確認送出預約</button>
      </div>
    </div>
  </div>

  <!-- attendee picker modal -->
  <div id="overlay" class="overlay" onclick="closeAttendeePicker()"></div>
  <div id="modal" class="modal">
    <div class="modal-h">
      <div class="h2">選擇報名對象</div>
      <button class="btn btn-ghost" style="padding:10px 12px;" onclick="closeAttendeePicker()">關閉</button>
    </div>
    <div class="modal-b">
      <div class="small mb-3">勾選後才會進行結算</div>
      <div id="attendeeList" class="space-y-3"></div>
      <button class="btn btn-main w-full mt-4" onclick="confirmAttendee()">確認選擇</button>
    </div>
  </div>

<script>
/* ========= 必填：你的 Worker API 與 LIFF ========= */
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID  = '2008786875-F7ifLsbN';

/* ========= URL params ========= */
const qp = new URL(location.href).searchParams;
const COURSE_ID = qp.get('id') || '';
const SHEET_NAME = qp.get('type') || 'SingleCourses';   // SingleCourses / CohortCourses / Camps / AfterSchoolClasses
const FROM = qp.get('from') || '';

/* ========= state ========= */
let lineUser = null;
let course = null;
let member = null;      // {status:'exists', data:{...}, families:[...]} or object
let config = null;

let attendeePicked = null;   // {role,name,gender,birthDate,memberId,lineUserId}
let equipmentList = [];      // [{name,price}]
let equipmentPicked = new Set();
let useEarly = false;

/* ========= utils ========= */
function goBack(){
  if (FROM) { location.href = FROM; return; }
  if (history.length > 1) { history.back(); return; }
  location.href = new URL('index.html', location.href).toString();
}
function showError(msg){
  const box = document.getElementById('errBox');
  box.classList.remove('hidden');
  const el = document.getElementById('errMsg');
  if (el) el.innerText = msg;
}
function hideError(){
  document.getElementById('errBox').classList.add('hidden');
}
function money(n){
  const v = Number(n||0);
  return '$' + (isNaN(v) ? 0 : v).toLocaleString('en-US');
}
function ymdToday(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd= String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function ymd(v){
  if (!v) return '';
  return String(v).split('T')[0];
}
function parseJsonSafe(v, fallback){
  try{
    if (v == null) return fallback;
    if (typeof v === 'object') return v;
    const s = String(v).trim();
    if (!s) return fallback;
    return JSON.parse(s);
  }catch(e){
    return fallback;
  }
}
function pickCoursePrice(){
  // 你 GAS/欄位可能是 memberPrice / priceEarly / priceOriginal / friendPrice…
  const memberPrice = Number(course.memberPrice ?? course["會員價"] ?? 0) || 0;
  const earlyPrice  = Number(course.priceEarly  ?? course["早鳥價"] ?? 0) || 0;
  const earlyDeadline = ymd(course.earlyDeadline ?? course["早鳥截止"] ?? '');
  const canEarly = earlyPrice > 0 && earlyDeadline && ymdToday() <= earlyDeadline;

  useEarly = !!document.getElementById('earlyCheck')?.checked;

  if (useEarly && canEarly) return earlyPrice;
  return memberPrice;
}
function calcEquipmentTotal(){
  let sum = 0;
  equipmentList.forEach(eq=>{
    if (equipmentPicked.has(eq.name)) sum += Number(eq.price||0);
  });
  return sum;
}
function renderTotals(){
  const unit = pickCoursePrice();
  const eq = calcEquipmentTotal();
  const total = unit + eq;

  document.getElementById('courseUnit').innerText = money(unit);
  document.getElementById('eqTotal').innerText = money(eq);
  document.getElementById('grandTotal').innerText = money(total);
}

/* ========= attendee picker ========= */
function openAttendeePicker(){
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('modal').style.display = 'block';
}
function closeAttendeePicker(){
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('modal').style.display = 'none';
}
function buildAttendeeOptions(){
  const u = member?.data || member || {};
  const families = member?.families || [];

  const opts = [];
  opts.push({
    role:'本人',
    name: u.name || '未填',
    gender: u.gender || '未填',
    birthDate: ymd(u.birthDate || u["出生日期"] || ''),
    grade: u.grade || '0',
    memberId: u.memberId || u["會員ID"] || '0',
    lineUserId: u.lineUserId || u["LINE UID"] || lineUser?.userId || '0'
  });

  families.forEach(f=>{
    opts.push({
      role:'成員',
      name: f.name || f["姓名"] || '0',
      gender: f.gender || f["性別"] || '未填',
      birthDate: ymd(f.birthDate || f["生日"] || f["出生日期"] || ''),
      grade: f.grade || f["目前年級"] || '0',
      memberId: u.memberId || u["會員ID"] || '0',
      lineUserId: u.lineUserId || u["LINE UID"] || lineUser?.userId || '0'
    });
  });

  // ✅ 修正你遇到「成員名字變 0」：強制 fallback
  opts.forEach(o=>{
    if (!o.name || o.name === '0') o.name = '(未填姓名)';
  });

  return opts;
}
function renderAttendeePicker(){
  const list = document.getElementById('attendeeList');
  const opts = buildAttendeeOptions();

  list.innerHTML = opts.map((o,idx)=>{
    const pill = o.role==='本人' ? 'pill pill-self' : 'pill pill-member';
    const checked = attendeePicked ? (attendeePicked.role===o.role && attendeePicked.name===o.name && attendeePicked.birthDate===o.birthDate) : idx===0;
    return `
      <label class="radioRow">
        <input type="radio" name="attendee" ${checked?'checked':''} data-idx="${idx}" class="mt-1 w-5 h-5"/>
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="${pill}">${o.role}</span>
            <div class="font-black text-lg">${o.name}</div>
          </div>
          <div class="small mt-1">性別：${o.gender}　生日：${o.birthDate||'--'}　年級：${o.grade||'0'}</div>
        </div>
      </label>
    `;
  }).join('');

  // 預設本人
  if (!attendeePicked) attendeePicked = opts[0];
}
function confirmAttendee(){
  const opts = buildAttendeeOptions();
  const checked = document.querySelector('input[name="attendee"]:checked');
  const idx = checked ? Number(checked.dataset.idx) : 0;
  attendeePicked = opts[idx] || opts[0];

  document.getElementById('attendeeName').innerText = attendeePicked.name;
  document.getElementById('attendeeMeta').innerText =
    `性別：${attendeePicked.gender}　生日：${attendeePicked.birthDate||'--'}　年級：${attendeePicked.grade||'0'}`;

  closeAttendeePicker();
  renderTotals();
}

/* ========= equipment ========= */
function renderEquipment(){
  const wrap = document.getElementById('eqList');
  const empty = document.getElementById('eqEmpty');

  if (!equipmentList || equipmentList.length === 0){
    empty.classList.remove('hidden');
    wrap.innerHTML = '';
    return;
  }

  empty.classList.add('hidden');

  wrap.innerHTML = equipmentList.map(eq=>{
    const checked = equipmentPicked.has(eq.name) ? 'checked' : '';
    return `
      <label class="flex items-center gap-3 p-4 rounded-2xl border cursor-pointer">
        <input type="checkbox" class="w-5 h-5" ${checked} onchange="toggleEq('${escapeHtml(eq.name)}', this.checked)"/>
        <div class="flex-1">
          <div class="font-black">${escapeHtml(eq.name)}</div>
          <div class="small">加價：${money(eq.price||0)}</div>
        </div>
      </label>
    `;
  }).join('');
}
function toggleEq(name, on){
  const real = unescapeHtml(name);
  if (on) equipmentPicked.add(real);
  else equipmentPicked.delete(real);
  renderTotals();
}
function escapeHtml(s){
  return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
}
function unescapeHtml(s){
  return String(s||'')
    .replaceAll('&lt;','<').replaceAll('&gt;','>')
    .replaceAll('&quot;','"').replaceAll('&#39;',"'").replaceAll('&amp;','&');
}

/* ========= type blocks ========= */
function showTypeBlock(){
  document.getElementById('typeBlockSingle').classList.add('hidden');
  document.getElementById('typeBlockCohort').classList.add('hidden');
  document.getElementById('typeBlockCamp').classList.add('hidden');
  document.getElementById('typeBlockAfterSchool').classList.add('hidden');

  const pill = document.getElementById('typePill');

  if (SHEET_NAME === 'SingleCourses'){
    pill.innerText = '單堂課程';
    document.getElementById('typeBlockSingle').classList.remove('hidden');
    document.getElementById('singleInfo').innerText =
      `日期：${ymd(course.courseDate||course["課程日期"])}　時間：${(course.startTime||course["開始時間"]||'--')} ~ ${(course.endTime||course["結束時間"]||'--')}`;
    return;
  }

  if (SHEET_NAME === 'CohortCourses'){
    pill.innerText = '梯次課程';
    document.getElementById('typeBlockCohort').classList.remove('hidden');
    document.getElementById('cohortInfo').innerText =
      `期間：${ymd(course.cohortStartDate||course["梯次開始日"])} ~ ${ymd(course.cohortEndDate||course["梯次結束日"])}　每週：${course.weekdays||course["每週上課日(例:二,四)"]||'--'}　時間：${course.startTime||course["開始時間"]||'--'} ~ ${course.endTime||course["結束時間"]||'--'}`;

    // 若你有做 CohortSessions：可改成呼叫 API 拉 sessions
    document.getElementById('cohortSessions').innerText = '（可選）可加上 CohortSessions 每堂日期時間列表';
    return;
  }

  if (SHEET_NAME === 'Camps'){
    pill.innerText = '營隊';
    document.getElementById('typeBlockCamp').classList.remove('hidden');
    document.getElementById('campInfo').innerText =
      `期間：${ymd(course.campStartDate||course["營隊開始日"])} ~ ${ymd(course.campEndDate||course["營隊結束日"])}　每日：${course.dayStartTime||course["每日開始時間"]||'--'} ~ ${course.dayEndTime||course["每日結束時間"]||'--'}　天數：${course.days||course["天數"]||'--'}`;
    document.getElementById('campDays').innerText = '（可選）可加上 CampDays 每日行程列表';
    return;
  }

  if (SHEET_NAME === 'AfterSchoolClasses'){
    pill.innerText = '課後班';
    document.getElementById('typeBlockAfterSchool').classList.remove('hidden');
    document.getElementById('afterInfo').innerText =
      `學期：${ymd(course.termStartDate||course["學期開始日"])} ~ ${ymd(course.termEndDate||course["學期結束日"])}　每週：${course.weekdays||course["每週上課日(例:一,三,五)"]||'--'}　時間：${course.startTime||course["開始時間"]||'--'} ~ ${course.endTime||course["結束時間"]||'--'}　繳費週期：${course.billingCycle||course["繳費週期(月/期)"]||'--'}`;
    document.getElementById('afterSchedule').innerText = '（可選）可加上 AfterSchoolSchedule 每週固定時段列表';
    return;
  }

  pill.innerText = SHEET_NAME;
}

/* ========= config ========= */
async function loadConfig(){
  // 期待你的 API：GET ?type=config  回 {status:'success', data: {equipment_list:{Global:'[...]'}}} 或你自己的格式
  const r = await fetch(`${API_URL}?type=config&_t=${Date.now()}`);
  const j = await r.json();

  // 兼容：j.data 可能是 {equipment_list:{Global:'[...]'}} 或直接是陣列
  const d = j?.data ?? j;

  // 找 equipment_list
  let raw = null;
  if (d?.equipment_list){
    raw = d.equipment_list.Global ?? d.equipment_list.global ?? d.equipment_list;
  } else if (d?.equipmentList){
    raw = d.equipmentList;
  }

  const arr = parseJsonSafe(raw, []);
  equipmentList = Array.isArray(arr) ? arr.map(x=>({name:x.name, price:Number(x.price||0)})) : [];
}

/* ========= init ========= */
async function init(){
  hideError();

  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
    lineUser = await liff.getProfile();

    // 1) config
    await loadConfig();

    // 2) booking_init: 一次拿 course + member
    const url = `${API_URL}?type=booking_init&lineUserId=${encodeURIComponent(lineUser.userId)}&sheet=${encodeURIComponent(SHEET_NAME)}&id=${encodeURIComponent(COURSE_ID)}&_t=${Date.now()}`;
    const res = await fetch(url);
    const raw = await res.json();
    const data = raw?.data ?? raw;

    course = data?.course || null;
    member = data?.member || null;

    if (!course) throw new Error(`找不到課程資料（course=null）`);
    if (!member || member.status === 'not_found') throw new Error(`找不到會員資料（member=not_found）`);

    // render base
    document.getElementById('courseCard').classList.remove('hidden');
    document.getElementById('attendeeCard').classList.remove('hidden');
    document.getElementById('priceCard').classList.remove('hidden');
    document.getElementById('eqCard').classList.remove('hidden');
    document.getElementById('noteCard').classList.remove('hidden');

    document.getElementById('coverImg').src = course.coverImage || course["封面圖片"] || 'https://via.placeholder.com/200';
    document.getElementById('courseName').innerText = course.courseName || course["課程名稱"] || course.cohortName || course["梯次名稱"] || course.campName || course["營隊名稱"] || course.className || course["班別名稱"] || '--';

    document.getElementById('tagPill').innerText = course.tags || course["標籤分類"] || '—';
    document.getElementById('courseMeta').innerText =
      `${course.venueArea||course["場地區域"]||''} ${course.venueName||course["場地名稱"]||''}`.trim() || '—';

    showTypeBlock();

    // early bird UI
    const earlyPrice = Number(course.priceEarly ?? course["早鳥價"] ?? 0) || 0;
    const earlyDeadline = ymd(course.earlyDeadline ?? course["早鳥截止"] ?? '');
    const canEarly = earlyPrice > 0 && earlyDeadline && ymdToday() <= earlyDeadline;

    document.getElementById('earlyWrap').style.display = canEarly ? 'flex' : 'none';
    document.getElementById('earlyHint').innerText = canEarly ? `截止：${earlyDeadline}` : '此課程無早鳥';
    document.getElementById('earlyPrice').innerText = money(earlyPrice);

    document.getElementById('earlyCheck').onchange = ()=>renderTotals();

    // attendee picker
    renderAttendeePicker();
    confirmAttendee(); // default select

    // equipment
    renderEquipment();

    // totals
    renderTotals();

  }catch(err){
    console.error(err);
    showError(String(err?.message || err));
  }
}

/* ========= submit ========= */
async function submitBooking(){
  if (!attendeePicked){
    openAttendeePicker();
    return;
  }
  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerText = '送出中...';

  try{
    const unit = pickCoursePrice();
    const eqFee = calcEquipmentTotal();
    const total = unit + eqFee;

    const rentText = [...equipmentPicked].join(',');

    const payload = {
      type: 'course_booking',
      sheet: SHEET_NAME,
      courseId: course.courseId || course["課程ID"] || course.cohortId || course["梯次ID"] || course.campId || course["營隊ID"] || course.afterId || course["課後班ID"] || COURSE_ID,

      lineUserId: attendeePicked.lineUserId || lineUser.userId,
      memberId: attendeePicked.memberId,

      attendeeRole: attendeePicked.role,
      attendeeName: attendeePicked.name,
      attendeeGender: attendeePicked.gender,
      attendeeBirthDate: attendeePicked.birthDate || '0',

      isEarlyBird: !!document.getElementById('earlyCheck')?.checked,
      price: unit,
      equipment: rentText,
      equipmentFee: eqFee,
      totalAmount: total,

      note: document.getElementById('note').value || ''
    };

    const r = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await r.json();

    if (j?.status !== 'success'){
      throw new Error(j?.message || '送出失敗');
    }

    alert('✅ 預約已建立');
    goBack();

  }catch(err){
    alert('❌ ' + (err?.message || err));
  }finally{
    btn.disabled = false;
    btn.innerText = '確認送出預約';
  }
}

init();
</script>
</body>
</html>
