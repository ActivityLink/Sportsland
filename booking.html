<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ActivityLink - æ´»å‹•é ç´„å ±å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --line-green: #06C755; --line-blue: #007AFF; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8F9FA; color: #1A1A1A; }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.7); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; max-height: 95vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .btn-green { background-color: var(--line-green); color: white; padding: 16px; border-radius: 14px; font-weight: 900; font-size: 18px; border: none; width: 100%; }
        .btn-outline { border: 2px solid #E9ECEF; color: #495057; padding: 14px; border-radius: 14px; font-weight: 700; background: white; }
        
        label { display: block; font-weight: 900; font-size: 15px; margin-bottom: 8px; color: #343A40; }
        input, select, textarea { width: 100%; background: #F1F3F5; border: 2px solid transparent; padding: 14px; border-radius: 12px; font-weight: 700; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--line-green); background: white; }

        .course-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #E9ECEF; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 1000px 100%; animation: shimmer 2s infinite linear; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    </style>
</head>
<body class="pb-24">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md px-5 py-4 flex items-center justify-between border-b">
        <div class="flex items-center gap-2">
            <div class="w-9 h-9 bg-[#06C755] rounded-xl flex items-center justify-center shadow-lg shadow-green-500/20">
                <i class="fas fa-comment-dots text-white"></i>
            </div>
            <h1 class="text-xl font-black tracking-tighter text-black">ActivityLink</h1>
        </div>
        <div class="flex items-center gap-4">
            <span id="conn-status" class="w-2 h-2 rounded-full bg-slate-300"></span>
            <i class="fas fa-user-circle text-2xl text-slate-300"></i>
        </div>
    </header>

    <main class="px-5 pt-6">
        <div class="mb-8">
            <h2 class="text-2xl font-black mb-2">æ¢ç´¢ç†±é–€æ´»å‹•</h2>
            <p class="text-slate-400 font-bold text-sm uppercase tracking-widest">Featured Activities</p>
        </div>

        <div id="course-list">
            <!-- é è¨­éª¨æ¶å± -->
            <div class="course-card p-4 space-y-4">
                <div class="aspect-video skeleton rounded-2xl"></div>
                <div class="h-6 skeleton rounded w-3/4"></div>
            </div>
        </div>
    </main>

    <!-- 1. è©³ç´°èªªæ˜ Modal -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="det-title" class="text-2xl font-black">èª²ç¨‹èªªæ˜</h3>
                <button onclick="closeModal('details-modal')" class="text-slate-300 text-3xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="det-body" class="space-y-8 pb-10">
                <!-- JS å…§å®¹ -->
            </div>
        </div>
    </div>

    <!-- 2. å¼·åŒ–ç‰ˆå ±åè¡¨å–® Modal -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black">å®Œå–„å ±åè³‡æ–™</h3>
                <button onclick="closeModal('booking-modal')" class="text-slate-300 text-3xl"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="booking-form" class="space-y-6 pb-12">
                <div class="p-4 bg-yellow-50 rounded-2xl border border-yellow-100 mb-2">
                    <p class="text-yellow-800 text-xs font-bold"><i class="fas fa-shield-alt mr-1"></i> è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ï¼Œä»¥ä¾¿ç‚ºæ‚¨è¾¦ç†æ´»å‹•ä¿éšªã€‚</p>
                </div>

                <!-- å­¸å“¡åŸºæœ¬è³‡æ–™ -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label>å­¸å“¡å§“å *</label><input type="text" id="u-name" required placeholder="è«‹è¼¸å…¥å§“å"></div>
                    <div><label>å­¸å“¡æ€§åˆ¥ *</label><select id="u-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                    <div><label>å‡ºç”Ÿæ—¥æœŸ *</label><input type="date" id="u-birth" required></div>
                </div>

                <div><label>è¯çµ¡é›»è©± *</label><input type="tel" id="u-phone" required placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼"></div>
                <div><label>èº«åˆ†è­‰å­—è™Ÿ/è­·ç…§ (ä¿éšªç”¨) *</label><input type="text" id="u-idcard" required placeholder="å­—æ¯éœ€å¤§å¯«"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label>ç·Šæ€¥è¯çµ¡äºº *</label><input type="text" id="u-em-name" required placeholder="å§“å"></div>
                    <div><label>ç·Šæ€¥è¯çµ¡é›»è©± *</label><input type="tel" id="u-em-phone" required placeholder="æ‰‹æ©Ÿ"></div>
                </div>

                <div id="rental-section" class="hidden">
                    <label>åŠ è³¼ç§Ÿå€Ÿè¨­å‚™</label>
                    <div id="equipment-list" class="space-y-3"></div>
                </div>

                <div><label>å¥åº·ç‹€æ³æˆ–å‚™è¨»</label><textarea id="u-notes" rows="3" placeholder="éæ•åŸæˆ–ç‰¹æ®Šè¦æ±‚..."></textarea></div>

                <div class="bg-slate-900 p-6 rounded-2xl text-white shadow-xl">
                    <div class="flex justify-between mb-2 text-slate-400 text-sm font-bold">
                        <span>é ç´„èª²ç¨‹</span>
                        <span id="summary-course">-</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-800">
                        <span class="font-bold">æ‡‰ä»˜ç¸½é¡</span>
                        <span id="summary-total" class="text-3xl font-black text-[#06C755] font-mono">$0</span>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="btn-green shadow-xl shadow-green-100">
                    ç¢ºèªé€å‡ºä¸¦å®Œæˆé ç´„
                </button>
            </form>
        </div>
    </div>

    <!-- åº•éƒ¨å°è¦½ -->
    <footer class="fixed bottom-0 left-0 w-full bg-white border-t px-8 py-4 flex justify-between items-center z-50">
        <button class="text-[#06C755] flex flex-col items-center gap-1"><i class="fas fa-home text-2xl"></i><span class="text-[10px] font-bold">é¦–é </span></button>
        <button class="text-slate-300 flex flex-col items-center gap-1"><i class="fas fa-calendar-check text-2xl"></i><span class="text-[10px] font-bold">é ç´„</span></button>
        <button class="text-slate-300 flex flex-col items-center gap-1"><i class="fas fa-user text-2xl"></i><span class="text-[10px] font-bold">æœƒå“¡</span></button>
    </footer>

    <script>
        const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
        let courses = [], globalEquips = [], currentCourse = null;

        async function init() {
            try {
                // 1. åŒæ­¥åƒæ•¸è¨­å®š
                const confRes = await fetch(`${API_URL}?type=config&_t=${Date.now()}`);
                const confData = await confRes.json();
                const configRows = confData.data || confData.config || [];
                const equipRow = configRows.find(r => (r.type === 'equipment_list' || (Array.isArray(r) && r[0] === 'equipment_list')));
                if (equipRow) {
                    const optionsStr = equipRow.options || (Array.isArray(equipRow) ? equipRow[2] : '');
                    globalEquips = optionsStr ? JSON.parse(optionsStr) : [];
                }

                // 2. æŠ“å–èª²ç¨‹
                const res = await fetch(API_URL);
                const result = await res.json();
                courses = result.data || [];
                renderCourses();
                
                document.getElementById('conn-status').classList.replace('bg-slate-300', 'bg-green-500');
            } catch (e) {
                console.error("Init error", e);
                document.getElementById('course-list').innerHTML = '<p class="text-center py-20 font-bold text-red-500">é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            }
        }

        function renderCourses() {
            const container = document.getElementById('course-list');
            if (courses.length === 0) {
                container.innerHTML = '<p class="text-center py-20 font-bold text-slate-400">ç›®å‰æš«ç„¡é–‹æ”¾ä¸­çš„æ´»å‹•</p>';
                return;
            }

            container.innerHTML = courses.map(c => {
                // ä¿®å¾©æˆªæ–·çš„èªæ³•
                const dateStr = c.courseDate ? c.courseDate.split('T')[0] : 'æ—¥æœŸæœªå®š';
                
                return `
                <div class="course-card">
                    <div class="relative aspect-video">
                        <img src="${c.coverImage || 'https://images.unsplash.com/photo-1546519638-68e109498ffc?w=800'}" class="w-full h-full object-cover">
                        <div class="absolute top-4 left-4 bg-black/70 text-white text-[10px] font-black px-3 py-1.5 rounded-lg uppercase tracking-widest backdrop-blur-md">
                            ${c.category || 'æ´»å‹•'}
                        </div>
                    </div>
                    <div class="p-6">
                        <h4 class="text-xl font-black mb-2 text-slate-800 leading-tight">${c.courseName}</h4>
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex flex-col gap-1">
                                <span class="text-sm font-bold text-slate-500"><i class="far fa-calendar-alt mr-1 text-[#06C755]"></i> ${dateStr}</span>
                                <span class="text-sm font-bold text-slate-500"><i class="fas fa-map-marker-alt mr-1 text-[#06C755]"></i> ${c.venueName || 'æ´»å‹•å ´åœ°'}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-[#06C755] font-mono leading-none">$${c.memberPrice || 0}</div>
                                <div class="text-[10px] font-black text-slate-300 uppercase mt-1 tracking-widest">Member Price</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="showDetails('${c.courseId}')" class="btn-outline">è©³ç´°èªªæ˜</button>
                            <button onclick="showBooking('${c.courseId}')" class="btn-green shadow-lg shadow-green-100">ç«‹å³é ç´„</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function showDetails(id) {
            const c = courses.find(item => item.courseId === id);
            if (!c) return;
            document.getElementById('det-title').innerText = c.courseName;
            document.getElementById('det-body').innerHTML = `
                <div class="p-5 bg-green-50 rounded-2xl border-l-4 border-[#06C755]">
                    <h5 class="font-black text-green-700 mb-1">æ´»å‹•äº®é»</h5>
                    <p class="font-bold text-green-800 text-sm leading-relaxed">${c.highlights || 'ç²¾ç·»æ•™å­¸ã€å°ˆæ¥­æ•™ç·´æŒ‡å°'}</p>
                </div>
                <div>
                    <h5 class="font-black text-lg mb-3 flex items-center gap-2"><i class="fas fa-info-circle text-[#06C755]"></i> èª²ç¨‹è©³ç´°å…§å®¹</h5>
                    <p class="font-bold text-slate-600 leading-relaxed whitespace-pre-line">${c.content || 'æš«ç„¡è©³ç´°å…§å®¹ä»‹ç´¹'}</p>
                </div>
                <div class="pt-6 border-t">
                    <h5 class="font-black text-lg mb-3 text-red-500 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> æ³¨æ„äº‹é …</h5>
                    <p class="font-bold text-slate-500 text-sm leading-relaxed">${c.notes || 'è«‹æº–æ™‚å ±åˆ°ä¸¦ç©¿è‘—é‹å‹•æœè£'}</p>
                </div>
            `;
            document.getElementById('details-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function showBooking(id) {
            currentCourse = courses.find(item => item.courseId === id);
            if (!currentCourse) return;

            document.getElementById('summary-course').innerText = currentCourse.courseName;
            
            const container = document.getElementById('equipment-list');
            const allowedNames = (currentCourse.selectedEquipment || '').split(',').map(s => s.trim());
            const filteredEquips = globalEquips.filter(eq => allowedNames.includes(eq.name));

            if (filteredEquips.length > 0) {
                document.getElementById('rental-section').classList.remove('hidden');
                container.innerHTML = filteredEquips.map(eq => `
                    <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer border-2 border-transparent active:border-green-500 transition-all">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" name="eq_check" value="${eq.price}" data-name="${eq.name}" onchange="calcTotal()" class="w-6 h-6 rounded accent-green-600">
                            <span class="font-black text-slate-700">${eq.name}</span>
                        </div>
                        <span class="font-black text-blue-600">+$${eq.price}</span>
                    </label>
                `).join('');
            } else {
                document.getElementById('rental-section').classList.add('hidden');
            }

            calcTotal();
            document.getElementById('booking-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function calcTotal() {
            let total = parseInt(currentCourse.memberPrice) || 0;
            document.querySelectorAll('input[name="eq_check"]:checked').forEach(cb => {
                total += parseInt(cb.value);
            });
            document.getElementById('summary-total').innerText = '$' + total;
        }

        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "å‚³é€é ç´„ä¸­...";

            const selectedEquips = Array.from(document.querySelectorAll('input[name="eq_check"]:checked')).map(cb => cb.getAttribute('data-name'));

            const payload = {
                type: 'booking_submit',
                courseId: currentCourse.courseId,
                courseName: currentCourse.courseName,
                name: document.getElementById('u-name').value,
                gender: document.getElementById('u-gender').value,
                birth: document.getElementById('u-birth').value,
                phone: document.getElementById('u-phone').value,
                idCard: document.getElementById('u-idcard').value,
                emergencyName: document.getElementById('u-em-name').value,
                emergencyPhone: document.getElementById('u-em-phone').value,
                equipment: selectedEquips.join(','),
                remarks: document.getElementById('u-notes').value,
                total: document.getElementById('summary-total').innerText
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.status === "success") {
                    alert("ğŸ‰ é ç´„æˆåŠŸï¼æˆ‘å€‘å°‡ç›¡å¿«èˆ‡æ‚¨è¯çµ¡ã€‚");
                    location.reload();
                } else {
                    throw new Error(result.message);
                }
            } catch (err) {
                alert("âŒ é ç´„å¤±æ•—ï¼š" + err.message);
                btn.disabled = false; btn.innerText = originalText;
            }
        };

        function closeModal(id) { document.getElementById(id).style.display = 'none'; document.body.style.overflow = 'auto'; }

        window.onload = init;
    </script>
</body>
</html>
