<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>課程預約</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --line:#06C755;
      --text:#111;
      --muted:#64748B;
      --bg:#F6F8FB;
      --card:#fff;
      --border:#E5E7EB;
    }
    body{ background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Arial; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; }
    .btn{ border-radius:14px; padding:14px 16px; font-weight:700; }
    .btn-line{ background:var(--line); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--border); color:#111; }
    .t-title{ font-size:18px; font-weight:800; }
    .t-sub{ font-size:14px; font-weight:500; color:var(--muted); }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:#111; font-weight:700; }
    .err{ background:#FEF2F2; border:1px solid #FECACA; color:#991B1B; }
    .ok{ background:#ECFDF5; border:1px solid #BBF7D0; color:#065F46; }
  </style>
</head>

<body class="min-h-screen flex justify-center">
  <div class="w-full max-w-[720px] px-4 py-4">

    <!-- topbar -->
    <div class="flex items-center gap-3 mb-4">
      <button id="btnBack" class="btn btn-ghost flex items-center gap-2" onclick="goBack()">
        ← 返回
      </button>
      <div class="flex-1 text-center">
        <div class="t-title">課程預約</div>
      </div>
      <div class="w-[86px]"></div>
    </div>

    <!-- loading -->
    <div id="loading" class="card p-4 mb-4">
      <div class="flex items-center gap-3">
        <div class="w-5 h-5 rounded-full border-2 border-slate-300 border-t-transparent animate-spin"></div>
        <div class="t-sub">正在載入課程與會員資料…</div>
      </div>
    </div>

    <!-- error box -->
    <div id="errorBox" class="card p-4 mb-4 hidden err">
      <div class="font-extrabold mb-1">載入失敗</div>
      <div id="errorMsg" class="text-sm whitespace-pre-wrap">---</div>
      <button class="btn btn-ghost mt-3" onclick="init()">重新載入</button>
    </div>

    <!-- course card -->
    <div id="courseCard" class="card p-4 mb-4 hidden">
      <div class="flex gap-3">
        <img id="courseCover" class="w-20 h-20 rounded-xl object-cover bg-slate-100" alt="" />
        <div class="flex-1">
          <div id="courseName" class="t-title">--</div>
          <div class="t-sub mt-1">
            <span id="courseDate">--</span>
            <span class="mx-2">|</span>
            <span id="courseTime">--</span>
          </div>
          <div class="mt-2 flex flex-wrap gap-2">
            <span id="pillSport" class="pill hidden"></span>
            <span id="pillTag" class="pill hidden"></span>
            <span id="pillVenue" class="pill hidden"></span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="card p-3">
          <div class="t-sub">會員價</div>
          <div id="memberPrice" class="text-2xl font-black">$0</div>
        </div>
        <div class="card p-3">
          <div class="t-sub">早鳥價</div>
          <div id="earlyPrice" class="text-2xl font-black">$0</div>
        </div>
      </div>
    </div>

    <!-- attendee -->
    <div id="attendeeCard" class="card p-4 mb-4 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div class="t-title">預約對象</div>
          <div class="t-sub mt-1" id="attendeeMeta">--</div>
        </div>
        <button class="btn btn-ghost" onclick="openAttendeeModal()">更換</button>
      </div>
    </div>

    <!-- options -->
    <div id="optionCard" class="card p-4 mb-4 hidden">
      <div class="t-title mb-2">費用選項</div>

      <label class="flex items-start gap-3 p-3 rounded-xl border border-slate-200 bg-white">
        <input id="chkEarly" type="checkbox" class="mt-1 w-5 h-5" />
        <div class="flex-1">
          <div class="font-extrabold">使用早鳥價</div>
          <div id="earlyHint" class="t-sub">若符合早鳥截止日，才可勾選</div>
        </div>
      </label>

      <div class="mt-4">
        <div class="t-title mb-2">租用設備</div>
        <div class="t-sub mb-3">可選擇租用，系統會加總設備費用</div>
        <div id="eqWrap" class="space-y-3"></div>
        <div id="eqEmpty" class="t-sub hidden">目前沒有可租用設備（請到 SYS 設定 equipment_list）</div>
      </div>

      <div class="mt-4">
        <div class="t-title mb-2">備註</div>
        <textarea id="note" class="w-full p-3 rounded-xl border border-slate-200 bg-white outline-none" rows="3" placeholder="如需備註請填寫"></textarea>
      </div>
    </div>

    <!-- total -->
    <div id="totalCard" class="card p-4 mb-6 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div class="t-sub">送出前結算金額</div>
          <div id="totalText" class="text-3xl font-black">$0</div>
        </div>
        <div class="text-right t-sub" id="totalBreakdown">--</div>
      </div>
    </div>

    <button id="btnSubmit" class="btn btn-line w-full hidden" onclick="submitBooking()">
      確認送出預約
    </button>

  </div>

  <!-- attendee modal -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-end justify-center z-50">
    <div class="w-full max-w-[720px] bg-white rounded-t-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="t-title">選擇報名對象</div>
        <button class="btn btn-ghost py-2 px-3" onclick="closeAttendeeModal()">關閉</button>
      </div>
      <div id="modalList" class="space-y-2"></div>
      <button class="btn btn-line w-full mt-4" onclick="confirmAttendee()">確認</button>
    </div>
  </div>

<script>
  // ✅ 這裡填你的 Worker URL
  const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
  const LIFF_ID = '2008786875-F7ifLsbN';

  const qs = new URLSearchParams(location.search);
  const courseId = qs.get('id') || '';
  const sheetName = qs.get('type') || qs.get('sheet') || 'SingleCourses'; // 你用 type 當 sheet
  const from = qs.get('from') || '';

  let lineUser = null;
  let member = null;          // {status, data, families}
  let course = null;          // course obj
  let config = null;          // { equipment_list: {Global: 'json'} ... }

  let attendee = null;        // {role,name,gender,birthDate,memberId}
  let equipmentList = [];     // [{name,price}]
  let equipmentSelected = new Set();

  function goBack(){
    if (from) { location.href = new URL(from, location.href).toString(); return; }
    if (history.length > 1) { history.back(); return; }
    location.href = 'index.html';
  }

  function show(elId, yes){
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.toggle('hidden', !yes);
  }

  function showError(msg){
    show('loading', false);
    show('courseCard', false);
    show('attendeeCard', false);
    show('optionCard', false);
    show('totalCard', false);
    show('btnSubmit', false);

    show('errorBox', true);
    const m = document.getElementById('errorMsg');
    if (m) m.textContent = msg || '未知錯誤';
  }

  function money(n){
    const v = Number(n || 0);
    return '$' + (isFinite(v) ? v.toLocaleString('en-US') : '0');
  }

  function parseJSONSafe(s){
    try { return JSON.parse(s); } catch(e){ return null; }
  }

  function ymdToday(){
    // 以本地日期避免少一天
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function isEarlyBirdAvailable(){
    const early = Number(course?.priceEarly || 0);
    const ddl = String(course?.earlyDeadline || '').slice(0,10);
    if (!early || early <= 0) return false;
    if (!ddl || ddl === '0') return false;
    return ymdToday() <= ddl;
  }

  function getBasePrice(){
    const memberP = Number(course?.memberPrice || 0);
    const earlyP = Number(course?.priceEarly || 0);
    const useEarly = document.getElementById('chkEarly')?.checked;
    if (useEarly && isEarlyBirdAvailable()) return earlyP || memberP || 0;
    return memberP || 0;
  }

  function getEquipTotal(){
    let sum = 0;
    equipmentList.forEach(eq => {
      if (equipmentSelected.has(eq.name)) sum += Number(eq.price || 0);
    });
    return sum;
  }

  function refreshTotal(){
    if (!course || !attendee) return;

    const base = getBasePrice();
    const eqSum = getEquipTotal();
    const total = base + eqSum;

    document.getElementById('totalText').textContent = money(total);
    document.getElementById('totalBreakdown').textContent =
      `課程：${money(base)}\n設備：${money(eqSum)}`;
  }

  function renderCourse(){
    const cover = course?.coverImage || '';
    document.getElementById('courseCover').src = cover || 'https://dummyimage.com/160x160/e2e8f0/64748b.png&text=Course';
    document.getElementById('courseName').textContent = course?.courseName || '--';

    const date = (course?.courseDate || '').slice(0,10) || '--';
    const st = (course?.startTime || '--');
    const et = (course?.endTime || '--');
    document.getElementById('courseDate').textContent = `日期：${date}`;
    document.getElementById('courseTime').textContent = `時間：${st}-${et}`;

    const sport = course?.sportCategory || '';
    const tag = course?.tags || '';
    const venue = course?.venueName || course?.venueArea || '';

    const pillSport = document.getElementById('pillSport');
    const pillTag = document.getElementById('pillTag');
    const pillVenue = document.getElementById('pillVenue');

    if (sport){ pillSport.textContent = sport; pillSport.classList.remove('hidden'); } else pillSport.classList.add('hidden');
    if (tag){ pillTag.textContent = tag; pillTag.classList.remove('hidden'); } else pillTag.classList.add('hidden');
    if (venue){ pillVenue.textContent = venue; pillVenue.classList.remove('hidden'); } else pillVenue.classList.add('hidden');

    document.getElementById('memberPrice').textContent = money(course?.memberPrice || 0);
    document.getElementById('earlyPrice').textContent = money(course?.priceEarly || 0);

    // early checkbox
    const chk = document.getElementById('chkEarly');
    const hint = document.getElementById('earlyHint');
    const ddl = String(course?.earlyDeadline || '').slice(0,10);

    if (isEarlyBirdAvailable()){
      chk.disabled = false;
      hint.textContent = ddl ? `早鳥截止：${ddl}（符合才可用）` : `符合早鳥條件才可用`;
    } else {
      chk.checked = false;
      chk.disabled = true;
      hint.textContent = ddl ? `早鳥截止：${ddl}（已不符合）` : `未設定早鳥或不符合`;
    }

    chk.addEventListener('change', refreshTotal);
  }

  function renderAttendee(){
    const a = attendee;
    const bd = (a.birthDate || '').slice(0,10);
    document.getElementById('attendeeMeta').textContent =
      `${a.role}：${a.name}　性別：${a.gender || '未填'}　生日：${bd || '未填'}　年級：${a.grade || ''}`.trim();
  }

  function renderEquipments(){
    const wrap = document.getElementById('eqWrap');
    const empty = document.getElementById('eqEmpty');

    if (!equipmentList || equipmentList.length === 0){
      wrap.innerHTML = '';
      empty.classList.remove('hidden');
      refreshTotal();
      return;
    }
    empty.classList.add('hidden');

    // 若課程有 rentEquipment（允許清單），則只顯示允許的
    const allowStr = String(course?.rentEquipment || '').trim();
    let allowed = null;
    if (allowStr && allowStr !== '0') {
      allowed = new Set(allowStr.split(/[,，、\s]+/).map(s=>s.trim()).filter(Boolean));
    }

    const view = allowed ? equipmentList.filter(e => allowed.has(e.name)) : equipmentList;

    if (view.length === 0){
      wrap.innerHTML = '';
      empty.textContent = '此課程未開放租用設備';
      empty.classList.remove('hidden');
      refreshTotal();
      return;
    }

    wrap.innerHTML = view.map(eq => {
      const checked = equipmentSelected.has(eq.name) ? 'checked' : '';
      return `
        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 bg-white">
          <input type="checkbox" class="w-5 h-5" data-eq="${eq.name}" ${checked}/>
          <div class="flex-1">
            <div class="font-extrabold">${eq.name}</div>
            <div class="t-sub">加價：${money(eq.price || 0)}</div>
          </div>
        </label>
      `;
    }).join('');

    wrap.querySelectorAll('input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', (ev)=>{
        const name = ev.target.getAttribute('data-eq');
        if (!name) return;
        if (ev.target.checked) equipmentSelected.add(name);
        else equipmentSelected.delete(name);
        refreshTotal();
      });
    });

    refreshTotal();
  }

  function openAttendeeModal(){
    const modal = document.getElementById('modal');
    const list = document.getElementById('modalList');
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    const items = [];
    const u = member?.data || {};
    items.push({ role:'本人', name: u.name || '未填', gender: u.gender || '未填', birthDate: u.birthDate || '0', grade: u.grade || '', memberId: u.memberId || '0' });

    (member?.families || []).forEach(f=>{
      items.push({ role:'成員', name: f.name || '未填', gender: f.gender || '未填', birthDate: f.birthDate || '0', grade: f.grade || '', memberId: u.memberId || '0' });
    });

    const currentKey = attendee ? `${attendee.role}|${attendee.name}|${attendee.birthDate}` : '';

    list.innerHTML = items.map((it, idx)=>{
      const key = `${it.role}|${it.name}|${it.birthDate}`;
      const checked = (key === currentKey) ? 'checked' : '';
      return `
        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 bg-white">
          <input type="radio" name="att" value="${idx}" class="w-5 h-5" ${checked}/>
          <div class="flex-1">
            <div class="font-extrabold">${it.role}：${it.name}</div>
            <div class="t-sub">性別：${it.gender}　生日：${String(it.birthDate||'').slice(0,10)}　年級：${it.grade || ''}</div>
          </div>
        </label>
      `;
    }).join('');

    window.__att_items = items;
  }

  function closeAttendeeModal(){
    const modal = document.getElementById('modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function confirmAttendee(){
    const checked = document.querySelector('input[name=att]:checked');
    if (!checked) { alert('請先選擇一位報名對象'); return; }
    const idx = Number(checked.value);
    const items = window.__att_items || [];
    attendee = items[idx] || items[0];
    renderAttendee();
    closeAttendeeModal();
    refreshTotal();
  }

  async function apiGet(url){
    const res = await fetch(url, { headers: { 'Accept':'application/json' }});
    const json = await res.json();
    return json;
  }

  async function loadConfig(){
    const cfgRes = await apiGet(`${API_URL}?type=config&_t=${Date.now()}`);
    if (cfgRes?.status !== 'success') return null;
    return cfgRes.data || null;
  }

  function extractEquipmentList(cfg){
    // cfg = { equipment_list: { Global: '[{"name":"籃球","price":100}]' } }
    const raw = cfg?.equipment_list?.Global ?? cfg?.equipment?.Global ?? null;
    if (!raw) return [];
    const parsed = (typeof raw === 'string') ? parseJSONSafe(raw) : raw;
    if (!Array.isArray(parsed)) return [];
    return parsed.map(x => ({
      name: String(x.name || '').trim(),
      price: Number(x.price || 0)
    })).filter(x => x.name);
  }

  async function loadBookingInit(){
    // ✅ 正確呼叫：type=booking_init + sheet=SingleCourses + id=...
    const url = `${API_URL}?type=booking_init&sheet=${encodeURIComponent(sheetName)}&id=${encodeURIComponent(courseId)}&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`;
    return await apiGet(url);
  }

  async function loadCourseFallback(){
    // fallback：fetch_courses + id filter
    const url = `${API_URL}?type=fetch_courses&sheet=${encodeURIComponent(sheetName)}&id=${encodeURIComponent(courseId)}&_t=${Date.now()}`;
    const r = await apiGet(url);
    if (r?.status === 'success' && Array.isArray(r.data) && r.data.length > 0) return r.data[0];
    return null;
  }

  async function loadMemberFallback(){
    const url = `${API_URL}?type=member_check&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`;
    const r = await apiGet(url);
    if (r?.status === 'exists') return { status:'exists', data:r.data, families:r.families || [] };
    return { status:'not_found' };
  }

  async function submitBooking(){
    if (!course) { alert('找不到課程資料'); return; }
    if (!attendee) { alert('請先選擇報名對象'); return; }
    if (!member?.data?.memberId) { alert('會員資料缺失，請先到會員中心完成註冊'); return; }

    const btn = document.getElementById('btnSubmit');
    btn.disabled = true;
    btn.textContent = '送出中…';

    const base = getBasePrice();
    const eqSum = getEquipTotal();
    const total = base + eqSum;

    const rent = Array.from(equipmentSelected);

    const payload = {
      type: 'course_booking',
      sheet: sheetName,
      courseId: course.courseId || courseId,
      lineUserId: lineUser.userId,
      memberId: member.data.memberId,

      attendeeRole: attendee.role,
      attendeeName: attendee.name,
      attendeeGender: attendee.gender,
      attendeeBirthDate: attendee.birthDate,
      price: total,
      rentEquipment: rent,
      note: (document.getElementById('note').value || '').trim(),
    };

    try {
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j?.status === 'success') {
        alert('✅ 已建立預約：' + (j.bookingId || ''));
        goBack();
      } else {
        alert('❌ 預約失敗：' + (j?.message || '未知錯誤'));
      }
    } catch (e){
      alert('❌ 雲端連線失敗');
    } finally {
      btn.disabled = false;
      btn.textContent = '確認送出預約';
    }
  }

  async function init(){
    show('errorBox', false);
    show('loading', true);

    if (!courseId) {
      showError('缺少課程 id');
      return;
    }

    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()){
        const cleanUrl = location.origin + location.pathname + location.search;
        liff.login({ redirectUri: cleanUrl });
        return;
      }
      lineUser = await liff.getProfile();

      // 1) booking_init
      const initRes = await loadBookingInit();
      const courseFromInit = initRes?.data?.course || null;
      const memberFromInit = initRes?.data?.member || null;

      course = courseFromInit;
      member = memberFromInit;

      // 2) fallback（避免 course=null）
      if (!course) course = await loadCourseFallback();
      if (!member || member.status !== 'exists') member = await loadMemberFallback();

      if (!course) {
        showError(`找不到課程資料（course=null）\n\n檢查：\n1) courseId 是否存在於 ${sheetName}\n2) 課程表頭是否為「課程ID」或 A欄\n3) 你點預約時傳入的 id 是否正確\n\n目前 id=${courseId}`);
        return;
      }

      // config
      config = await loadConfig();
      equipmentList = extractEquipmentList(config || {});
      equipmentSelected = new Set();

      // attendee default
      if (member?.status === 'exists') {
        const u = member.data || {};
        attendee = { role:'本人', name:u.name||'未填', gender:u.gender||'未填', birthDate:u.birthDate||'0', grade:u.grade||'', memberId:u.memberId||'0' };
      } else {
        attendee = { role:'本人', name:'未註冊', gender:'未填', birthDate:'0', grade:'', memberId:'0' };
      }

      // render
      renderCourse();
      renderAttendee();
      renderEquipments();

      show('loading', false);
      show('courseCard', true);
      show('attendeeCard', true);
      show('optionCard', true);
      show('totalCard', true);
      show('btnSubmit', true);
      refreshTotal();

    } catch (err) {
      showError(String(err));
    }
  }

  init();
</script>
</body>
</html>
