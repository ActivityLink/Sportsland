<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityLink - èª²ç¨‹é ç´„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --line-green: #06C755; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFF; color: #000; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.7); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; max-height: 95vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .btn-green { background-color: var(--line-green); color: white; padding: 16px; border-radius: 12px; font-weight: 900; }
        input, select, textarea { width: 100%; background: #F8F9FA; border: 2px solid #F1F3F5; padding: 14px; border-radius: 12px; font-weight: 700; outline: none; }
        input:focus { border-color: var(--line-green); background: white; }
    </style>
</head>
<body class="pb-28">

    <header class="sticky top-0 z-50 bg-white px-5 py-4 flex items-center justify-between border-b-2">
        <div class="flex items-center gap-2"><div class="w-9 h-9 bg-[#06C755] rounded-lg flex items-center justify-center"><i class="fas fa-comment-dots text-white text-lg"></i></div><h1 class="text-2xl font-black">ActivityLink</h1></div>
        <button class="text-black text-xl"><i class="fas fa-user-circle"></i></button>
    </header>

    <div class="w-full"><img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" class="w-full h-auto" alt="Banner"></div>

    <div class="w-full bg-blue-600 flex divide-x divide-blue-500 shadow-md">
        <button class="flex-1 py-4 text-white font-bold">æ´»å‹•å°ˆå€</button>
        <button class="flex-1 py-4 text-white font-bold">æœƒå“¡å°ˆå€</button>
    </div>

    <main class="px-5 mt-8">
        <h3 class="text-2xl font-black mb-8">ç²¾é¸æ´»å‹•</h3>
        <div id="course-container" class="space-y-12"></div>
    </main>

    <!-- 1. è©³ç´°èªªæ˜ Modal -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h4 id="det-title" class="text-2xl font-black">èª²ç¨‹èªªæ˜</h4><button onclick="closeMod('details-modal')"><i class="fas fa-times text-gray-300 text-3xl"></i></button></div>
            <div id="det-body" class="space-y-6 pb-10"></div>
        </div>
    </div>

    <!-- 2. é ç´„è¡¨å–® Modal -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h4 class="text-2xl font-black">å¡«å¯«å ±åè¡¨</h4><button onclick="closeMod('booking-modal')"><i class="fas fa-times text-gray-300 text-3xl"></i></button></div>
            <form id="book-form" class="space-y-6 pb-12">
                <div><label class="block font-black mb-2">å§“å *</label><input type="text" id="u-name" required></div>
                <div><label class="block font-black mb-2">é›»è©± *</label><input type="tel" id="u-phone" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block font-black mb-2">æ€§åˆ¥</label><select id="u-gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                    <div><label class="block font-black mb-2">å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="u-birth"></div>
                </div>
                
                <div id="extra-params" class="space-y-6"></div> <!-- ç”±ç³»çµ±è¨­å®šå‹•æ…‹ç”¢ç”Ÿ -->

                <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-100">
                    <div class="flex justify-between mb-2"><span class="font-bold text-blue-800">æ´»å‹•é …ç›®</span><span id="b-c-name" class="font-black text-right"></span></div>
                    <div class="flex justify-between items-center"><span class="font-bold text-blue-800 text-lg">çµå¸³ç¸½é¡</span><span id="b-total" class="font-black text-3xl text-[#06C755] font-mono">$0</span></div>
                </div>
                <button type="submit" id="sub-btn" class="w-full btn-green shadow-xl text-xl py-5">ç¢ºèªé€å‡ºä¸¦é ç´„</button>
            </form>
        </div>
    </div>

    <script>
        const CLOUDFLARE_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
        let allCourses = [], setupConfig = [], currentCourse = null;

        async function init() {
            const [cRes, sRes] = await Promise.all([fetch(CLOUDFLARE_URL), fetch(CLOUDFURL + '?type=config')]);
            allCourses = (await cRes.json()).data || [];
            setupConfig = (await sRes.json()).config || [];
            render();
        }

        function render() {
            document.getElementById('course-container').innerHTML = allCourses.map(c => `
                <div class="course-card">
                    <div class="aspect-[16/9] rounded-3xl overflow-hidden shadow-lg mb-5"><img src="${c['å°é¢åœ–ç‰‡']}" class="w-full h-full object-cover"></div>
                    <h4 class="text-xl font-black mb-2">${c['èª²ç¨‹åç¨±']}</h4>
                    <div class="flex justify-between items-center mb-6">
                        <span class="font-bold text-gray-600"><i class="far fa-calendar-alt text-[#06C755] mr-1"></i>${c['èª²ç¨‹æ—¥æœŸ']}</span>
                        <span class="text-[#06C755] font-black text-2xl font-mono">$${c['æœƒå“¡åƒ¹']}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="showDet('${c['èª²ç¨‹ID']}')" class="border-2 border-gray-100 py-3 rounded-xl font-bold">è©³ç´°èªªæ˜</button>
                        <button onclick="showBook('${c['èª²ç¨‹ID']}')" class="btn-green shadow-lg">ç«‹å³é ç´„</button>
                    </div>
                </div>`).join('');
        }

        function showDet(id) {
            const c = allCourses.find(x => x['èª²ç¨‹ID'] === id);
            document.getElementById('det-title').innerText = c['èª²ç¨‹åç¨±'];
            document.getElementById('det-body').innerHTML = `
                <div class="p-4 bg-green-50 rounded-xl font-bold text-green-700 mb-6">${c['èª²ç¨‹äº®é»']}</div>
                <div class="space-y-4 font-bold text-gray-700 leading-relaxed">${c['èª²ç¨‹å…§å®¹']}</div>
                <div class="mt-10 pt-6 border-t font-bold text-red-500">æ³¨æ„äº‹é …ï¼š<br>${c['æ³¨æ„äº‹é …']}</div>`;
            document.getElementById('details-modal').style.display = 'flex';
        }

        function showBook(id) {
            currentCourse = allCourses.find(x => x['èª²ç¨‹ID'] === id);
            document.getElementById('b-c-name').innerText = currentCourse['èª²ç¨‹åç¨±'];
            document.getElementById('b-total').innerText = '$' + currentCourse['æœƒå“¡åƒ¹'];
            
            // ç”¢ç”Ÿå‹•æ…‹é¸å–® (ä¾†è‡ª Setup)
            document.getElementById('extra-params').innerHTML = setupConfig.map(p => `
                <div><label class="block font-black mb-2">${p.name}</label>
                <select name="p_${p.name}">${p.options.split(',').map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}</select></div>`).join('');
            
            document.getElementById('booking-modal').style.display = 'flex';
        }

        document.getElementById('book-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('sub-btn');
            btn.disabled = true; btn.innerText = 'é ç´„è™•ç†ä¸­...';
            
            const params = {};
            document.querySelectorAll('#extra-params select').forEach(s => params[s.name] = s.value);

            const payload = {
                type: 'booking_submit',
                courseId: currentCourse['èª²ç¨‹ID'],
                courseName: currentCourse['èª²ç¨‹åç¨±'],
                name: document.getElementById('u-name').value,
                phone: document.getElementById('u-phone').value,
                gender: document.getElementById('u-gender').value,
                birth: document.getElementById('u-birth').value,
                params: params,
                total: document.getElementById('b-total').innerText
            };

            await fetch(CLOUDFURL, { method: 'POST', body: JSON.stringify(payload) });
            alert('ğŸ‰ é ç´„æˆåŠŸï¼æˆ‘å€‘å°‡ç›¡å¿«èˆ‡æ‚¨è¯ç¹«ã€‚');
            location.reload();
        };

        function closeMod(id) { document.getElementById(id).style.display = 'none'; }
        const CLOUDFURL = CLOUDFLARE_URL;
        window.onload = init;
    </script>
</body>
</html>
