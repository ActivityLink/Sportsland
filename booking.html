<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èª²ç¨‹é ç´„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50">
<div class="max-w-xl mx-auto p-6 space-y-6">

  <!-- èª²ç¨‹è³‡è¨Š -->
  <section class="bg-white rounded-xl p-5 shadow">
    <h1 id="courseName" class="text-xl font-bold mb-2">è¼‰å…¥ä¸­â€¦</h1>
    <p id="courseTime" class="text-slate-600 text-sm"></p>
    <div id="courseContent" class="text-slate-700 text-sm mt-3 whitespace-pre-line"></div>
  </section>

  <!-- å ±åå°è±¡ -->
  <section class="bg-white rounded-xl p-5 shadow">
    <h2 class="font-bold mb-3">é¸æ“‡å ±åå°è±¡</h2>
    <select id="attendee" class="w-full border rounded p-3"></select>
  </section>

  <!-- ç§Ÿç”¨è¨­å‚™ -->
  <section class="bg-white rounded-xl p-5 shadow">
    <h2 class="font-bold mb-3">ç§Ÿç”¨è¨­å‚™ï¼ˆé¸å¡«ï¼‰</h2>
    <div id="equipmentBox" class="space-y-2 text-sm text-slate-700"></div>
  </section>

  <!-- é‡‘é¡ -->
  <section class="bg-white rounded-xl p-5 shadow">
    <div class="flex justify-between text-lg font-bold">
      <span>ç¸½é‡‘é¡</span>
      <span id="totalPrice">$0</span>
    </div>
  </section>

  <!-- é€å‡º -->
  <button onclick="submitBooking()"
    class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg">
    ç¢ºèªé ç´„
  </button>

</div>

<script>
/* =====================
   åŸºæœ¬è¨­å®š
===================== */
const API = 'https://aged-rice-2438.wetw-net3.workers.dev/';
const LIFF_ID = 'ğŸ‘‰ä½ çš„ LIFF ID';

let lineUser = {};
let course = null;
let member = null;
let families = [];
let equipmentList = [];
let basePrice = 0;

/* =====================
   Init
===================== */
(async function init(){
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }
  lineUser = await liff.getProfile();

  const url = new URL(location.href);
  const courseId = url.searchParams.get('id');

  await loadBookingInit(courseId);
  await loadConfig();
  renderPage();
})();

/* =====================
   Loaders
===================== */
async function loadBookingInit(courseId){
  const r = await fetch(`${API}?type=booking_init&id=${courseId}&lineUserId=${lineUser.userId}`);
  const j = await r.json();

  if (j.status !== 'success') throw 'booking_init failed';

  course = j.course;
  member = j.member.data;
  families = j.member.families || [];

  basePrice = Number(course.memberPrice || course.price || 0);
}

async function loadConfig(){
  const r = await fetch(`${API}?type=config`);
  const j = await r.json();

  const raw = j.data?.equipment_list?.Global;
  if (!raw) return;

  try {
    equipmentList = JSON.parse(raw);
  } catch(e){}
}

/* =====================
   Render
===================== */
function renderPage(){
  // èª²ç¨‹
  courseName.innerText = course.courseName;
  courseTime.innerText = `${course.courseDate} ${course.startTime} - ${course.endTime}`;
  courseContent.innerText = course.content || '';

  // å°è±¡
  attendee.innerHTML = `
    <option value="self">æœ¬äººï½œ${member.name}</option>
    ${families.map((f,i)=>`
      <option value="${i}">æˆå“¡ï½œ${f.name}</option>
    `).join('')}
  `;

  // è¨­å‚™
  equipmentBox.innerHTML = equipmentList.map((e,i)=>`
    <label class="flex justify-between items-center border p-3 rounded">
      <span>${e.name}</span>
      <span>
        $${e.price}
        <input type="checkbox" data-price="${e.price}" class="ml-2 eq">
      </span>
    </label>
  `).join('');

  document.querySelectorAll('.eq').forEach(cb=>{
    cb.addEventListener('change', calcPrice);
  });

  calcPrice();
}

/* =====================
   Price
===================== */
function calcPrice(){
  let total = basePrice;
  document.querySelectorAll('.eq:checked').forEach(cb=>{
    total += Number(cb.dataset.price);
  });
  totalPrice.innerText = `$${total}`;
}

/* =====================
   Submit
===================== */
async function submitBooking(){
  const who = attendee.value === 'self'
    ? { role:'æœ¬äºº', ...member }
    : { role:'æˆå“¡', ...families[attendee.value] };

  const equipments = [...document.querySelectorAll('.eq:checked')]
    .map(cb => cb.closest('label').innerText.split('$')[0].trim());

  const payload = {
    type: 'course_booking',
    lineUserId: lineUser.userId,
    memberId: member.memberId,
    attendeeRole: who.role,
    attendeeName: who.name,
    attendeeGender: who.gender,
    attendeeBirthDate: who.birthDate,
    courseId: course.courseId,
    courseName: course.courseName,
    courseDate: course.courseDate,
    startTime: course.startTime,
    endTime: course.endTime,
    price: Number(totalPrice.innerText.replace('$','')),
    rentEquipment: equipments
  };

  const r = await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await r.json();

  if (j.status === 'success') {
    alert('âœ… é ç´„å®Œæˆ');
    history.back();
  } else {
    alert('âŒ é ç´„å¤±æ•—');
  }
}
</script>
</body>
</html>
