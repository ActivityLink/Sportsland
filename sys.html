<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SYS - 系統參數管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap');
    :root { --line:#06C755; }
    body{ font-family:Inter,'PingFang TC',sans-serif; background:#F8FAFC; color:#0B1220; }
    .card{ background:#fff; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 1px 3px rgba(0,0,0,.08); padding:24px; }
    label{ display:block; font-size:12px; font-weight:800; color:#64748B; margin-bottom:8px; }
    input{ width:100%; border:1px solid #E2E8F0; border-radius:10px; padding:12px; font-size:14px; }
    input:focus{ outline:none; border-color:var(--line); box-shadow:0 0 0 3px rgba(6,199,85,.12); }
    .btn{ padding:12px 20px; border-radius:10px; font-weight:800; }
    .btn-green{ background:var(--line); color:#fff; }
    .btn-ghost{ background:#F1F5F9; color:#0B1220; border:1px solid #E2E8F0; }
  </style>
</head>
<body class="p-6">
  <div class="max-w-5xl mx-auto space-y-6">

    <div class="flex items-center justify-between">
      <div>
        <div class="text-2xl font-black">SYS 系統參數</div>
        <div class="text-sm font-semibold text-slate-600 mt-1">會寫入 setup：key / scope / value</div>
      </div>
      <div id="status" class="text-sm font-black text-slate-400">連線中...</div>
    </div>

    <div class="card">
      <div class="text-lg font-black mb-4">1) 匯款資訊（JSON）</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label>銀行名稱</label><input id="bankName" placeholder="例：玉山銀行"></div>
        <div><label>銀行代碼</label><input id="bankCode" placeholder="例：808"></div>
        <div><label>受款人戶名</label><input id="accountName" placeholder="例：運動島股份有限公司"></div>
        <div><label>轉帳帳號</label><input id="accountNumber" placeholder="例：0123-4567-8901"></div>
      </div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <div class="text-lg font-black">2) 租用設備清單（JSON Array）</div>
        <button class="btn btn-ghost" onclick="addEq()">＋新增</button>
      </div>
      <div id="eqWrap" class="space-y-3"></div>
      <div id="eqEmpty" class="hidden text-sm font-semibold text-slate-500 py-6 text-center">
        目前無設備資料，請新增
      </div>
    </div>

    <div class="flex justify-end">
      <button id="saveBtn" class="btn btn-green px-10" onclick="saveAll()">儲存到雲端</button>
    </div>
  </div>

<script>
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
let eqList = [];

function setStatus(text, ok){
  const el = document.getElementById('status');
  el.textContent = text;
  el.className = 'text-sm font-black ' + (ok ? 'text-emerald-600' : 'text-red-600');
}

function moneyNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}

function renderEq(){
  const wrap = document.getElementById('eqWrap');
  const empty = document.getElementById('eqEmpty');

  if(!eqList.length){
    wrap.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  wrap.innerHTML = eqList.map((eq,i)=>`
    <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex gap-3 items-end">
      <div class="flex-1">
        <label>設備名稱</label>
        <input value="${(eq.name||'').replaceAll('"','&quot;')}"
               oninput="eqList[${i}].name=this.value" placeholder="例：籃球">
      </div>
      <div class="w-40">
        <label>租用費用</label>
        <input type="number" min="0" step="10"
               value="${moneyNum(eq.price)}"
               oninput="eqList[${i}].price=Number(this.value)||0" placeholder="100">
      </div>
      <button class="btn btn-ghost" onclick="delEq(${i})">刪除</button>
    </div>
  `).join('');
}

function addEq(){
  eqList.push({name:'', price:0});
  renderEq();
}
function delEq(i){
  eqList.splice(i,1);
  renderEq();
}

async function loadConfig(){
  setStatus('連線中...', true);
  try{
    const res = await fetch(`${API_URL}?type=config&_t=${Date.now()}`);
    const raw = await res.json();

    // unwrap worker if needed
    const r = (raw && raw.data && raw.data.status) ? raw.data : raw;
    if(!r || r.status !== 'success') throw new Error(r?.message || 'config 讀取失敗');

    const cfg = r.data || {};
    // equipment_list
    const eqRaw = (cfg.equipment_list && cfg.equipment_list.Global) ? cfg.equipment_list.Global : '[]';
    try{
      const parsed = (typeof eqRaw === 'string') ? JSON.parse(eqRaw) : eqRaw;
      eqList = Array.isArray(parsed) ? parsed : [];
    }catch(e){
      eqList = [];
    }
    eqList = eqList.map(x=>({name:String(x.name||'').trim(), price:moneyNum(x.price)})).filter(x=>x.name);

    // remittance
    const bankRaw = (cfg.remittance && cfg.remittance.Global) ? cfg.remittance.Global : '{}';
    let bank = {};
    try{
      bank = (typeof bankRaw === 'string') ? JSON.parse(bankRaw) : (bankRaw||{});
    }catch(e){ bank = {}; }

    document.getElementById('bankName').value = bank.bankName || '';
    document.getElementById('bankCode').value = bank.bankCode || '';
    document.getElementById('accountName').value = bank.accountName || '';
    document.getElementById('accountNumber').value = bank.accountNumber || '';

    renderEq();
    setStatus('連線正常', true);

  }catch(err){
    console.error(err);
    setStatus('連線失敗', false);
    alert('❌ 讀取失敗：' + (err.message || String(err)));
  }
}

async function saveAll(){
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.textContent = '儲存中...';

  const bank = {
    bankName: document.getElementById('bankName').value.trim(),
    bankCode: document.getElementById('bankCode').value.trim(),
    accountName: document.getElementById('accountName').value.trim(),
    accountNumber: document.getElementById('accountNumber').value.trim(),
  };
  const eq = eqList
    .map(x=>({name:String(x.name||'').trim(), price:moneyNum(x.price)}))
    .filter(x=>x.name);

  const payload = {
    type:'config_update',
    data:[
      { key:'remittance', scope:'Global', value: JSON.stringify(bank) },
      { key:'equipment_list', scope:'Global', value: JSON.stringify(eq) }
    ]
  };

  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const raw = await res.json();
    const r = (raw && raw.data && raw.data.status) ? raw.data : raw;

    if(!r || r.status !== 'success') throw new Error(r?.message || '保存失敗');

    alert('✅ 已儲存');
    await loadConfig();

  }catch(err){
    console.error(err);
    alert('❌ 儲存失敗：' + (err.message || String(err)));
  }finally{
    btn.disabled = false;
    btn.textContent = '儲存到雲端';
  }
}

window.addEventListener('DOMContentLoaded', loadConfig);
</script>
</body>
</html>
