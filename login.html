<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>登入中｜ActivityLink</title>

  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: #F7F9FB;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center">

  <div class="bg-white rounded-2xl shadow-xl p-10 w-full max-w-sm text-center">
    <div class="flex justify-center mb-6">
      <div class="w-14 h-14 rounded-full bg-green-500 flex items-center justify-center">
        <svg class="w-8 h-8 text-white animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
          </path>
        </svg>
      </div>
    </div>

    <h1 class="text-xl font-black text-gray-800 mb-2">LINE 登入中</h1>
    <p class="text-gray-500 text-sm">
      正在驗證您的身分，請稍候…
    </p>
  </div>

<script>
/**
 * ========= 基本設定 =========
 * ⚠️ 請確認這個 LIFF ID 是「已啟用」且「允許外部瀏覽器」
 */
const LIFF_ID = '2008786875-F7ifLsbN';

/**
 * ========= 取得導向頁 =========
 * login.html?to=member.html
 */
function getRedirectTarget() {
  const url = new URL(location.href);
  return url.searchParams.get('to') || 'index.html';
}

(async () => {
  try {
    await liff.init({
      liffId: LIFF_ID,
      withLoginOnExternalBrowser: true
    });

    // 尚未登入 → 導向 LINE Login
    if (!liff.isLoggedIn()) {
      liff.login({
        redirectUri: location.href
      });
      return;
    }

    // 已登入 → 取得 LINE Profile
    const profile = await liff.getProfile();

    // ✅ 統一保存登入者資訊（全系統只認這裡）
    const lineUser = {
      userId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl || ''
    };

    localStorage.setItem('lineUser', JSON.stringify(lineUser));

    // 導回原本頁面
    const target = getRedirectTarget();
    location.replace(target);

  } catch (err) {
    console.error('LIFF Login Error:', err);
    alert('登入失敗，請關閉後重新開啟');
  }
})();
</script>

</body>
</html>
