<div class="single-courses-manage">
    <!-- 頁面標題 -->
    <div class="page-header">
        <div class="page-title">
            <h1><i class="fas fa-calendar-day"></i> 單堂課程管理</h1>
            <p>管理所有單次課程，包含新增、編輯、發佈和下架</p>
        </div>
        <div>
            <button class="btn btn-success" onclick="syncWithGoogleSheet()">
                <i class="fas fa-sync-alt"></i> 同步資料
            </button>
            <button class="btn btn-primary" onclick="showAddCourseModal()">
                <i class="fas fa-plus"></i> 新增課程
            </button>
        </div>
    </div>
    
    <!-- 統計卡片 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-info">
                <h3 id="total-courses">0</h3>
                <p>總課程數</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3 id="total-participants">0</h3>
                <p>總報名人數</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3 id="upcoming-courses">0</h3>
                <p>即將開課</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon secondary">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-info">
                <h3 id="fill-rate">0%</h3>
                <p>平均滿班率</p>
            </div>
        </div>
    </div>
    
    <!-- 管理工具列 -->
    <div class="management-toolbar">
        <div class="toolbar-group">
            <label><i class="fas fa-filter"></i> 狀態：</label>
            <select id="filter-status">
                <option value="">全部狀態</option>
                <option value="draft">草稿</option>
                <option value="published">已發佈</option>
                <option value="full">已額滿</option>
                <option value="cancelled">已取消</option>
            </select>
        </div>
        
        <div class="toolbar-group">
            <label><i class="fas fa-running"></i> 運動類別：</label>
            <select id="filter-sport">
                <option value="">全部類別</option>
                <!-- 動態載入 -->
            </select>
        </div>
        
        <div class="toolbar-group">
            <label><i class="fas fa-map-marker-alt"></i> 場地區域：</label>
            <select id="filter-area">
                <option value="">全部區域</option>
                <!-- 動態載入 -->
            </select>
        </div>
        
        <div class="toolbar-group">
            <label><i class="fas fa-search"></i> 搜尋：</label>
            <input type="text" id="search-input" placeholder="搜尋課程名稱、教練...">
        </div>
        
        <div style="margin-left: auto;">
            <button class="btn btn-outline" onclick="resetFilters()">
                <i class="fas fa-redo"></i> 重置
            </button>
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-search"></i> 篩選
            </button>
        </div>
    </div>
    
    <!-- 課程表格 -->
    <div class="courses-table-container">
        <div class="table-responsive">
            <table id="courses-table">
                <thead>
                    <tr>
                        <th width="50">ID</th>
                        <th>課程名稱</th>
                        <th width="100">運動類別</th>
                        <th width="80">難度</th>
                        <th width="120">日期時間</th>
                        <th width="100">教練</th>
                        <th width="100">場地</th>
                        <th width="100">價格</th>
                        <th width="80">名額</th>
                        <th width="100">狀態</th>
                        <th width="150">操作</th>
                    </tr>
                </thead>
                <tbody id="courses-table-body">
                    <!-- 課程資料會動態載入 -->
                </tbody>
            </table>
        </div>
        
        <!-- 載入狀態 -->
        <div id="loading-state" class="loading">
            <div class="loading-spinner"></div>
            <p>載入課程資料中...</p>
        </div>
        
        <!-- 空狀態 -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h3>目前沒有課程資料</h3>
            <p>點擊「新增課程」按鈕開始建立您的第一堂課程</p>
        </div>
    </div>
    
    <!-- 分頁 -->
    <div class="pagination" id="pagination" style="display: none;">
        <!-- 分頁按鈕會動態產生 -->
    </div>
</div>

<!-- 新增/編輯課程模態框 -->
<div id="course-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> 新增單堂課程</h2>
            <button class="modal-close" onclick="hideCourseModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <div class="info-icon">
                    <i class="fab fa-google"></i>
                </div>
                <div class="info-content">
                    <h3>透過 Google Sheet 管理課程</h3>
                    <p>您的課程資料儲存在 Google Sheets 中，請直接前往編輯。系統會自動同步更新。</p>
                    <ul>
                        <li>✅ 即時編輯，立即生效</li>
                        <li>✅ 支援多人協作編輯</li>
                        <li>✅ 完整的版本歷史紀錄</li>
                        <li>✅ 自動備份，資料安全</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideCourseModal()">取消</button>
            <button class="btn btn-primary" onclick="openGoogleSheet()">
                <i class="fab fa-google"></i> 前往 Google Sheet 編輯
            </button>
        </div>
    </div>
</div>

<!-- 課程詳細資訊模態框 -->
<div id="course-detail-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h2><i class="fas fa-info-circle"></i> 課程詳細資訊</h2>
            <button class="modal-close" onclick="hideCourseDetailModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="course-detail-content">
                <!-- 詳細資訊會動態載入 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideCourseDetailModal()">關閉</button>
            <button class="btn btn-primary" onclick="openGoogleSheet()">
                <i class="fas fa-edit"></i> 編輯此課程
            </button>
        </div>
    </div>
</div>

<style>
    /* 單堂課程管理專用樣式 */
    .single-courses-manage {
        padding: 20px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
    }
    
    .page-title h1 {
        font-size: 1.8em;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    
    .page-title p {
        color: var(--gray);
        font-size: 0.95em;
    }
    
    /* 統計卡片 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid var(--border);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3em;
        color: white;
    }
    
    .stat-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stat-icon.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .stat-icon.secondary { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    
    .stat-info h3 {
        font-size: 1.8em;
        font-weight: 700;
        color: var(--dark);
        line-height: 1;
    }
    
    .stat-info p {
        color: var(--gray);
        margin-top: 5px;
        font-size: 0.9em;
    }
    
    /* 管理工具列 */
    .management-toolbar {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toolbar-group label {
        font-weight: 600;
        color: var(--dark);
        white-space: nowrap;
        font-size: 0.9em;
    }
    
    select, input {
        padding: 8px 15px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.95em;
        background: white;
        min-width: 150px;
    }
    
    input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.1);
    }
    
    /* 課程表格 */
    .courses-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
    }
    
    thead {
        background: #f8fafc;
        border-bottom: 2px solid var(--border);
    }
    
    th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }
    
    td {
        padding: 15px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }
    
    tr:hover {
        background: #f8fafc;
    }
    
    /* 課程狀態標籤 */
    .course-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-draft {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-published {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-full {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-cancelled {
        background: #e5e7eb;
        color: #4b5563;
    }
    
    /* 動作按鈕 */
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .action-btn {
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }
    
    .edit-btn {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .edit-btn:hover {
        background: #bfdbfe;
    }
    
    .delete-btn {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .delete-btn:hover {
        background: #fecaca;
    }
    
    .view-btn {
        background: #f0f9ff;
        color: #0369a1;
    }
    
    .view-btn:hover {
        background: #e0f2fe;
    }
    
    /* 載入狀態 */
    .loading {
        text-align: center;
        padding: 60px;
        color: var(--gray);
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    /* 空狀態 */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
    }
    
    .empty-icon {
        font-size: 3em;
        color: #d1d5db;
        margin-bottom: 20px;
    }
    
    /* 分頁 */
    .pagination {
        display: flex;
        justify-content: center;
        padding: 20px;
        gap: 10px;
    }
    
    .page-btn {
        padding: 8px 15px;
        border: 1px solid var(--border);
        background: white;
        color: #4b5563;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .page-btn:hover:not(.active) {
        background: #f8fafc;
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* 模態框樣式 */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        animation: slideUp 0.3s ease-out;
    }
    
    .modal-content.large {
        max-width: 800px;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid var(--border);
    }
    
    .modal-header h2 {
        font-size: 1.3em;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: var(--gray);
        transition: color 0.2s;
    }
    
    .modal-close:hover {
        color: var(--danger);
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    
    .modal-info {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }
    
    .info-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2em;
        color: white;
        flex-shrink: 0;
    }
    
    .info-content h3 {
        color: var(--dark);
        margin-bottom: 10px;
    }
    
    .info-content p {
        color: var(--gray);
        margin-bottom: 15px;
        line-height: 1.6;
    }
    
    .info-content ul {
        list-style: none;
        padding-left: 0;
    }
    
    .info-content li {
        padding: 5px 0;
        color: var(--gray);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .info-content li:before {
        content: "✓";
        color: var(--success);
        font-weight: bold;
    }
    
    /* 課程詳細資訊樣式 */
    .course-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .detail-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
    }
    
    .detail-section h3 {
        color: var(--dark);
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .detail-row {
        display: flex;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .detail-label {
        flex: 0 0 120px;
        font-weight: 600;
        color: var(--gray);
    }
    
    .detail-value {
        flex: 1;
        color: var(--dark);
    }
    
    /* 動畫 */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    /* 響應式設計 */
    @media (max-width: 1024px) {
        .page-header {
            flex-direction: column;
            gap: 20px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .single-courses-manage {
            padding: 15px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .management-toolbar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .toolbar-group {
            flex-direction: column;
            align-items: stretch;
        }
        
        select, input {
            width: 100%;
            min-width: auto;
        }
        
        .modal-content {
            width: 95%;
            margin: 10px;
        }
        
        .modal-info {
            flex-direction: column;
            text-align: center;
        }
        
        .info-icon {
            align-self: center;
        }
    }
</style>

<script>
// ===== 單堂課程管理專用 JavaScript =====

// 全域變數
const SHEET_ID = '16NKFioe-lrYmpFv20tYEg6p6uo9_D4wSsS2YoiUWKko';
const SHEET_NAME = 'SingleCourses';
let allCourses = [];
let filteredCourses = [];
let currentPage = 1;
const itemsPerPage = 10;

// 初始化單堂課程管理
function initSingleCourses() {
    console.log('初始化單堂課程管理');
    
    // 設定事件監聽器
    setupEventListeners();
    
    // 載入課程資料
    loadCourses();
}

// 設定事件監聽器
function setupEventListeners() {
    // 篩選器事件
    document.getElementById('filter-status')?.addEventListener('change', applyFilters);
    document.getElementById('filter-sport')?.addEventListener('change', applyFilters);
    document.getElementById('filter-area')?.addEventListener('change', applyFilters);
    document.getElementById('search-input')?.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') applyFilters();
    });
    
    // 模態框外部點擊關閉
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            hideCourseModal();
            hideCourseDetailModal();
        }
    });
    
    // ESC 鍵關閉模態框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideCourseModal();
            hideCourseDetailModal();
        }
    });
}

// 從 Google Sheets 載入資料
async function loadCourses() {
    try {
        showLoading();
        
        // 從 Google Sheets 載入資料
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        const response = await fetch(url);
        const text = await response.text();
        
        // 解析資料
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows || [];
        
        if (rows.length < 2) { // 至少要有標題列和一筆資料
            showEmptyState();
            updateStats([]);
            return;
        }
        
        // 取得欄位名稱
        const headers = json.table.cols.map(col => col.label);
        
        // 轉換為物件陣列
        allCourses = rows.slice(1).map((row, index) => {
            const course = {};
            headers.forEach((header, i) => {
                const cell = row.c[i];
                course[header] = cell ? (cell.v || '') : '';
            });
            course.id = course['課程ID'] || index + 1;
            return course;
        });
        
        // 載入篩選器選項
        populateFilters(allCourses);
        
        // 更新統計資料
        updateStats(allCourses);
        
        // 套用篩選並顯示
        applyFilters();
        
        hideLoading();
        
    } catch (error) {
        console.error('載入課程失敗:', error);
        hideLoading();
        showError('無法載入課程資料，請檢查網路連線或 Google Sheet 共用設定');
    }
}

// 更新統計資料
function updateStats(courses) {
    // 總課程數
    document.getElementById('total-courses').textContent = courses.length;
    
    // 總報名人數
    const totalParticipants = courses.reduce((sum, course) => {
        return sum + (parseInt(course['已報名人數']) || 0);
    }, 0);
    document.getElementById('total-participants').textContent = totalParticipants.toLocaleString();
    
    // 即將開課（未來30天內）
    const today = new Date();
    const upcoming = courses.filter(course => {
        const courseDate = new Date(course['課程日期']);
        if (!courseDate || isNaN(courseDate.getTime())) return false;
        const diffDays = Math.floor((courseDate - today) / (1000 * 60 * 60 * 24));
        return diffDays >= 0 && diffDays <= 30;
    });
    document.getElementById('upcoming-courses').textContent = upcoming.length;
    
    // 平均滿班率
    let totalFillRate = 0;
    let validCourses = 0;
    
    courses.forEach(course => {
        const total = parseInt(course['總名額']) || 0;
        const enrolled = parseInt(course['已報名人數']) || 0;
        if (total > 0) {
            totalFillRate += (enrolled / total) * 100;
            validCourses++;
        }
    });
    
    const avgFillRate = validCourses > 0 ? Math.round(totalFillRate / validCourses) : 0;
    document.getElementById('fill-rate').textContent = `${avgFillRate}%`;
}

// 載入篩選器選項
function populateFilters(courses) {
    const sportFilter = document.getElementById('filter-sport');
    const areaFilter = document.getElementById('filter-area');
    
    if (!sportFilter || !areaFilter) return;
    
    // 運動類別
    const sports = [...new Set(courses.map(c => c['運動類別']).filter(Boolean))];
    sportFilter.innerHTML = '<option value="">全部類別</option>';
    sports.forEach(sport => {
        const option = document.createElement('option');
        option.value = sport;
        option.textContent = sport;
        sportFilter.appendChild(option);
    });
    
    // 場地區域
    const areas = [...new Set(courses.map(c => c['場地區域']).filter(Boolean))];
    areaFilter.innerHTML = '<option value="">全部區域</option>';
    areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaFilter.appendChild(option);
    });
}

// 套用篩選
function applyFilters() {
    const status = document.getElementById('filter-status')?.value || '';
    const sport = document.getElementById('filter-sport')?.value || '';
    const area = document.getElementById('filter-area')?.value || '';
    const search = document.getElementById('search-input')?.value.toLowerCase().trim() || '';
    
    filteredCourses = allCourses.filter(course => {
        // 狀態篩選
        if (status) {
            const courseStatus = getCourseStatus(course);
            if (status === 'draft' && courseStatus !== 'draft') return false;
            if (status === 'published' && courseStatus !== 'published') return false;
            if (status === 'full' && courseStatus !== 'full') return false;
            if (status === 'cancelled' && courseStatus !== 'cancelled') return false;
        }
        
        // 運動類別篩選
        if (sport && course['運動類別'] !== sport) return false;
        
        // 場地區域篩選
        if (area && course['場地區域'] !== area) return false;
        
        // 搜尋篩選
        if (search) {
            const searchable = [
                course['課程名稱'],
                course['教練姓名'],
                course['場地名稱'],
                course['運動類別'],
                course['課程亮點'] || ''
            ].join(' ').toLowerCase();
            
            if (!searchable.includes(search)) return false;
        }
        
        return true;
    });
    
    currentPage = 1;
    displayCoursesTable();
    updatePagination();
}

// 取得課程狀態
function getCourseStatus(course) {
    const status = course['課程狀態'] || '';
    const enrolled = parseInt(course['已報名人數']) || 0;
    const total = parseInt(course['總名額']) || 0;
    
    if (status.includes('取消') || status.toLowerCase().includes('cancel')) return 'cancelled';
    if (total > 0 && enrolled >= total) return 'full';
    if (status.includes('發佈') || status.includes('開放') || status.toLowerCase().includes('publish')) return 'published';
    return 'draft';
}

// 取得狀態標籤
function getStatusBadge(course) {
    const status = getCourseStatus(course);
    const text = {
        'draft': '草稿',
        'published': '已發佈',
        'full': '已額滿',
        'cancelled': '已取消'
    }[status] || '未知';
    
    const cls = `status-${status}`;
    return `<span class="course-status ${cls}">${text}</span>`;
}

// 顯示課程表格
function displayCoursesTable() {
    const coursesTableBody = document.getElementById('courses-table-body');
    
    if (!coursesTableBody) return;
    
    if (filteredCourses.length === 0) {
        coursesTableBody.innerHTML = '';
        showEmptyState();
        document.getElementById('pagination').style.display = 'none';
        return;
    }
    
    hideEmptyState();
    document.getElementById('pagination').style.display = 'flex';
    
    // 計算分頁
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageCourses = filteredCourses.slice(startIndex, endIndex);
    
    // 產生表格內容
    coursesTableBody.innerHTML = pageCourses.map(course => {
        const enrolled = parseInt(course['已報名人數']) || 0;
        const total = parseInt(course['總名額']) || 0;
        const price = course['原價'] || course['早鳥價'] || '0';
        const date = course['課程日期'] || '';
        const time = course['開始時間'] || '';
        
        return `
            <tr>
                <td>${course['課程ID'] || course.id}</td>
                <td><strong>${course['課程名稱'] || '未命名'}</strong></td>
                <td>${course['運動類別'] || '-'}</td>
                <td>${course['難度等級'] || '-'}</td>
                <td>${date} ${time}</td>
                <td>${course['教練姓名'] || '-'}</td>
                <td>${course['場地名稱'] || '-'}</td>
                <td>NT$${parseInt(price).toLocaleString()}</td>
                <td>${enrolled}/${total || '∞'}</td>
                <td>${getStatusBadge(course)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editCourse('${course['課程ID'] || course.id}')" title="編輯">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn view-btn" onclick="viewCourseDetail('${course['課程ID'] || course.id}')" title="詳細資訊">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteCourse('${course['課程ID'] || course.id}')" title="刪除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// 更新分頁
function updatePagination() {
    const pagination = document.getElementById('pagination');
    if (!pagination) return;
    
    const totalPages = Math.ceil(filteredCourses.length / itemsPerPage);
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    let paginationHTML = '';
    
    // 上一頁按鈕
    paginationHTML += `
        <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} 
                onclick="changePage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // 頁碼按鈕
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHTML += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="changePage(${i})">
                    ${i}
                </button>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML += `<span style="padding: 8px 5px;">...</span>`;
        }
    }
    
    // 下一頁按鈕
    paginationHTML += `
        <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} 
                onclick="changePage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// 分頁功能
function changePage(page) {
    if (page < 1 || page > Math.ceil(filteredCourses.length / itemsPerPage)) return;
    currentPage = page;
    displayCoursesTable();
    updatePagination();
}

// 重置篩選器
function resetFilters() {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-sport').value = '';
    document.getElementById('filter-area').value = '';
    document.getElementById('search-input').value = '';
    applyFilters();
}

// 同步 Google Sheet
async function syncWithGoogleSheet() {
    const btn = event?.target?.closest('button');
    if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';
        btn.disabled = true;
    }
    
    try {
        await loadCourses();
        showToast('資料同步成功！', 'success');
    } catch (error) {
        console.error('同步失敗:', error);
        showToast('同步失敗，請稍後重試', 'error');
    } finally {
        if (btn) {
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 1000);
        }
    }
}

// 課程操作功能
function viewCourseDetail(courseId) {
    const course = allCourses.find(c => c['課程ID'] === courseId || c.id == courseId);
    if (!course) {
        showToast('找不到課程資料', 'error');
        return;
    }
    
    // 計算相關資料
    const enrolled = parseInt(course['已報名人數']) || 0;
    const total = parseInt(course['總名額']) || 0;
    const remaining = total - enrolled;
    const fillRate = total > 0 ? Math.round((enrolled / total) * 100) : 0;
    
    // 判斷是否為早鳥期間
    let priceInfo = `NT$${parseInt(course['原價'] || 0).toLocaleString()}`;
    if (course['早鳥價'] && course['早鳥截止']) {
        const earlybirdDate = new Date(course['早鳥截止']);
        const now = new Date();
        if (now < earlybirdDate) {
            const discount = course['原價'] > 0 ? Math.round((1 - course['早鳥價'] / course['原價']) * 100) : 0;
            priceInfo = `
                <span style="text-decoration: line-through; color: #999; margin-right: 10px;">
                    NT$${parseInt(course['原價']).toLocaleString()}
                </span>
                <span style="color: #dc2626; font-weight: bold;">
                    NT$${parseInt(course['早鳥價']).toLocaleString()}
                </span>
                <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-size: 0.9em;">
                    早鳥${discount}% OFF
                </span>
            `;
        }
    }
    
    // 建立詳細資訊內容
    const detailContent = `
        <div class="course-detail-grid">
            <div class="detail-section">
                <h3><i class="fas fa-info-circle"></i> 基本資訊</h3>
                <div class="detail-row">
                    <div class="detail-label">課程名稱：</div>
                    <div class="detail-value"><strong>${course['課程名稱'] || '未命名'}</strong></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">運動類別：</div>
                    <div class="detail-value">${course['運動類別'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">難度等級：</div>
                    <div class="detail-value">${course['難度等級'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">年齡分級：</div>
                    <div class="detail-value">${course['年齡分級'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">標籤分類：</div>
                    <div class="detail-value">${course['標籤分類'] || '-'}</div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-calendar-alt"></i> 時間資訊</h3>
                <div class="detail-row">
                    <div class="detail-label">課程日期：</div>
                    <div class="detail-value">${course['課程日期'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">上課時間：</div>
                    <div class="detail-value">${course['開始時間'] || '-'} ~ ${course['結束時間'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">課程時長：</div>
                    <div class="detail-value">${course['課程時長(分鐘)'] || '0'} 分鐘</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">報名期間：</div>
                    <div class="detail-value">${course['開放報名日'] || '-'} ~ ${course['截止報名日'] || '-'}</div>
                </div>
                ${course['早鳥截止'] ? `
                <div class="detail-row">
                    <div class="detail-label">早鳥截止：</div>
                    <div class="detail-value">${course['早鳥截止']}</div>
                </div>
                ` : ''}
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-users"></i> 師資場地</h3>
                <div class="detail-row">
                    <div class="detail-label">教練：</div>
                    <div class="detail-value">${course['教練姓名'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">場地：</div>
                    <div class="detail-value">${course['場地名稱'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">區域：</div>
                    <div class="detail-value">${course['場地區域'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">性別限制：</div>
                    <div class="detail-value">${course['性別限制'] || '無限制'}</div>
                </div>
                ${course['特殊要求'] ? `
                <div class="detail-row">
                    <div class="detail-label">特殊要求：</div>
                    <div class="detail-value">${course['特殊要求']}</div>
                </div>
                ` : ''}
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-chart-bar"></i> 名額與價格</h3>
                <div class="detail-row">
                    <div class="detail-label">總名額：</div>
                    <div class="detail-value">${total || '無限制'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">已報名：</div>
                    <div class="detail-value">${enrolled}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">剩餘名額：</div>
                    <div class="detail-value">
                        <span style="color: ${remaining <= 5 ? '#dc2626' : '#059669'}; font-weight: bold;">
                            ${remaining}
                        </span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">滿班率：</div>
                    <div class="detail-value">
                        <div style="background: #e5e7eb; height: 10px; border-radius: 5px; margin: 5px 0;">
                            <div style="background: ${fillRate >= 80 ? '#059669' : fillRate >= 50 ? '#f59e0b' : '#3b82f6'}; 
                                  width: ${fillRate}%; height: 100%; border-radius: 5px;"></div>
                        </div>
                        ${fillRate}%
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">價格：</div>
                    <div class="detail-value">${priceInfo}</div>
                </div>
                ${course['會員價'] ? `
                <div class="detail-row">
                    <div class="detail-label">會員價：</div>
                    <div class="detail-value">NT$${parseInt(course['會員價']).toLocaleString()}</div>
                </div>
                ` : ''}
                ${course['親友價'] ? `
                <div class="detail-row">
                    <div class="detail-label">親友價：</div>
                    <div class="detail-value">NT$${parseInt(course['親友價']).toLocaleString()}</div>
                </div>
                ` : ''}
            </div>
            
            ${course['課程亮點'] || course['課程內容'] || course['注意事項'] || course['適合對象'] ? `
            <div class="detail-section">
                <h3><i class="fas fa-file-alt"></i> 課程內容</h3>
                ${course['課程亮點'] ? `
                <div class="detail-row">
                    <div class="detail-label">課程亮點：</div>
                    <div class="detail-value">${course['課程亮點']}</div>
                </div>
                ` : ''}
                ${course['課程內容'] ? `
                <div class="detail-row">
                    <div class="detail-label">課程內容：</div>
                    <div class="detail-value">${course['課程內容']}</div>
                </div>
                ` : ''}
                ${course['注意事項'] ? `
                <div class="detail-row">
                    <div class="detail-label">注意事項：</div>
                    <div class="detail-value">${course['注意事項']}</div>
                </div>
                ` : ''}
                ${course['適合對象'] ? `
                <div class="detail-row">
                    <div class="detail-label">適合對象：</div>
                    <div class="detail-value">${course['適合對象']}</div>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <div class="detail-section">
                <h3><i class="fas fa-cog"></i> 系統資訊</h3>
                <div class="detail-row">
                    <div class="detail-label">課程狀態：</div>
                    <div class="detail-value">${getStatusBadge(course)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">排序權重：</div>
                    <div class="detail-value">${course['排序權重'] || '0'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">建立時間：</div>
                    <div class="detail-value">${course['建立時間'] || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">更新時間：</div>
                    <div class="detail-value">${course['更新時間'] || '-'}</div>
                </div>
            </div>
        </div>
        
        ${course['封面圖片'] ? `
        <div style="text-align: center; margin-top: 20px;">
            <img src="${course['封面圖片']}" alt="課程封面" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
        </div>
        ` : ''}
    `;
    
    document.getElementById('course-detail-content').innerHTML = detailContent;
    document.getElementById('course-detail-modal').style.display = 'flex';
}

function editCourse(courseId) {
    // 在實際應用中，這裡會開啟編輯表單
    // 現在先導向 Google Sheet 編輯
    openGoogleSheet();
}

function deleteCourse(courseId) {
    if (confirm('確定要刪除此課程嗎？此操作無法復原。')) {
        // 實際應用中，這裡會從 Google Sheet 刪除資料
        // 現在先顯示模擬訊息
        showToast('已刪除課程（模擬操作）', 'success');
        // 重新載入資料
        loadCourses();
    }
}

// 模態框功能
function showAddCourseModal() {
    document.getElementById('course-modal').style.display = 'flex';
}

function hideCourseModal() {
    document.getElementById('course-modal').style.display = 'none';
}

function hideCourseDetailModal() {
    document.getElementById('course-detail-modal').style.display = 'none';
}

function openGoogleSheet() {
    window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit#gid=0`, '_blank');
    hideCourseModal();
    showToast('已開啟 Google Sheet，編輯後請點擊「同步資料」按鈕更新', 'info');
}

// 工具函數
function showLoading() {
    const loadingState = document.getElementById('loading-state');
    if (loadingState) loadingState.style.display = 'block';
    
    const coursesTableBody = document.getElementById('courses-table-body');
    if (coursesTableBody) coursesTableBody.innerHTML = '';
}

function hideLoading() {
    const loadingState = document.getElementById('loading-state');
    if (loadingState) loadingState.style.display = 'none';
}

function showEmptyState() {
    const emptyState = document.getElementById('empty-state');
    if (emptyState) emptyState.style.display = 'block';
    
    const coursesTableBody = document.getElementById('courses-table-body');
    if (coursesTableBody) coursesTableBody.innerHTML = '';
}

function hideEmptyState() {
    const emptyState = document.getElementById('empty-state');
    if (emptyState) emptyState.style.display = 'none';
}

function showError(message) {
    const coursesTableBody = document.getElementById('courses-table-body');
    if (!coursesTableBody) return;
    
    coursesTableBody.innerHTML = `
        <tr>
            <td colspan="11" style="text-align: center; color: #dc2626; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                <h3>載入失敗</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="loadCourses()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> 重新載入
                </button>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    請確認 Google Sheet 已設定為「知道連結的使用者」可檢視
                </p>
            </td>
        </tr>
    `;
}

function showToast(message, type = 'info') {
    // 建立 toast 元素
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 3000;
        animation: toastSlideIn 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // 3秒後自動移除
    setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
    
    // 添加動畫
    if (!document.querySelector('#toast-animations')) {
        const style = document.createElement('style');
        style.id = 'toast-animations';
        style.textContent = `
            @keyframes toastSlideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes toastSlideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}

// 初始化函數會在視圖載入時自動呼叫
</script>
