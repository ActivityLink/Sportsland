<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單堂課程 - ActivityLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a6bff;
            --secondary: #ff6b6b;
            --success: #28a745;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 標題區 */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary);
        }
        
        .header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        /* 篩選區 */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }
        
        select, input {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }
        
        .search-box {
            flex-grow: 1;
            max-width: 300px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a5bff;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        /* 課程卡片 */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .course-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .course-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .course-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--secondary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .course-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .course-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .course-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 0.9em;
        }
        
        .meta-item i {
            color: var(--primary);
        }
        
        .course-details {
            color: #555;
            font-size: 0.95em;
            margin-bottom: 15px;
            flex-grow: 1;
        }
        
        .course-highlights {
            background: #f8f9ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #555;
        }
        
        .course-price {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 0.95em;
        }
        
        .current-price {
            color: var(--secondary);
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .earlybird-badge {
            background: #ffeb3b;
            color: #333;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .course-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .spots-info {
            font-size: 0.9em;
            color: #666;
        }
        
        .spots-warning {
            color: var(--secondary);
            font-weight: 600;
        }
        
        .btn-enroll {
            background: var(--success);
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-enroll:hover {
            background: #218838;
        }
        
        /* 載入狀態 */
        .loading {
            text-align: center;
            padding: 60px 20px;
            grid-column: 1 / -1;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .course-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
        }
        
        /* 無課程提示 */
        .no-courses {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-courses i {
            font-size: 3em;
            color: #ccc;
            margin-bottom: 20px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 標題區 -->
        <div class="header">
            <h1><i class="fas fa-dumbbell"></i> 單堂課程</h1>
            <p>選擇適合您的單次運動課程，隨時開始您的健康旅程</p>
        </div>
        
        <!-- 篩選區 -->
        <div class="filters">
            <div class="filter-group">
                <label><i class="fas fa-filter"></i> 運動類別：</label>
                <select id="filter-sport">
                    <option value="">全部類別</option>
                    <!-- 動態載入 -->
                </select>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-signal"></i> 難度：</label>
                <select id="filter-level">
                    <option value="">全部難度</option>
                    <option value="初階">初階</option>
                    <option value="中階">中階</option>
                    <option value="高階">高階</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-map-marker-alt"></i> 地區：</label>
                <select id="filter-area">
                    <option value="">全部地區</option>
                    <!-- 動態載入 -->
                </select>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-search"></i> 搜尋：</label>
                <input type="text" id="search-input" class="search-box" placeholder="搜尋課程名稱或教練...">
            </div>
            
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-search"></i> 篩選
            </button>
            <button class="btn btn-secondary" onclick="resetFilters()">
                <i class="fas fa-redo"></i> 重置
            </button>
        </div>
        
        <!-- 課程列表 -->
        <div class="course-grid" id="courses-container">
            <!-- 動態載入課程卡片 -->
        </div>
        
        <!-- 載入動畫 -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>正在載入課程資料...</p>
        </div>
        
        <!-- 無課程提示 -->
        <div class="no-courses" id="no-courses" style="display: none;">
            <i class="fas fa-calendar-times"></i>
            <h3>目前沒有可報名的課程</h3>
            <p>請嘗試不同的篩選條件，或稍後再查看</p>
        </div>
    </div>

    <script>
        // 設定
        const SHEET_ID = '16NKFioe-lrYmpFv20tYEg6p6uo9_D4wSsS2YoiUWKko';
        const SHEET_NAME = 'SingleCourses';
        let allCourses = [];
        let filteredCourses = [];
        
        // DOM 元素
        const coursesContainer = document.getElementById('courses-container');
        const loadingElement = document.getElementById('loading');
        const noCoursesElement = document.getElementById('no-courses');
        
        // 篩選器元素
        const sportFilter = document.getElementById('filter-sport');
        const levelFilter = document.getElementById('filter-level');
        const areaFilter = document.getElementById('filter-area');
        const searchInput = document.getElementById('search-input');
        
        // 從 Google Sheets 載入資料
        async function loadCourses() {
            try {
                showLoading();
                
                // 使用 Google Sheets API v4
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                // 解析 Google Sheets 資料
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const rows = json.table.rows || [];
                
                if (rows.length === 0) {
                    showNoCourses();
                    return;
                }
                
                // 取得欄位名稱（第一行）
                const headers = json.table.cols.map(col => col.label);
                
                // 轉換資料
                allCourses = rows.slice(1).map((row, index) => {
                    const course = {};
                    headers.forEach((header, i) => {
                        course[header] = row.c[i] ? row.c[i].v : '';
                    });
                    course.id = course['課程ID'] || index + 1;
                    return course;
                });
                
                // 載入篩選器選項
                populateFilters(allCourses);
                
                // 顯示所有課程
                filteredCourses = allCourses.filter(course => 
                    course['課程狀態'] === '開放報名' || course['課程狀態'] === '熱門'
                );
                
                displayCourses(filteredCourses);
                
                hideLoading();
                
            } catch (error) {
                console.error('載入課程失敗:', error);
                hideLoading();
                coursesContainer.innerHTML = `
                    <div class="no-courses">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>資料載入失敗</h3>
                        <p>請檢查網路連線或稍後再試</p>
                        <button class="btn btn-primary" onclick="loadCourses()" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> 重新載入
                        </button>
                    </div>
                `;
            }
        }
        
        // 顯示課程卡片
        function displayCourses(courses) {
            if (courses.length === 0) {
                showNoCourses();
                return;
            }
            
            hideNoCourses();
            
            coursesContainer.innerHTML = courses.map(course => createCourseCard(course)).join('');
        }
        
        // 建立課程卡片 HTML
        function createCourseCard(course) {
            const now = new Date();
            const earlybirdDate = new Date(course['早鳥截止']);
            const isEarlybird = course['早鳥截止'] && now < earlybirdDate;
            const currentPrice = isEarlybird ? course['早鳥價'] : course['原價'];
            const spotsLeft = parseInt(course['剩餘名額']) || 0;
            const isLowSpots = spotsLeft > 0 && spotsLeft <= 5;
            
            // 計算優惠百分比
            let discount = 0;
            if (course['原價'] && course['早鳥價'] && course['原價'] > 0) {
                discount = Math.round((1 - course['早鳥價'] / course['原價']) * 100);
            }
            
            return `
                <div class="course-card" data-id="${course['課程ID']}">
                    ${course['封面圖片'] ? 
                        `<img src="${course['封面圖片']}" alt="${course['課程名稱']}" class="course-image">` :
                        `<div class="course-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-dumbbell" style="font-size: 3em;"></i>
                        </div>`
                    }
                    
                    ${course['課程狀態'] === '熱門' ? 
                        `<div class="course-badge"><i class="fas fa-fire"></i> 熱門課程</div>` : ''}
                    
                    <div class="course-content">
                        <h3 class="course-title">${course['課程名稱']}</h3>
                        
                        <div class="course-meta">
                            <span class="meta-item">
                                <i class="fas fa-running"></i> ${course['運動類別'] || '未分類'}
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-signal"></i> ${course['難度等級'] || '未分級'}
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-user"></i> ${course['教練姓名'] || '未指定'}
                            </span>
                        </div>
                        
                        <div class="course-details">
                            <p><i class="far fa-calendar"></i> ${course['課程日期'] || '未定'} ${course['開始時間'] || ''}~${course['結束時間'] || ''}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${course['場地名稱'] || ''} ${course['場地區域'] || ''}</p>
                            ${course['課程亮點'] ? `<p class="course-highlights">✨ ${course['課程亮點']}</p>` : ''}
                        </div>
                        
                        <div class="course-price">
                            ${isEarlybird && discount > 0 ? 
                                `<span class="original-price">NT$${course['原價']}</span>
                                 <span class="earlybird-badge">早鳥${discount}%OFF</span>` : ''}
                            <span class="current-price">NT$${currentPrice || '洽詢'}</span>
                        </div>
                        
                        <div class="course-footer">
                            <div class="spots-info">
                                ${spotsLeft > 0 ? 
                                    `<span class="${isLowSpots ? 'spots-warning' : ''}">
                                        <i class="fas fa-user-friends"></i> 剩餘 ${spotsLeft} 名額
                                    </span>` :
                                    `<span style="color: var(--secondary);">
                                        <i class="fas fa-exclamation-circle"></i> 已額滿
                                    </span>`
                                }
                            </div>
                            <a href="#" class="btn-enroll" onclick="enrollCourse('${course['課程ID']}')">
                                ${spotsLeft > 0 ? '<i class="fas fa-check-circle"></i> 立即報名' : '<i class="fas fa-clock"></i> 查看候補'}
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 載入篩選器選項
        function populateFilters(courses) {
            const sports = [...new Set(courses.map(c => c['運動類別']).filter(Boolean))];
            const areas = [...new Set(courses.map(c => c['場地區域']).filter(Boolean))];
            
            // 運動類別
            sports.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport;
                option.textContent = sport;
                sportFilter.appendChild(option);
            });
            
            // 地區
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
        }
        
        // 套用篩選
        function applyFilters() {
            const selectedSport = sportFilter.value;
            const selectedLevel = levelFilter.value;
            const selectedArea = areaFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            
            filteredCourses = allCourses.filter(course => {
                // 基本狀態篩選
                if (!['開放報名', '熱門'].includes(course['課程狀態'])) {
                    return false;
                }
                
                // 運動類別篩選
                if (selectedSport && course['運動類別'] !== selectedSport) {
                    return false;
                }
                
                // 難度篩選
                if (selectedLevel && course['難度等級'] !== selectedLevel) {
                    return false;
                }
                
                // 地區篩選
                if (selectedArea && course['場地區域'] !== selectedArea) {
                    return false;
                }
                
                // 搜尋篩選
                if (searchTerm) {
                    const courseName = course['課程名稱'] || '';
                    const coachName = course['教練姓名'] || '';
                    const sportType = course['運動類別'] || '';
                    
                    return courseName.toLowerCase().includes(searchTerm) ||
                           coachName.toLowerCase().includes(searchTerm) ||
                           sportType.toLowerCase().includes(searchTerm);
                }
                
                return true;
            });
            
            displayCourses(filteredCourses);
        }
        
        // 重置篩選
        function resetFilters() {
            sportFilter.value = '';
            levelFilter.value = '';
            areaFilter.value = '';
            searchInput.value = '';
            applyFilters();
        }
        
        // 報名課程
        function enrollCourse(courseId) {
            const course = allCourses.find(c => c['課程ID'] === courseId);
            if (!course) return;
            
            alert(`報名課程：${course['課程名稱']}\n\n課程時間：${course['課程日期']} ${course['開始時間']}\n教練：${course['教練姓名']}\n場地：${course['場地名稱']}\n\n將導向報名頁面...`);
            
            // 實際應用中，這裡會導向報名表單
            // window.location.href = `/enroll/${courseId}`;
        }
        
        // 工具函數
        function showLoading() {
            loadingElement.style.display = 'block';
            coursesContainer.style.display = 'none';
            noCoursesElement.style.display = 'none';
        }
        
        function hideLoading() {
            loadingElement.style.display = 'none';
            coursesContainer.style.display = 'grid';
        }
        
        function showNoCourses() {
            coursesContainer.style.display = 'none';
            noCoursesElement.style.display = 'block';
        }
        
        function hideNoCourses() {
            noCoursesElement.style.display = 'none';
        }
        
        // 頁面載入
        document.addEventListener('DOMContentLoaded', loadCourses);
        
        // 即時搜尋
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                applyFilters();
            }
        });
    </script>
</body>
</html>
