<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sports-Island｜運動探索中心</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap');
    :root{
      --line:#06C755;
      --text:#111;
      --muted:#4B5563;
      --bg:#F7F9FB;
      --card:#fff;
      --border:#E5E7EB;
    }
    body{ font-family:"Noto Sans TC", sans-serif; background:var(--bg); color:var(--text); }
    .chip{ border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 16px; font-weight:700; font-size:14px; }
    .chip.active{ background:rgba(6,199,85,.10); border-color:rgba(6,199,85,.35); color:#0F7A34; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:20px; box-shadow:0 8px 22px rgba(0,0,0,.04); }
    .btn{ border:1px solid var(--border); background:#fff; border-radius:14px; padding:10px 14px; font-weight:700; }
    .btn-primary{ background:var(--line); color:#fff; border-color:var(--line); }
    .badge{ font-size:12px; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:#111; }
    .muted{ color:var(--muted); }
    .nav-shadow{ box-shadow:0 -8px 20px rgba(0,0,0,.06); }
    .nav-item{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:10px 0; font-weight:700; font-size:12px; color:#6B7280; }
    .nav-item.active{ color:#0F7A34; }
    .nav-item .ico{ width:44px; height:44px; border-radius:16px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); background:#fff; }
    .nav-item.active .ico{ border-color:rgba(6,199,85,.35); background:rgba(6,199,85,.10); }
  </style>
</head>

<body>
  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[999]">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
    <p class="text-sm font-semibold text-gray-500">正在登入並載入資料...</p>
  </div>

  <div class="max-w-[720px] mx-auto px-4 pb-24">
    <!-- Top Header -->
    <div class="pt-5 flex items-start justify-between gap-3">
      <div>
        <div class="text-2xl font-extrabold tracking-tight">Sports-Island</div>
        <div class="text-sm font-semibold text-gray-500">運動探索中心</div>
      </div>

      <!-- LINE profile badge -->
      <div id="line-badge" class="hidden card px-4 py-3 flex items-center gap-3 rounded-full">
        <img id="line-avatar" class="w-10 h-10 rounded-full border border-green-200" alt="avatar" />
        <div class="leading-tight">
          <div class="text-[11px] font-semibold text-gray-500">已透過 LINE 登入</div>
          <div id="line-name" class="text-[15px] font-extrabold">載入中...</div>
        </div>
        <div class="ml-2 flex items-center gap-2 text-[12px] font-bold" style="color:#0F7A34;">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> 連線中
        </div>
      </div>
    </div>

    <!-- Banner / Home -->
    <div class="mt-4 card overflow-hidden">
      <!-- ✅ 你可以把 banner.png 放在同目錄；或改成你的 URL -->
      <img src="banner.png" alt="banner" class="w-full object-cover" style="max-height:220px;" onerror="this.style.display='none'">
      <div class="p-5">
        <div class="text-xl font-extrabold">運動島暢貨中心</div>
        <div class="mt-1 text-sm font-semibold text-gray-500">請從下方探索課程，並可查看你的購買/預約紀錄</div>

        <div class="mt-4 p-4 rounded-2xl border border-gray-100 bg-white">
          <div class="text-sm font-bold text-gray-700">小提醒</div>
          <div class="mt-1 text-sm font-semibold text-gray-500">
            若你用外部瀏覽器開啟，系統會自動導向 LIFF 登入。
          </div>
        </div>
      </div>
    </div>

    <!-- Views -->
    <!-- 探索 -->
    <section id="view-explore" class="mt-5">
      <div class="flex items-center gap-3">
        <button id="tab-SingleCourses" class="chip active" onclick="switchCourseTab('SingleCourses')">單堂課程</button>
        <button id="tab-SeriesCourses" class="chip" onclick="switchCourseTab('SeriesCourses')">系列課程</button>
        <button id="tab-Activities" class="chip" onclick="switchCourseTab('Activities')">活動</button>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div>
          <div class="text-lg font-extrabold">探索</div>
          <div id="course-count" class="text-sm font-semibold text-gray-500">載入中...</div>
        </div>
        <button class="btn" onclick="loadCourses(currentSheet, true)">
          重新整理
        </button>
      </div>

      <div id="course-list" class="mt-3 space-y-3"></div>
    </section>

    <!-- 紀錄 -->
    <section id="view-record" class="mt-5 hidden">
      <div class="card p-5">
        <div class="text-xl font-extrabold">我的紀錄</div>
        <div class="mt-1 text-sm font-semibold text-gray-500">此帳號的購課/預約紀錄（依 LINE UID）</div>

        <div class="mt-4 flex items-center gap-2">
          <button class="btn" onclick="loadRecords(true)"><i class="fa-solid fa-rotate"></i> 重新整理</button>
          <button class="btn" onclick="openMemberCenter()"><i class="fa-solid fa-user"></i> 會員中心</button>
        </div>

        <div id="record-list" class="mt-4 space-y-3"></div>
      </div>
    </section>

    <!-- 會員（此頁不直接塞會員中心，避免複雜；點擊導到 register.html） -->
    <section id="view-member" class="mt-5 hidden">
      <div class="card p-5">
        <div class="text-xl font-extrabold">會員</div>
        <div class="mt-1 text-sm font-semibold text-gray-500">
          進入會員中心查看/編輯會員與成員資料
        </div>
        <div class="mt-4">
          <button class="btn btn-primary w-full py-4 text-base" onclick="openMemberCenter()">
            前往會員中心
          </button>
        </div>

        <div id="member-quick" class="mt-4 p-4 rounded-2xl border border-gray-100 bg-white hidden">
          <div class="text-sm font-bold text-gray-700">快速摘要</div>
          <div id="member-quick-text" class="mt-1 text-sm font-semibold text-gray-600"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white nav-shadow border-t border-gray-100">
    <div class="max-w-[720px] mx-auto grid grid-cols-3 px-6">
      <button id="nav-explore" class="nav-item active" onclick="switchView('explore')">
        <div class="ico"><i class="fa-solid fa-compass text-lg"></i></div>
        探索
      </button>

      <button id="nav-record" class="nav-item" onclick="switchView('record')">
        <div class="ico"><i class="fa-solid fa-receipt text-lg"></i></div>
        紀錄
      </button>

      <button id="nav-member" class="nav-item" onclick="switchView('member')">
        <div class="ico"><i class="fa-solid fa-user text-lg"></i></div>
        會員
      </button>
    </div>
  </nav>

  <script>
    /* ========= 基本設定 ========= */
    const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
    const LIFF_ID  = '2008786875-F7ifLsbN';

    let lineUser = null;
    let currentSheet = 'SingleCourses';

    /* ========= 工具：安全字串 ========= */
    function s(v){ return (v===undefined || v===null) ? '' : String(v); }
    function esc(str){
      return s(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* ========= 時間格式：避免 1899-12-30 顯示 ========= */
    function fmtTime(v){
      const t = s(v).trim();
      if(!t) return '';
      // 1899-12-30 09:05:00 / 1899-12-30T14:30:00
      const m1 = t.match(/(?:1899-12-30[ T])(\d{1,2}):(\d{2})/);
      if(m1) return `${m1[1].padStart(2,'0')}:${m1[2]}`;
      // HH:mm:ss or HH:mm
      const m2 = t.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if(m2) return `${m2[1].padStart(2,'0')}:${m2[2]}`;
      // ISO datetime
      const m3 = t.match(/T(\d{2}):(\d{2})/);
      if(m3) return `${m3[1]}:${m3[2]}`;
      return t;
    }

    function fmtDate(v){
      const d = s(v).trim();
      if(!d) return '';
      // 2026-01-04T00:00:00
      if(d.includes('T')) return d.split('T')[0];
      // already yyyy-MM-dd
      return d;
    }

    /* ========= View / Nav ========= */
    function switchView(key){
      document.getElementById('view-explore').classList.toggle('hidden', key!=='explore');
      document.getElementById('view-record').classList.toggle('hidden', key!=='record');
      document.getElementById('view-member').classList.toggle('hidden', key!=='member');

      document.getElementById('nav-explore').classList.toggle('active', key==='explore');
      document.getElementById('nav-record').classList.toggle('active', key==='record');
      document.getElementById('nav-member').classList.toggle('active', key==='member');

      // 進紀錄/會員才載入
      if(key==='record') loadRecords(false);
      if(key==='member') loadMemberQuick();
    }

    function setActiveTab(sheet){
      ['SingleCourses','SeriesCourses','Activities'].forEach(k=>{
        const el = document.getElementById('tab-'+k);
        if(!el) return;
        el.classList.toggle('active', k===sheet);
      });
    }

    function switchCourseTab(sheet){
      currentSheet = sheet;
      setActiveTab(sheet);
      loadCourses(sheet, false);
    }

    /* ========= 會員中心跳轉 ========= */
    function openMemberCenter(){
      const from = encodeURIComponent(location.href);
      location.href = `register.html?from=${from}`;
    }

    /* ========= 課程載入 ========= */
    function coursePrice(course){
      const mp = course.memberPrice ?? course["會員價"];
      const op = course.priceOriginal ?? course["原價"];
      const ep = course.priceEarly ?? course["早鳥價"];
      // 優先顯示會員價，沒有則原價
      const val = (mp!==undefined && mp!=='' && mp!=='0') ? mp : (op!==undefined ? op : (ep!==undefined ? ep : ''));
      if(val===undefined || val===null || s(val).trim()==='') return '';
      const n = Number(val);
      return isFinite(n) ? `$${n}` : `$${esc(val)}`;
    }

    function courseMeta(course){
      const date = fmtDate(course.courseDate ?? course["課程日期"]);
      const st = fmtTime(course.startTime ?? course["開始時間"]);
      const et = fmtTime(course.endTime ?? course["結束時間"]);
      const area = s(course.venueArea ?? course["場地區域"]).trim();
      const tags = s(course.tags ?? course["標籤分類"]).trim();
      return {date, st, et, area, tags};
    }

    async function loadCourses(sheet, force){
      const list = document.getElementById('course-list');
      const count = document.getElementById('course-count');
      if(!list || !count) return;

      list.innerHTML = `
        <div class="card p-5">
          <div class="text-sm font-semibold text-gray-500">載入課程中...</div>
        </div>
      `;

      try{
        const url = `${API_URL}?type=fetch_courses&sheet=${encodeURIComponent(sheet)}&_t=${Date.now()}`;
        const res = await fetch(url);
        const raw = await res.json();

        // 兼容不同包裝
        const data = raw?.data ? raw.data : (Array.isArray(raw) ? raw : []);
        const courses = Array.isArray(data) ? data : [];

        count.textContent = `共 ${courses.length} 筆`;

        if(!courses.length){
          list.innerHTML = `
            <div class="card p-5">
              <div class="text-sm font-semibold text-gray-500">目前沒有課程資料</div>
            </div>
          `;
          return;
        }

        list.innerHTML = courses.map(c=>{
          const id = c.courseId ?? c["課程ID"] ?? c.id ?? c.UUID ?? '';
          const name = c.courseName ?? c["課程名稱"] ?? '未命名課程';
          const price = coursePrice(c);
          const meta = courseMeta(c);
          const bookUrl = `booking.html?id=${encodeURIComponent(id)}&type=${encodeURIComponent(sheet)}&from=${encodeURIComponent(location.href)}`;

          return `
            <div class="card p-5">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-lg font-extrabold break-words">${esc(name)}</div>
                  <div class="mt-2 text-sm font-semibold text-gray-700">
                    日 期：${esc(meta.date || '未設定')}
                    <span class="mx-2 text-gray-300">|</span>
                    時 間：${esc(meta.st || '--:--')}${meta.et ? '-' + esc(meta.et) : ''}
                  </div>
                  <div class="mt-2 text-sm font-semibold text-gray-700">
                    區 域：${esc(meta.area || '未設定')}
                    ${meta.tags ? `<span class="mx-2 text-gray-300">|</span> 標 籤：${esc(meta.tags)}` : ''}
                  </div>
                </div>

                <div class="text-right shrink-0">
                  <div class="text-lg font-extrabold">${esc(price || '')}</div>
                  <a href="${bookUrl}" class="inline-block mt-2 text-sm font-extrabold" style="color:#0F7A34;">
                    點我預約
                  </a>
                </div>
              </div>
            </div>
          `;
        }).join('');

      }catch(err){
        console.error(err);
        count.textContent = `載入失敗`;
        list.innerHTML = `
          <div class="card p-5">
            <div class="text-sm font-extrabold text-red-600">課程載入失敗</div>
            <div class="mt-2 text-sm font-semibold text-gray-500">${esc(err.message || err)}</div>
          </div>
        `;
      }
    }

    /* ========= 紀錄載入：依 LINE UID =========
       後端請提供：
       GET ?type=booking_list&lineUserId=Uxxxx
       回傳格式建議：{status:"success", data:[{...}]}
    */
    async function loadRecords(force){
      const box = document.getElementById('record-list');
      if(!box) return;

      if(!lineUser?.userId){
        box.innerHTML = `
          <div class="p-4 rounded-2xl border border-gray-100 bg-white">
            <div class="text-sm font-extrabold text-gray-700">尚未取得 LINE 身分</div>
            <div class="mt-1 text-sm font-semibold text-gray-500">請先登入後再查看紀錄</div>
          </div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="p-4 rounded-2xl border border-gray-100 bg-white">
          <div class="text-sm font-semibold text-gray-500">載入紀錄中...</div>
        </div>
      `;

      try{
        const url = `${API_URL}?type=booking_list&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`;
        const res = await fetch(url);
        const raw = await res.json();

        const data = raw?.data ? raw.data : [];
        const rows = Array.isArray(data) ? data : [];

        if(!rows.length){
          // 若後端尚未做 booking_list，通常會回 error/message
          if(raw?.status === 'error' || raw?.message){
            box.innerHTML = `
              <div class="p-4 rounded-2xl border border-gray-100 bg-white">
                <div class="text-sm font-extrabold text-gray-700">目前無法取得紀錄</div>
                <div class="mt-1 text-sm font-semibold text-gray-500">
                  後端尚未提供 <span class="font-extrabold">booking_list</span>，或回傳格式不符。
                </div>
                <div class="mt-2 text-xs font-semibold text-gray-400 break-all">訊息：${esc(raw.message || 'no data')}</div>
              </div>
            `;
          }else{
            box.innerHTML = `
              <div class="p-4 rounded-2xl border border-gray-100 bg-white">
                <div class="text-sm font-extrabold text-gray-700">尚無購買/預約紀錄</div>
                <div class="mt-1 text-sm font-semibold text-gray-500">你可以先到探索頁預約課程</div>
              </div>
            `;
          }
          return;
        }

        box.innerHTML = rows.map(r=>{
          const courseName = r.courseName ?? r["課程名稱"] ?? r["課程名稱"] ?? '';
          const courseDate = fmtDate(r.courseDate ?? r["課程日期"]);
          const st = fmtTime(r.startTime ?? r["開始時間"]);
          const status = r.status ?? r["狀態"] ?? '';
          const price = r.price ?? r["報名價格"] ?? '';
          const who = r.attendeeName ?? r["報名對象姓名"] ?? '';
          const id = r.bookingId ?? r["預約ID"] ?? '';
          return `
            <div class="p-4 rounded-2xl border border-gray-100 bg-white">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="text-base font-extrabold break-words">${esc(courseName || '未命名課程')}</div>
                  <div class="mt-2 text-sm font-semibold text-gray-700">
                    日 期：${esc(courseDate || '未設定')}
                    <span class="mx-2 text-gray-300">|</span>
                    時 間：${esc(st || '--:--')}
                  </div>
                  <div class="mt-2 text-sm font-semibold text-gray-700">
                    對 象：${esc(who || '未指定')}
                    ${price ? `<span class="mx-2 text-gray-300">|</span> 金 額：${esc(price)}` : ''}
                  </div>
                  <div class="mt-2 text-xs font-semibold text-gray-400 break-all">ID：${esc(id)}</div>
                </div>
                <div class="shrink-0">
                  <span class="badge">${esc(status || '—')}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

      }catch(err){
        console.error(err);
        box.innerHTML = `
          <div class="p-4 rounded-2xl border border-gray-100 bg-white">
            <div class="text-sm font-extrabold text-red-600">載入紀錄失敗</div>
            <div class="mt-1 text-sm font-semibold text-gray-500">${esc(err.message || err)}</div>
          </div>
        `;
      }
    }

    /* ========= 會員 quick：拿 member_check 做摘要（不強制） ========= */
    async function loadMemberQuick(){
      const wrap = document.getElementById('member-quick');
      const text = document.getElementById('member-quick-text');
      if(!wrap || !text) return;

      if(!lineUser?.userId){
        wrap.classList.add('hidden');
        return;
      }

      try{
        const url = `${API_URL}?type=member_check&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`;
        const res = await fetch(url);
        const raw = await res.json();
        if(raw?.status === 'exists'){
          const u = raw.data || {};
          wrap.classList.remove('hidden');
          text.innerHTML = `中心姓名：<span class="font-extrabold">${esc(u.name || '未填')}</span>　|　電話：${esc(u.phone || '未填')}`;
        }else{
          wrap.classList.remove('hidden');
          text.innerHTML = `尚未註冊，請先進入會員中心完成資料填寫。`;
        }
      }catch(e){
        wrap.classList.add('hidden');
      }
    }

    /* ========= LIFF init ========= */
    async function init(){
      try{
        await liff.init({
          liffId: LIFF_ID,
          withLoginOnExternalBrowser: true
        });

        if(!liff.isLoggedIn()){
          const cleanUrl = location.origin + location.pathname + location.search;
          liff.login({ redirectUri: cleanUrl });
          return;
        }

        lineUser = await liff.getProfile();

        // show badge
        document.getElementById('line-avatar').src = lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
        document.getElementById('line-name').innerText = lineUser.displayName || 'LINE 使用者';
        document.getElementById('line-badge').classList.remove('hidden');

        // default load explore
        setActiveTab(currentSheet);
        await loadCourses(currentSheet, false);

      }catch(err){
        console.error('LIFF init error', err);
      }finally{
        document.getElementById('loading').style.display = 'none';
      }
    }

    init();
  </script>
</body>
</html>
