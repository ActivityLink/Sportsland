<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sports-Island - 運動探索中心</title>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
    :root { --line-green:#06C755; --bg-gray:#F0F2F5; }
    body{ font-family:'Noto Sans TC',sans-serif; background-color:var(--bg-gray); margin:0; display:flex; justify-content:center; }
    .page-wrapper{ width:100%; max-width:640px; background:#fff; min-height:100vh; padding-bottom:80px; box-shadow:0 0 30px rgba(0,0,0,0.05); }
    .top-nav{ background:#fff; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; border-bottom:1px solid #F0F0F0; }
    .tab-container{ display:flex; background:#fff; border-bottom:1px solid #F0F0F0; position:sticky; top:56px; z-index:90; overflow-x:auto; }
    .tab-item{ padding:16px 20px; font-size:14px; color:#444; cursor:pointer; border-bottom:3px solid transparent; white-space:nowrap; font-weight:600; }
    .tab-item.active{ color:var(--line-green); border-bottom-color:var(--line-green); font-weight:900; }
    .course-card{ background:#fff; margin:20px; border-radius:16px; overflow:hidden; border:1px solid #F0F0F0; }
    .btn-outline{ border:1.5px solid var(--line-green); color:var(--line-green); }
    .btn-solid{ background:var(--line-green); color:#fff; }

    /* top right profile */
    .profile-pill{ display:flex; align-items:center; gap:10px; padding:6px 10px; border:1px solid #E5E7EB; border-radius:999px; }
    .profile-pill img{ width:28px; height:28px; border-radius:999px; }
    .profile-pill .nm{ font-size:12px; font-weight:900; color:#111; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  </style>
</head>

<body>
<div class="page-wrapper">

  <header class="top-nav">
    <div class="font-black text-xl text-gray-800">Sports-Island</div>

    <!-- 未登入：顯示登入中心；已登入：顯示頭像+名稱 -->
    <div id="top-right">
      <button id="login-btn" class="text-xs text-green-600 font-black px-4 py-1.5 border-2 border-green-500 rounded-full hidden">
        登入中心
      </button>

      <button id="profile-btn" class="profile-pill hidden">
        <img id="p-avatar" src="" alt="">
        <div class="nm" id="p-name">LINE 使用者</div>
      </button>
    </div>
  </header>

  <img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" class="w-full">

  <div class="tab-container">
    <div id="tab-SingleCourses" class="tab-item active" onclick="switchTab('SingleCourses')">單日活動</div>
    <div id="tab-BatchCourses" class="tab-item" onclick="switchTab('BatchCourses')">梯次課程</div>
    <div id="tab-CampCourses" class="tab-item" onclick="switchTab('CampCourses')">營隊專區</div>
    <div id="tab-AfterSchoolCourses" class="tab-item" onclick="switchTab('AfterSchoolCourses')">課後班</div>
  </div>

  <main id="course-list" class="min-h-[400px]"></main>

  <nav class="fixed bottom-0 w-full max-w-[640px] bg-white border-t flex justify-around py-3 z-50">
    <a href="#" onclick="location.reload()" class="flex flex-col items-center text-green-500">
      <i class="fas fa-compass text-xl"></i><span class="text-[10px] font-black">探索</span>
    </a>
    <a href="register.html?from=" onclick="this.href='register.html?from='+encodeURIComponent(location.href)" class="flex flex-col items-center text-gray-400">
      <i class="fas fa-user-circle text-xl"></i><span class="text-[10px] font-black">會員</span>
    </a>
  </nav>
</div>

<!-- 詳情 Modal（維持你原本樣式，這裡用簡版） -->
<div id="detail-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-5 z-[1000]" onclick="if(event.target===this)closeDetails()">
  <div class="bg-white w-full max-w-[520px] rounded-3xl max-h-[80vh] overflow-y-auto">
    <div class="p-6 border-b flex justify-between items-center">
      <h3 id="modal-title" class="font-black text-lg"></h3>
      <button onclick="closeDetails()" class="text-gray-600"><i class="fas fa-times"></i></button>
    </div>
    <div id="modal-body" class="p-6 text-[15px] text-gray-900"></div>
    <div class="p-6 border-t">
      <button id="modal-book-btn" class="w-full btn-solid py-4 rounded-2xl font-black">立即前往預約</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/'; // 你的 Worker
const LIFF_ID  = '2008786875-F7ifLsbN';

let currentCourses = [];
let currentSheet = 'SingleCourses';
let lineUser = null;

function normalizeCourse(c) {
  return {
    courseId: c.courseId || c['課程ID'] || c['ID'] || '',
    courseName: c.courseName || c['課程名稱'] || c['活動名稱'] || '',
    courseDate: c.courseDate || c['課程日期'] || c['活動日期'] || '',
    startTime: c.startTime || c['開始時間'] || '',
    endTime: c.endTime || c['結束時間'] || '',
    memberPrice: Number(c.memberPrice || c['會員價'] || c['價格'] || 0) || 0,
    coverImage: c.coverImage || c['封面圖片'] || '',

    highlights: c.highlights || c['課程亮點'] || '',
    content: c.content || c['課程內容'] || '',
    notes: c.notes || c['注意事項'] || '',
    targetAudience: c.targetAudience || c['適合對象'] || ''
  };
}

function navigateTo(p) {
  const base = location.href.split('?')[0];
  location.href = base.substring(0, base.lastIndexOf('/') + 1) + p;
}

async function switchTab(name) {
  currentSheet = name;

  document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
  const tab = document.getElementById(`tab-${name}`);
  if (tab) tab.classList.add('active');

  const list = document.getElementById('course-list');
  list.innerHTML = '<div class="p-20 text-center text-gray-700 font-black">讀取中...</div>';

  try {
    const res = await fetch(`${API_URL}?sheet=${encodeURIComponent(name)}&_t=${Date.now()}`);
    const json = await res.json();

    // 兼容 Worker 包裝
    const payload = (json && json.status === 'success' && json.data) ? json : (json.data && json.data.status ? json.data : json);

    if (!payload || payload.status !== 'success') {
      list.innerHTML = `<div class="p-10 text-center text-red-600 font-black">載入失敗：${(payload && payload.message) || '未知錯誤'}</div>`;
      return;
    }

    currentCourses = (payload.data || []).map(normalizeCourse);
    render();

  } catch (e) {
    console.error(e);
    list.innerHTML = '<div class="p-10 text-center text-red-600 font-black">載入失敗</div>';
  }
}

function render() {
  const list = document.getElementById('course-list');
  if (!currentCourses.length) {
    list.innerHTML = '<div class="p-10 text-center text-gray-700 font-black">目前無活動</div>';
    return;
  }

  list.innerHTML = currentCourses.map(c => `
    <div class="course-card">
      <img src="${c.coverImage || 'https://placehold.co/800x450'}" class="w-full">
      <div class="p-6">
        <h3 class="font-black text-lg text-gray-900">${c.courseName}</h3>
        <p class="text-sm text-gray-900/80 mt-1 font-medium">${c.courseDate || ''} ${c.startTime ? `｜${c.startTime}` : ''}</p>

        <div class="flex justify-between items-center mt-6">
          <div class="text-green-600 font-black text-xl">$${c.memberPrice}</div>
          <div class="flex gap-2">
            <button onclick="showDetails('${c.courseId}')" class="btn-outline px-4 py-2 rounded-full text-xs font-black">詳情</button>
            <button onclick="startBooking('${c.courseId}')" class="btn-solid px-4 py-2 rounded-full text-xs font-black">預約</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function showDetails(id) {
  const c = currentCourses.find(x => String(x.courseId) === String(id));
  if (!c) return;

  document.getElementById('modal-title').innerText = c.courseName;
  document.getElementById('modal-body').innerHTML = `
    <div class="space-y-4">
      <div><div class="font-black">課程亮點</div><div>${c.highlights || '暫無資料'}</div></div>
      <div><div class="font-black">課程內容</div><div>${c.content || '暫無資料'}</div></div>
      <div><div class="font-black">注意事項</div><div>${c.notes || '暫無資料'}</div></div>
      <div><div class="font-black">適合對象</div><div>${c.targetAudience || '暫無資料'}</div></div>
    </div>
  `;
  document.getElementById('modal-book-btn').onclick = () => startBooking(id);
  document.getElementById('detail-modal').classList.remove('hidden');
  document.getElementById('detail-modal').classList.add('flex');
}

function closeDetails() {
  const m = document.getElementById('detail-modal');
  m.classList.add('hidden');
  m.classList.remove('flex');
}

function startBooking(id) {
  const from = encodeURIComponent(location.href);
  navigateTo(`booking.html?id=${encodeURIComponent(id)}&type=${encodeURIComponent(currentSheet)}&from=${from}`);
}

/* ===== LIFF: 右上角顯示登入者 ===== */
(async () => {
  try {
    await liff.init({ liffId: LIFF_ID });

    const loginBtn = document.getElementById('login-btn');
    const profileBtn = document.getElementById('profile-btn');

    if (!liff.isLoggedIn()) {
      loginBtn.classList.remove('hidden');
      loginBtn.onclick = () => {
        const cleanUrl = location.origin + location.pathname + location.search;
        liff.login({ redirectUri: cleanUrl });
      };
    } else {
      lineUser = await liff.getProfile();
      document.getElementById('p-avatar').src = lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
      document.getElementById('p-name').innerText = lineUser.displayName || 'LINE 使用者';
      profileBtn.classList.remove('hidden');
      profileBtn.onclick = () => {
        navigateTo(`register.html?from=${encodeURIComponent(location.href)}`);
      };
    }

  } catch (e) {
    console.error('LIFF init error', e);
    // 若 LIFF 失敗，保留登入按鈕
    const loginBtn = document.getElementById('login-btn');
    loginBtn.classList.remove('hidden');
  } finally {
    switchTab('SingleCourses');
  }
})();
</script>
</body>
</html>
