<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sports-Island - 運動探索中心</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap');
    :root{
      --line:#06C755;
      --bg:#F7F9FB;
      --card:#fff;
      --border:#E5E7EB;
      --text:#111;
      --muted:#6B7280;
    }
    body{ font-family:"Noto Sans TC", sans-serif; background:var(--bg); color:var(--text); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 8px 22px rgba(0,0,0,.04); }
    .tabbar{
      display:flex; gap:24px; align-items:flex-end;
      border-bottom:1px solid #E5E7EB;
      padding:12px 6px 0 6px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .tab{
      position:relative; padding:14px 6px; font-weight:800; white-space:nowrap;
      color:#4B5563;
    }
    .tab.active{ color:var(--line); }
    .tab.active::after{
      content:""; position:absolute; left:0; right:0; bottom:-1px; height:3px;
      background:var(--line); border-radius:999px;
    }

    /* 底部導覽 */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; border-top:1px solid #E5E7EB;
      box-shadow:0 -8px 20px rgba(0,0,0,.06);
      padding-bottom: env(safe-area-inset-bottom);
      z-index:50;
    }
    .nav-item{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      padding:10px 0; font-weight:800; font-size:12px; color:#9CA3AF;
    }
    .nav-item .ico{
      width:44px; height:44px; border-radius:16px;
      border:1px solid #E5E7EB; background:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .nav-item.active{ color:#0F7A34; }
    .nav-item.active .ico{
      border-color: rgba(6,199,85,.35);
      background: rgba(6,199,85,.10);
    }
  </style>
</head>

<body>
  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[999]">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mb-4"></div>
    <p class="text-sm font-semibold text-gray-500">正在登入並載入資料...</p>
  </div>

  <div class="max-w-[720px] mx-auto px-4 pb-[110px]">
    <!-- Header -->
    <div class="pt-5 flex items-start justify-between gap-3">
      <div>
        <div class="text-3xl font-extrabold tracking-tight">Sports-Island</div>
        <div class="text-sm font-semibold text-gray-500">運動探索中心</div>
      </div>

      <!-- LINE badge -->
      <div id="line-badge" class="hidden card px-4 py-3 flex items-center gap-3 rounded-full">
        <img id="line-avatar" class="w-10 h-10 rounded-full border border-green-200" alt="avatar" />
        <div class="leading-tight">
          <div class="text-[11px] font-semibold text-gray-500">已透過 LINE 登入</div>
          <div id="line-name" class="text-[15px] font-extrabold">載入中...</div>
        </div>
      </div>
    </div>

    <!-- Banner（固定你的網址，不再找 banner.png） -->
    <div class="mt-4 card overflow-hidden">
      <img id="bannerImg"
           alt="banner"
           class="w-full object-cover"
           style="max-height:240px; display:block;"
           src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg"
           onerror="this.style.display='none'">
    </div>

    <!-- Tabs (4) -->
    <div class="mt-4 tabbar">
      <button id="tab-SingleCourses" class="tab active" onclick="switchTab('SingleCourses')">單日活動</button>
      <button id="tab-SeriesCourses" class="tab" onclick="switchTab('SeriesCourses')">梯次課程</button>
      <button id="tab-TeamZone" class="tab" onclick="switchTab('TeamZone')">營隊專區</button>
      <button id="tab-AfterSchool" class="tab" onclick="switchTab('AfterSchool')">課後班</button>
    </div>

    <!-- Explore list -->
    <section id="view-explore" class="mt-4">
      <div class="flex items-center justify-between">
        <div class="text-sm font-extrabold text-gray-700">探索</div>
        <button class="px-4 py-2 rounded-xl border border-gray-200 bg-white font-extrabold text-sm"
                onclick="loadCourses(currentSheet,true)">
          重新整理
        </button>
      </div>

      <div id="course-count" class="mt-1 text-sm font-semibold text-gray-500">載入中...</div>
      <div id="course-list" class="mt-3 space-y-3"></div>
    </section>

    <!-- Record -->
    <section id="view-record" class="mt-4 hidden">
      <div class="card p-5">
        <div class="text-xl font-extrabold">我的紀錄</div>
        <div class="mt-1 text-sm font-semibold text-gray-500">此帳號的購課/預約紀錄</div>

        <div class="mt-4 flex items-center gap-2">
          <button class="px-4 py-2 rounded-xl border border-gray-200 bg-white font-extrabold text-sm"
                  onclick="loadRecords(true)">
            重新整理
          </button>
          <button class="px-4 py-2 rounded-xl border border-gray-200 bg-white font-extrabold text-sm"
                  onclick="goMemberCenter()">
            會員中心
          </button>
        </div>

        <div id="record-list" class="mt-4 space-y-3"></div>
      </div>
    </section>
  </div>

  <!-- Bottom Nav：探索 / 紀錄 / 會員（會員直接進 register.html，不顯示按鈕頁） -->
  <nav class="bottom-nav">
    <div class="max-w-[720px] mx-auto grid grid-cols-3 px-6">
      <button id="nav-explore" class="nav-item active" onclick="switchView('explore')">
        <div class="ico"><i class="fa-solid fa-compass text-lg"></i></div>
        探索
      </button>
      <button id="nav-record" class="nav-item" onclick="switchView('record')">
        <div class="ico"><i class="fa-solid fa-receipt text-lg"></i></div>
        紀錄
      </button>
      <button id="nav-member" class="nav-item" onclick="goMemberCenter()">
        <div class="ico"><i class="fa-solid fa-user text-lg"></i></div>
        會員
      </button>
    </div>
  </nav>

  <script>
    /* ========= 基本設定 ========= */
    const API_URL = 'https://aged-rice-2438.wetw-net3.workers.dev/';
    const LIFF_ID  = '2008786875-F7ifLsbN';

    let lineUser = null;
    let currentSheet = 'SingleCourses';

    function s(v){ return (v===undefined || v===null) ? '' : String(v); }
    function esc(str){
      return s(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* ✅ 時間顯示修正：1899-12-30T14:30:00 -> 14:30 */
    function fmtTime(v){
      const t = s(v).trim();
      if(!t) return '';
      const m1 = t.match(/(?:1899-12-30[ T])(\d{1,2}):(\d{2})/);
      if(m1) return `${m1[1].padStart(2,'0')}:${m1[2]}`;
      const m2 = t.match(/T(\d{2}):(\d{2})/);
      if(m2) return `${m2[1]}:${m2[2]}`;
      const m3 = t.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
      if(m3) return `${m3[1].padStart(2,'0')}:${m3[2]}`;
      return t;
    }
    function fmtDate(v){
      const d = s(v).trim();
      if(!d) return '';
      return d.includes('T') ? d.split('T')[0] : d;
    }

    function switchView(key){
      document.getElementById('view-explore').classList.toggle('hidden', key!=='explore');
      document.getElementById('view-record').classList.toggle('hidden', key!=='record');

      document.getElementById('nav-explore').classList.toggle('active', key==='explore');
      document.getElementById('nav-record').classList.toggle('active', key==='record');

      if(key==='record') loadRecords(false);
    }

    function setActiveTab(sheet){
      ['SingleCourses','SeriesCourses','TeamZone','AfterSchool'].forEach(k=>{
        const el = document.getElementById('tab-'+k);
        if(!el) return;
        el.classList.toggle('active', k===sheet);
      });
    }

    function switchTab(sheet){
      currentSheet = sheet;
      setActiveTab(sheet);
      loadCourses(sheet,false);
    }

    function goMemberCenter(){
      const from = encodeURIComponent(location.href);
      location.href = `register.html?from=${from}`;
    }

    function courseMeta(c){
      const date = fmtDate(c.courseDate ?? c["課程日期"]);
      const st = fmtTime(c.startTime ?? c["開始時間"]);
      const et = fmtTime(c.endTime ?? c["結束時間"]);
      return {date, st, et};
    }

    function coursePrice(c){
      const mp = c.memberPrice ?? c["會員價"];
      const op = c.priceOriginal ?? c["原價"];
      const ep = c.priceEarly ?? c["早鳥價"];
      const val = (mp!==undefined && s(mp).trim()!=='') ? mp : ((op!==undefined && s(op).trim()!=='') ? op : ep);
      if(val===undefined || s(val).trim()==='') return '';
      const n = Number(val);
      return Number.isFinite(n) ? `$${n}` : `$${esc(val)}`;
    }

    async function loadCourses(sheet, force){
      const list = document.getElementById('course-list');
      const count = document.getElementById('course-count');
      list.innerHTML = `<div class="card p-4"><div class="text-sm font-semibold text-gray-500">載入課程中...</div></div>`;
      count.textContent = '載入中...';

      try{
        const url = `${API_URL}?type=fetch_courses&sheet=${encodeURIComponent(sheet)}&_t=${Date.now()}`;
        const res = await fetch(url);
        const raw = await res.json();
        const data = raw?.data ? raw.data : (Array.isArray(raw) ? raw : []);
        const courses = Array.isArray(data) ? data : [];

        count.textContent = `共 ${courses.length} 筆`;
        if(!courses.length){
          list.innerHTML = `<div class="card p-4"><div class="text-sm font-semibold text-gray-500">目前沒有課程</div></div>`;
          return;
        }

        list.innerHTML = courses.map(c=>{
          const id = c.courseId ?? c["課程ID"] ?? c.id ?? c.UUID ?? '';
          const name = c.courseName ?? c["課程名稱"] ?? '未命名課程';
          const cover = c.coverImage ?? c["封面圖片"] ?? '';
          const meta = courseMeta(c);
          const price = coursePrice(c);

          const bookUrl = `booking.html?id=${encodeURIComponent(id)}&type=${encodeURIComponent(sheet)}&from=${encodeURIComponent(location.href)}`;

          return `
            <div class="card overflow-hidden">
              ${cover ? `<img src="${esc(cover)}" class="w-full object-cover" style="max-height:220px" onerror="this.style.display='none'">` : ``}
              <div class="p-5">
                <div class="text-xl font-extrabold">${esc(name)}</div>
                <div class="mt-2 text-sm font-semibold text-gray-600">
                  ${esc(meta.date)} ｜ ${esc(meta.st)}${meta.et?`-${esc(meta.et)}`:''}
                </div>

                <div class="mt-4 flex items-center justify-between">
                  <div class="text-lg font-extrabold">${esc(price)}</div>
                  <a class="px-4 py-2 rounded-xl font-extrabold text-sm"
                     style="background:rgba(6,199,85,.12);color:#0F7A34;border:1px solid rgba(6,199,85,.25);"
                     href="${bookUrl}">
                    點我預約
                  </a>
                </div>
              </div>
            </div>
          `;
        }).join('');

      }catch(err){
        console.error(err);
        count.textContent = '載入失敗';
        list.innerHTML = `
          <div class="card p-4">
            <div class="text-sm font-extrabold text-red-600">課程載入失敗</div>
            <div class="mt-2 text-sm font-semibold text-gray-500">${esc(err.message || err)}</div>
          </div>
        `;
      }
    }

    /* ✅ 紀錄：後端需要支援 type=booking_list */
    async function loadRecords(force){
      const box = document.getElementById('record-list');
      if(!lineUser?.userId){
        box.innerHTML = `<div class="p-4 rounded-2xl border border-gray-100 bg-white">
          <div class="text-sm font-extrabold text-gray-700">尚未登入</div>
          <div class="mt-1 text-sm font-semibold text-gray-500">請先完成 LIFF 登入</div>
        </div>`;
        return;
      }

      box.innerHTML = `<div class="p-4 rounded-2xl border border-gray-100 bg-white">
        <div class="text-sm font-semibold text-gray-500">載入紀錄中...</div>
      </div>`;

      try{
        const url = `${API_URL}?type=booking_list&lineUserId=${encodeURIComponent(lineUser.userId)}&_t=${Date.now()}`;
        const res = await fetch(url);
        const raw = await res.json();

        const rows = Array.isArray(raw?.data) ? raw.data : [];
        if(!rows.length){
          box.innerHTML = `<div class="p-4 rounded-2xl border border-gray-100 bg-white">
            <div class="text-sm font-extrabold text-gray-700">目前沒有紀錄</div>
            <div class="mt-1 text-sm font-semibold text-gray-500">${esc(raw?.message || '（後端未回傳 booking_list 或查無資料）')}</div>
          </div>`;
          return;
        }

        box.innerHTML = rows.map(r=>{
          const cname = r.courseName || '';
          const date = fmtDate(r.courseDate);
          const st = fmtTime(r.startTime);
          const who = r.attendeeName || '';
          const status = r.status || '';
          const id = r.bookingId || '';
          return `<div class="p-4 rounded-2xl border border-gray-100 bg-white">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-base font-extrabold">${esc(cname || '未命名課程')}</div>
                <div class="mt-2 text-sm font-semibold text-gray-600">${esc(date)} ｜ ${esc(st)}</div>
                <div class="mt-2 text-sm font-semibold text-gray-700">對象：${esc(who || '未指定')}</div>
                <div class="mt-2 text-xs font-semibold text-gray-400 break-all">ID：${esc(id)}</div>
              </div>
              <div class="text-xs font-extrabold px-3 py-2 rounded-full border border-gray-200 text-gray-700">
                ${esc(status || '—')}
              </div>
            </div>
          </div>`;
        }).join('');

      }catch(err){
        console.error(err);
        box.innerHTML = `<div class="p-4 rounded-2xl border border-gray-100 bg-white">
          <div class="text-sm font-extrabold text-red-600">紀錄載入失敗</div>
          <div class="mt-2 text-sm font-semibold text-gray-500">${esc(err.message || err)}</div>
        </div>`;
      }
    }

    async function init(){
      try{
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

        if(!liff.isLoggedIn()){
          const cleanUrl = location.origin + location.pathname + location.search;
          liff.login({ redirectUri: cleanUrl });
          return;
        }

        lineUser = await liff.getProfile();
        document.getElementById('line-avatar').src = lineUser.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
        document.getElementById('line-name').innerText = lineUser.displayName || 'LINE 使用者';
        document.getElementById('line-badge').classList.remove('hidden');

        setActiveTab(currentSheet);
        await loadCourses(currentSheet,false);
      }catch(err){
        console.error(err);
      }finally{
        document.getElementById('loading').style.display = 'none';
      }
    }

    init();
  </script>
</body>
</html>
