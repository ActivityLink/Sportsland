/**
 * ActivityLink 後端處理程式 (GAS)
 * 支援完整 40 欄位映射
 * 工作表名稱：SingleCourses
 */

const SPREADSHEET_ID = '16NKFioe-lrYmpFv20tYEg6p6uo9_D4wSsS2YoiUWKko';
const COURSE_SHEET = 'SingleCourses';
const SETUP_SHEET = 'setup';
const BOOKING_SHEET = 'Bookings';

/**
 * 完整 40 欄位索引映射表 (0-39)
 * 依照您提供的順序精確排列
 */
const FIELD_MAP = [
  "courseId",        // 0: 課程ID
  "courseName",      // 1: 課程名稱
  "category",        // 2: 運動類別
  "ageGroup",        // 3: 年齡分級
  "difficulty",      // 4: 難度等級
  "tags",            // 5: 標籤分類
  "regStart",        // 6: 開放報名日
  "regEnd",          // 7: 截止報名日
  "courseDate",      // 8: 課程日期
  "startTime",       // 9: 開始時間
  "endTime",         // 10: 結束時間
  "duration",        // 11: 課程時長(分鐘)
  "coachId",         // 12: 教練ID
  "coachName",       // 13: 教練姓名
  "venueId",         // 14: 場地ID
  "venueName",       // 15: 場地名稱
  "venueArea",       // 16: 場地區域
  "price",           // 17: 原價
  "earlyBirdPrice",  // 18: 早鳥價
  "earlyBirdEnd",    // 19: 早鳥截止
  "memberPrice",     // 20: 會員價
  "friendPrice",     // 21: 親友價
  "quota",           // 22: 總名額
  "minClass",        // 23: 最少開班
  "enrolled",        // 24: 已報名人數
  "remaining",       // 25: 剩餘名額
  "waiting",         // 26: 候補名額
  "genderLimit",     // 27: 性別限制
  "specialRequest",  // 28: 特殊要求
  "coverImage",      // 29: 封面圖片
  "detailImage",     // 30: 詳細圖片
  "highlights",      // 31: 課程亮點
  "content",         // 32: 課程內容
  "notes",           // 33: 注意事項
  "targetAudience",  // 34: 適合對象
  "status",          // 35: 課程狀態
  "weight",          // 36: 排序權重
  "createdAt",       // 37: 建立時間
  "updatedAt",       // 38: 更新時間
  "selectedEquipment"// 39: 租用設備
];

/**
 * 處理 GET 請求
 */
function doGet(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const type = e.parameter.type;
    
    // A. 讀取系統設定 (JSON)
    if (type === 'config') {
      const sheet = ss.getSheetByName(SETUP_SHEET);
      if (!sheet) return createRes({ status: "success", config: [] });
      const data = sheet.getDataRange().getValues().slice(1);
      return createRes({ status: "success", config: data.map(r => ({ type: r[0], name: r[1], options: r[2] })) });
    }

    // B. 讀取課程資料
    const sheet = ss.getSheetByName(COURSE_SHEET);
    if (!sheet) {
      return createRes({ status: "error", message: "找不到名為 '" + COURSE_SHEET + "' 的工作表，請檢查名稱是否完全一致（含空格）。" });
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      return createRes({ status: "success", data: [] }); // 只有標題列或完全空白
    }

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const output = data.slice(1).map(row => {
      let obj = {};
      // 使用 FIELD_MAP 作為 Key 輸出，確保前端能預期欄位名稱
      FIELD_MAP.forEach((key, i) => {
        let val = row[i];
        if (val === undefined) val = "";
        
        // 處理日期與時間物件轉為字串
        if (val instanceof Date) {
          if (val.getFullYear() < 1900) {
            // 這是 Google Sheets 的純時間格式 (1899年)
            val = Utilities.formatDate(val, "GMT+8", "HH:mm");
          } else {
            // 一般日期
            val = val.toISOString();
          }
        }
        obj[key] = val;
      });
      return obj;
    });
    
    return createRes({ status: "success", data: output });
    
  } catch (err) {
    return createRes({ status: "error", message: "GAS 執行發生異常: " + err.toString() });
  }
}

/**
 * 處理 POST 請求
 */
function doPost(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const payload = JSON.parse(e.postData.contents);

    // 1. 系統設定更新
    if (payload.type === 'config_update') {
      let sheet = ss.getSheetByName(SETUP_SHEET) || ss.insertSheet(SETUP_SHEET);
      sheet.clear();
      sheet.appendRow(["type", "name", "options"]);
      payload.data.forEach(item => {
        sheet.appendRow([item.type, item.name, item.options]);
      });
      return createRes({ status: "success" });
    }

    // 2. 預約提交
    if (payload.type === 'booking_submit') {
      let sheet = ss.getSheetByName(BOOKING_SHEET) || ss.insertSheet(BOOKING_SHEET);
      if (sheet.getLastRow() === 0) {
        sheet.appendRow(["提交時間", "課程ID", "課程名稱", "姓名", "電話", "租借設備", "總額"]);
      }
      sheet.appendRow([new Date(), payload.courseId, payload.courseName, payload.name, payload.phone, payload.equipment, payload.total]);
      return createRes({ status: "success" });
    }

    // 3. 課程刪除
    if (payload.type === 'course_delete') {
      const sheet = ss.getSheetByName(COURSE_SHEET);
      if (!sheet) return createRes({ status: "error", message: "找不到工作表" });
      const data = sheet.getDataRange().getValues();
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] == payload.courseId) { // 使用 == 避免字串/數字對比問題
          sheet.deleteRow(i + 1);
          return createRes({ status: "success" });
        }
      }
      return createRes({ status: "error", message: "找不到 ID: " + payload.courseId });
    }

    // 4. 課程新增或編輯 (確保 40 欄位完整)
    const sheet = ss.getSheetByName(COURSE_SHEET) || ss.insertSheet(COURSE_SHEET);
    const data = sheet.getDataRange().getValues();
    let rowIdx = -1;
    let rowValues = [];

    // 搜尋是否為編輯模式 (以課程ID為準)
    if (payload.courseId) {
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] == payload.courseId) {
          rowIdx = i + 1;
          rowValues = [...data[i]]; // 複製現有資料，保留沒被 payload 覆蓋的內容
          break;
        }
      }
    }

    // 初始化 40 個欄位的陣列
    if (rowValues.length < 40) {
      let padding = new Array(40 - rowValues.length).fill("");
      rowValues = rowValues.concat(padding);
    }

    // 如果是新增模式或找不到 ID
    if (rowIdx === -1) {
      payload.courseId = payload.courseId || ("SC-" + new Date().getTime());
      rowValues[0] = payload.courseId;
      rowValues[37] = new Date(); // 建立時間 (Index 37)
    }

    // 更新時間 (Index 38)
    rowValues[38] = new Date();

    // 根據 FIELD_MAP 自動將 Payload 資料映射到對應索引
    FIELD_MAP.forEach((key, index) => {
      // 建立與更新時間已手動處理
      if (index === 37 || index === 38) return;
      
      if (payload[key] !== undefined) {
        rowValues[index] = payload[key];
      }
    });

    // 寫回試算表
    if (rowIdx > 0) {
      sheet.getRange(rowIdx, 1, 1, 40).setValues([rowValues]);
    } else {
      sheet.appendRow(rowValues);
    }

    return createRes({ status: "success", courseId: payload.courseId });

  } catch (err) {
    return createRes({ status: "error", message: "POST 執行異常: " + err.toString() });
  }
}

/**
 * 輔助回傳 JSON 格式
 */
function createRes(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
